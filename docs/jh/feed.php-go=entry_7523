<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0">
<channel>
<title><![CDATA[流浪的龙－个人知识管理]]></title> 
<link>http://i.renjihe.com/blog/index.php</link> 
<description><![CDATA[]]></description> 
<language>zh-cn</language> 
<copyright><![CDATA[流浪的龙－个人知识管理]]></copyright>
<item>
<link>http://i.renjihe.com/blog/read.php?</link>
<title><![CDATA[如何实现按距离排序、范围查找]]></title> 
<author>renjihe1988 &lt;admin@yourname.com&gt;</author>
<category><![CDATA[web]]></category>
<pubDate>Thu, 01 Sep 2016 12:53:46 +0000</pubDate> 
<guid>http://i.renjihe.com/blog/read.php?</guid> 
<description>
<![CDATA[ 
	<h1 style="margin: 0.8em 0px; padding: 0px; box-sizing: border-box; font-weight: 100; color: #333333; font-family: 'microsoft yahei'; line-height: 26px">简介</h1><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">现在几乎所有的O2O应用中都会存在&ldquo;按范围搜素、离我最近、显示距离&rdquo;等等基于位置的交互，那这样的功能是怎么实现的呢？本文提供的实现方式，适用于所有数据库。</p><h1 style="margin: 0.8em 0px; padding: 0px; box-sizing: border-box; font-weight: 100; color: #333333; font-family: 'microsoft yahei'; line-height: 26px"><a style="color: #336699; box-sizing: border-box" name="t1"></a>实现</h1><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">为了方便下面说明，先给出一个初始表结构，我使用的是<a style="color: #df3434; text-decoration: none; box-sizing: border-box; font-weight: bold" href="http://lib.csdn.net/base/14" target="_blank" title="undefined" class="replace_word">MySQL</a>：</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)"><span style="box-sizing: border-box" class="hljs-operator"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">CREATE</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">TABLE</span> <span style="box-sizing: border-box; color: #008800" class="hljs-string">`customer`</span> (&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #008800" class="hljs-string">`id`</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">INT</span>(<span style="box-sizing: border-box; color: #006666" class="hljs-number">11</span>) UNSIGNED <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NOT</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span style="box-sizing: border-box; color: #008800" class="hljs-string">'自增主键'</span>,&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #008800" class="hljs-string">`name`</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">VARCHAR</span>(<span style="box-sizing: border-box; color: #006666" class="hljs-number">5</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NOT</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NULL</span> COMMENT <span style="box-sizing: border-box; color: #008800" class="hljs-string">'名称'</span>,&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #008800" class="hljs-string">`lon`</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">DOUBLE</span>(<span style="box-sizing: border-box; color: #006666" class="hljs-number">9</span>,<span style="box-sizing: border-box; color: #006666" class="hljs-number">6</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NOT</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NULL</span> COMMENT <span style="box-sizing: border-box; color: #008800" class="hljs-string">'经度'</span>,&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #008800" class="hljs-string">`lat`</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">DOUBLE</span>(<span style="box-sizing: border-box; color: #006666" class="hljs-number">8</span>,<span style="box-sizing: border-box; color: #006666" class="hljs-number">6</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NOT</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NULL</span> COMMENT <span style="box-sizing: border-box; color: #008800" class="hljs-string">'纬度'</span>,&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">PRIMARY</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">KEY</span> (<span style="box-sizing: border-box; color: #008800" class="hljs-string">`id`</span>) ) COMMENT=<span style="box-sizing: border-box; color: #008800" class="hljs-string">'商户表'</span> CHARSET=utf8mb4 ENGINE=InnoDB ;</span><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li><li style="box-sizing: border-box; padding: 0px 5px">11</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li><li style="box-sizing: border-box; padding: 0px 5px">11</li></ul></pre><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">实现过程主要分为四步：&nbsp;<br />1. 搜索&nbsp;<br />在数据库中搜索出接近指定范围内的商户，如：搜索出1公里范围内的。&nbsp;<br />2. 过滤&nbsp;<br />搜索出来的结果可能会存在超过1公里的，需要再次过滤。如果对精度没有严格要求，可以跳过。&nbsp;<br />3. 排序&nbsp;<br />距离由近到远排序。如果不需要，可以跳过。&nbsp;<br />4. 分页&nbsp;<br />如果需要2、3步，才需要对分页特殊处理。如果不需要，可以在第1步直接SQL分页。</p><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">第1步数据库完成，后3步应用程序完成。</p><h2 style="margin: 0.8em 0px; padding: 0px; box-sizing: border-box; font-weight: 100; color: #333333; font-family: 'microsoft yahei'; line-height: 26px"><a style="color: #336699; box-sizing: border-box" name="t2"></a>step1 搜索</h2><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">搜索可以用下面两种方式来实现。</p><h3 style="margin: 0.8em 0px; padding: 0px; box-sizing: border-box; font-weight: 100; color: #333333; font-family: 'microsoft yahei'; line-height: 26px"><a style="color: #336699; box-sizing: border-box" name="t3"></a>区间查找</h3><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">customer表中使用两个字段存储了经度和纬度，如果提前计算出经纬度的范围，然后在这两个字段上加上索引，那搜索性能会很不错。&nbsp;<br />那怎么计算出经纬度的范围呢？已知条件是移动设备所在的经纬度，还有满足业务要求的半径，这很像初中的一道平面几何题：给定圆心坐标和半径，求该圆外切正方形四个顶点的坐标。而我们面对的是一个球体，可以使用<a style="color: #336699; text-decoration: none; box-sizing: border-box" href="https://github.com/locationtech/spatial4j">spatial4j</a>来计算。</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)"><span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;<span style="box-sizing: border-box; color: #000088" class="hljs-title">dependency</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;<span style="box-sizing: border-box; color: #000088" class="hljs-title">groupId</span>&gt;</span>com.spatial4j<span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;/<span style="box-sizing: border-box; color: #000088" class="hljs-title">groupId</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;<span style="box-sizing: border-box; color: #000088" class="hljs-title">artifactId</span>&gt;</span>spatial4j<span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;/<span style="box-sizing: border-box; color: #000088" class="hljs-title">artifactId</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;<span style="box-sizing: border-box; color: #000088" class="hljs-title">version</span>&gt;</span>0.5<span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;/<span style="box-sizing: border-box; color: #000088" class="hljs-title">version</span>&gt;</span> <span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;/<span style="box-sizing: border-box; color: #000088" class="hljs-title">dependency</span>&gt;</span><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li></ul></pre><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)">// 移动设备经纬度 double lon = <span style="box-sizing: border-box; color: #006666" class="hljs-number">116.312528</span>, lat = <span style="box-sizing: border-box; color: #006666" class="hljs-number">39.983733</span><span style="box-sizing: border-box; color: #880000" class="hljs-comment">;</span> // 千米 int radius = <span style="box-sizing: border-box; color: #006666" class="hljs-number">1</span><span style="box-sizing: border-box; color: #880000" class="hljs-comment">;</span>&nbsp;&nbsp;SpatialContext geo = SpatialContext<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.GEO</span><span style="box-sizing: border-box; color: #880000" class="hljs-comment">;</span> Rectangle rectangle = geo<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.getDistCalc</span>()<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.calcBoxByDistFromPt</span>(&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; geo<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.makePoint</span>(lon, lat), radius * DistanceUtils<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.KM</span>_TO_DEG, geo, null)<span style="box-sizing: border-box; color: #880000" class="hljs-comment">;</span> System<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.out</span><span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.println</span>(rectangle<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.getMinX</span>() + <span style="box-sizing: border-box; color: #008800" class="hljs-string">&quot;-&quot;</span> + rectangle<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.getMaxX</span>())<span style="box-sizing: border-box; color: #880000" class="hljs-comment">;// 经度范围</span> System<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.out</span><span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.println</span>(rectangle<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.getMinY</span>() + <span style="box-sizing: border-box; color: #008800" class="hljs-string">&quot;-&quot;</span> + rectangle<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.getMaxY</span>())<span style="box-sizing: border-box; color: #880000" class="hljs-comment">;// 纬度范围</span><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li></ul></pre><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">计算出经纬度范围之后，SQL是这样：</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)"><span style="box-sizing: border-box" class="hljs-operator"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">SELECT</span> id, name <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">FROM</span> customer <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">WHERE</span> (lon BETWEEN ? <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">AND</span> ?) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">AND</span> (lat BETWEEN ? <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">AND</span> ?);</span><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li></ul></pre><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">需要给lon、lat两个字段建立联合索引：</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)">INDEX <span style="box-sizing: border-box" class="hljs-escape">`i</span>dx_lon_lat<span style="box-sizing: border-box" class="hljs-escape">` </span>(<span style="box-sizing: border-box" class="hljs-escape">`l</span>on<span style="box-sizing: border-box" class="hljs-escape">`,</span> <span style="box-sizing: border-box" class="hljs-escape">`l</span>at<span style="box-sizing: border-box" class="hljs-escape">`)</span><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li></ul></pre><h3 style="margin: 0.8em 0px; padding: 0px; box-sizing: border-box; font-weight: 100; color: #333333; font-family: 'microsoft yahei'; line-height: 26px"><a style="color: #336699; box-sizing: border-box" name="t4"></a>geohash</h3><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">geohash的原理不讲了，详细可以看<a style="color: #336699; text-decoration: none; box-sizing: border-box" href="http://www.cnblogs.com/LBSer/p/3310455.html">这篇文章</a>，讲的很详细。geohash算法能把二维的经纬度编码成一维的字符串，它的特点是越相近的经纬度编码后越相似，所以可以通过前缀like的方式去匹配周围的商户。&nbsp;<br />customer表要增加一个字段，来存储每个商户的geohash编码，并且建立索引。</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)"><span style="box-sizing: border-box" class="hljs-operator"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">CREATE</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">TABLE</span> <span style="box-sizing: border-box; color: #008800" class="hljs-string">`customer`</span> (&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #008800" class="hljs-string">`id`</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">INT</span>(<span style="box-sizing: border-box; color: #006666" class="hljs-number">11</span>) UNSIGNED <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NOT</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span style="box-sizing: border-box; color: #008800" class="hljs-string">'自增主键'</span>,&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #008800" class="hljs-string">`name`</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">VARCHAR</span>(<span style="box-sizing: border-box; color: #006666" class="hljs-number">5</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NOT</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NULL</span> COMMENT <span style="box-sizing: border-box; color: #008800" class="hljs-string">'名称'</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">COLLATE</span> <span style="box-sizing: border-box; color: #008800" class="hljs-string">'latin1_swedish_ci'</span>,&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #008800" class="hljs-string">`lon`</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">DOUBLE</span>(<span style="box-sizing: border-box; color: #006666" class="hljs-number">9</span>,<span style="box-sizing: border-box; color: #006666" class="hljs-number">6</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NOT</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NULL</span> COMMENT <span style="box-sizing: border-box; color: #008800" class="hljs-string">'经度'</span>,&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #008800" class="hljs-string">`lat`</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">DOUBLE</span>(<span style="box-sizing: border-box; color: #006666" class="hljs-number">8</span>,<span style="box-sizing: border-box; color: #006666" class="hljs-number">6</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NOT</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NULL</span> COMMENT <span style="box-sizing: border-box; color: #008800" class="hljs-string">'纬度'</span>,&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #008800" class="hljs-string">`geo_code`</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">CHAR</span>(<span style="box-sizing: border-box; color: #006666" class="hljs-number">12</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NOT</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NULL</span> COMMENT <span style="box-sizing: border-box; color: #008800" class="hljs-string">'geohash编码'</span>,&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">PRIMARY</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">KEY</span> (<span style="box-sizing: border-box; color: #008800" class="hljs-string">`id`</span>),&nbsp;&nbsp;&nbsp;&nbsp; INDEX <span style="box-sizing: border-box; color: #008800" class="hljs-string">`idx_geo_code`</span> (<span style="box-sizing: border-box; color: #008800" class="hljs-string">`geo_code`</span>) ) COMMENT=<span style="box-sizing: border-box; color: #008800" class="hljs-string">'商户表'</span> CHARSET=utf8mb4 ENGINE=InnoDB ;</span><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li><li style="box-sizing: border-box; padding: 0px 5px">11</li><li style="box-sizing: border-box; padding: 0px 5px">12</li><li style="box-sizing: border-box; padding: 0px 5px">13</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li><li style="box-sizing: border-box; padding: 0px 5px">11</li><li style="box-sizing: border-box; padding: 0px 5px">12</li><li style="box-sizing: border-box; padding: 0px 5px">13</li></ul></pre><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">在新增或修改一个商户的时候，维护好geo_code，那geo_code怎么计算呢？<a style="color: #336699; text-decoration: none; box-sizing: border-box" href="https://github.com/locationtech/spatial4j">spatial4j</a>也提供了一个工具类GeohashUtils.encodeLatLon(lat, lon)，默认精度是12位。这个存储做好后，就可以通过geo_code去搜索了。拿到移动设备的经纬度，计算geo_code，这时可以指定精度计算，那指定多长呢？我们需要一个geo_code长度和距离的对照表：</p><table border="0" style="box-sizing: border-box; width: 708px; border-collapse: collapse; border-spacing: 0px; border: 1px solid #eeeeee; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px"><thead><tr style="box-sizing: border-box"><th style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">geohash length</th><th style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">width</th><th style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">height</th></tr></thead><tbody><tr style="box-sizing: border-box"><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">1</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">5,009.4km</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">4,992.6km</td></tr><tr style="box-sizing: border-box"><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">2</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">1,252.3km</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">624.1km</td></tr><tr style="box-sizing: border-box"><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">3</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">156.5km</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">156km</td></tr><tr style="box-sizing: border-box"><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">4</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">39.1km</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">19.5km</td></tr><tr style="box-sizing: border-box"><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">5</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">4.9km</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">4.9km</td></tr><tr style="box-sizing: border-box"><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">6</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">1.2km</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">609.4m</td></tr><tr style="box-sizing: border-box"><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">7</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">152.9m</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">152.4m</td></tr><tr style="box-sizing: border-box"><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">8</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">38.2m</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">19m</td></tr><tr style="box-sizing: border-box"><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">9</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">4.8m</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">4.8m</td></tr><tr style="box-sizing: border-box"><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">10</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">1.2m</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">59.5cm</td></tr><tr style="box-sizing: border-box"><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">11</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">14.9cm</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">14.9cm</td></tr><tr style="box-sizing: border-box"><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">12</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">3.7cm</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">1.9cm</td></tr></tbody></table><blockquote style="box-sizing: border-box; margin: 0px 0px 1.1em; padding: 15px 20px; border-left-width: 10px; border-left-style: solid; border-left-color: rgba(128, 128, 128, 0.0745098); border-radius: 0px 5px 5px 0px; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px; background-color: rgba(128, 128, 128, 0.0470588)"><p style="box-sizing: border-box; margin: 0px; line-height: 1.25"><a style="color: #336699; text-decoration: none; box-sizing: border-box" href="https://en.wikipedia.org/wiki/Geohash#Cell_Dimensions">https://en.wikipedia.org/wiki/Geohash#Cell_Dimensions</a></p></blockquote><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">假设我们的需求是1公里范围内的商户，geo_code的长度设置为5就可以了，GeohashUtils.encodeLatLon(lat, lon, 5)。计算出移动设备经纬度的geo_code之后，SQL是这样：</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)"><span style="box-sizing: border-box" class="hljs-operator"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">SELECT</span> id, name <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">FROM</span> customer <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">WHERE</span> geo_code <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">LIKE</span> CONCAT(?, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'%'</span>);</span><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li></ul></pre><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">这样会比区间查找快很多，并且得益于geo_code的相似性，可以对热点区域做缓存。但这样使用geohash还存在一个问题，geohash最终是在地图上铺上了一个网格，每一个网格代表一个geohash值，当传入的坐标接近当前网格的边界时，用上面的搜索方式就会丢失它附近的数据。比如下图中，在绿点的位置搜索不到白家大院，绿点和白家大院在划分的时候就分到了两个格子中。&nbsp;<br /><img style="border: none; box-sizing: border-box; max-width: 100%" src="http://img.blog.csdn.net/20160715101657127" border="0" alt="这里写图片描述" />&nbsp;<br />解决这个问题思路也比较简单，我们查询时，除了使用绿点的geohash编码进行匹配外，还使用周围8个网格的geohash编码，这样可以避免这个问题。那怎么计算出周围8个网格的geohash呢，可以使用<a style="color: #336699; text-decoration: none; box-sizing: border-box" href="https://github.com/kungfoo/geohash-java">geohash-java</a>来解决。</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)"><span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;<span style="box-sizing: border-box; color: #000088" class="hljs-title">dependency</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;<span style="box-sizing: border-box; color: #000088" class="hljs-title">groupId</span>&gt;</span>ch.hsr<span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;/<span style="box-sizing: border-box; color: #000088" class="hljs-title">groupId</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;<span style="box-sizing: border-box; color: #000088" class="hljs-title">artifactId</span>&gt;</span>geohash<span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;/<span style="box-sizing: border-box; color: #000088" class="hljs-title">artifactId</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;<span style="box-sizing: border-box; color: #000088" class="hljs-title">version</span>&gt;</span>1.3.0<span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;/<span style="box-sizing: border-box; color: #000088" class="hljs-title">version</span>&gt;</span> <span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;/<span style="box-sizing: border-box; color: #000088" class="hljs-title">dependency</span>&gt;</span><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li></ul></pre><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)">// 移动设备经纬度 double lon = <span style="box-sizing: border-box; color: #006666" class="hljs-number">116.312528</span>, lat = <span style="box-sizing: border-box; color: #006666" class="hljs-number">39.983733</span><span style="box-sizing: border-box; color: #880000" class="hljs-comment">;</span> GeoHash geoHash = GeoHash<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.withCharacterPrecision</span>(lat, lon, <span style="box-sizing: border-box; color: #006666" class="hljs-number">10</span>)<span style="box-sizing: border-box; color: #880000" class="hljs-comment">;</span> // 当前 System<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.out</span><span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.println</span>(geoHash<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.toBase</span>32())<span style="box-sizing: border-box; color: #880000" class="hljs-comment">;</span> // N, NE, E, SE, S, SW, W, NW GeoHash[] adjacent = geoHash<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.getAdjacent</span>()<span style="box-sizing: border-box; color: #880000" class="hljs-comment">;</span> for (GeoHash hash : adjacent) &#123;&nbsp;&nbsp;&nbsp;&nbsp; System<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.out</span><span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.println</span>(hash<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.toBase</span>32())<span style="box-sizing: border-box; color: #880000" class="hljs-comment">;</span> &#125;<ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li></ul></pre><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">最终我们的sql变成了这样：</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)"><span style="box-sizing: border-box" class="hljs-operator"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">SELECT</span> id, name <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">FROM</span> customer <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">WHERE</span> geo_code <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">LIKE</span> CONCAT(?, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'%'</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">OR</span> geo_code <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">LIKE</span> CONCAT(?, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'%'</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">OR</span> geo_code <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">LIKE</span> CONCAT(?, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'%'</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">OR</span> geo_code <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">LIKE</span> CONCAT(?, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'%'</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">OR</span> geo_code <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">LIKE</span> CONCAT(?, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'%'</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">OR</span> geo_code <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">LIKE</span> CONCAT(?, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'%'</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">OR</span> geo_code <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">LIKE</span> CONCAT(?, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'%'</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">OR</span> geo_code <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">LIKE</span> CONCAT(?, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'%'</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">OR</span> geo_code <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">LIKE</span> CONCAT(?, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'%'</span>);</span><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li><li style="box-sizing: border-box; padding: 0px 5px">11</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li><li style="box-sizing: border-box; padding: 0px 5px">11</li></ul></pre><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">原来的1次查询变成了9次查询，性能肯定会下降，这里可以优化下。还用上面的需求场景，搜索1公里范围内的商户，从上面的表格知道，geo_code长度为5时，网格宽高是4.9KM，用9个geo_code查询时，范围太大了，所以可以将geo_code长度设置为6，即缩小了查询范围，也满足了需求。还可以继续优化，在存储geo_code时，只计算到6位，这样就可以将sql变成这样：</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)"><span style="box-sizing: border-box" class="hljs-operator"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">SELECT</span> id, name <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">FROM</span> customer <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">WHERE</span> geo_code <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">IN</span> (?, ?, ?, ?, ?, ?, ?, ?, ?);</span><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li></ul></pre><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">这样将前缀匹配换成了直接匹配，速度会提升很多。</p><h2 style="margin: 0.8em 0px; padding: 0px; box-sizing: border-box; font-weight: 100; color: #333333; font-family: 'microsoft yahei'; line-height: 26px"><a style="color: #336699; box-sizing: border-box" name="t5"></a>step2 过滤</h2><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">上面两种搜索方式，都不是精确搜索，只是尽量缩小搜索范围，提升响应速度。所以需要在应用程序中做过滤，把距离大于1公里的商户过滤掉。计算距离同样使用<a style="color: #336699; text-decoration: none; box-sizing: border-box" href="https://github.com/locationtech/spatial4j">spatial4j</a>。</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)"><span style="box-sizing: border-box; color: #880000" class="hljs-comment">// 移动设备经纬度</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">double</span> lon1 = <span style="box-sizing: border-box; color: #006666" class="hljs-number">116.3125333347639</span>, lat1 = <span style="box-sizing: border-box; color: #006666" class="hljs-number">39.98355521792821</span>; <span style="box-sizing: border-box; color: #880000" class="hljs-comment">// 商户经纬度</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">double</span> lon2 = <span style="box-sizing: border-box; color: #006666" class="hljs-number">116.312528</span>, lat2 = <span style="box-sizing: border-box; color: #006666" class="hljs-number">39.983733</span>;&nbsp;&nbsp;SpatialContext geo = SpatialContext.GEO; <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">double</span> <span style="box-sizing: border-box; color: #660066" class="hljs-built_in">distance</span> = geo.calcDistance(geo.makePoint(lon1, lat1), geo.makePoint(lon2, lat2))&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* DistanceUtils.DEG_TO_KM; System.<span style="box-sizing: border-box; color: #000088" class="hljs-keyword">out</span>.println(<span style="box-sizing: border-box; color: #660066" class="hljs-built_in">distance</span>);<span style="box-sizing: border-box; color: #880000" class="hljs-comment">// KM</span><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li></ul></pre><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">过滤代码就不写了，遍历一遍搜索结果即可。</p><h2 style="margin: 0.8em 0px; padding: 0px; box-sizing: border-box; font-weight: 100; color: #333333; font-family: 'microsoft yahei'; line-height: 26px"><a style="color: #336699; box-sizing: border-box" name="t6"></a>step3 排序</h2><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">同样，排序也需要在应用程序中处理。排序基于上面的过滤结果做就可以了Collections.sort(list, comparator)。</p><h2 style="margin: 0.8em 0px; padding: 0px; box-sizing: border-box; font-weight: 100; color: #333333; font-family: 'microsoft yahei'; line-height: 26px"><a style="color: #336699; box-sizing: border-box" name="t7"></a>step4 分页</h2><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">如果需要2、3步，只能在内存中分页，做法也很简单，可以参考<a style="color: #336699; text-decoration: none; box-sizing: border-box" href="http://blog.csdn.net/ghsau/article/details/7243540">这篇文章</a>。</p><h1 style="margin: 0.8em 0px; padding: 0px; box-sizing: border-box; font-weight: 100; color: #333333; font-family: 'microsoft yahei'; line-height: 26px"><a style="color: #336699; box-sizing: border-box" name="t8"></a>总结</h1><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">全文的重点都在于搜索如何实现，更好的利用数据库的索引，两种搜索方式以百万数据量为分割线，第一种适用于百万以下，第二种适用于百万以上，未经过严格验证。可能有人会有疑问，过滤和排序都在应用层做，内存占用会不会很严重？这是个潜在问题，但大多数情况下不会。看我们大部分的应用场景，都是单一种类POI(Point Of Interest)的搜索，如酒店、美食、KTV、电影院等等，这种数据密度是很小，1公里内的酒店，能有多少家，50家都算多的，所以最终要看具体业务数据密度。本文没有分析原理，只讲了具体实现，有关分析的文章可以看参考链接。</p><hr style="box-sizing: border-box; margin: 2em 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-top-style: solid; border-top-color: rgba(128, 128, 128, 0.0980392); color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px" /><h1 style="margin: 0.8em 0px; padding: 0px; box-sizing: border-box; font-weight: 100; color: #333333; font-family: 'microsoft yahei'; line-height: 26px"><a style="color: #336699; box-sizing: border-box" name="t9"></a>参考</h1><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px"><a style="color: #336699; text-decoration: none; box-sizing: border-box" href="http://www.infoq.com/cn/articles/depth-study-of-Symfony2">http://www.infoq.com/cn/articles/depth-study-of-Symfony2</a>&nbsp;<br /><a style="color: #336699; text-decoration: none; box-sizing: border-box" href="http://tech.meituan.com/lucene-distance.html">http://tech.meituan.com/lucene-distance.html</a>&nbsp;<br /><a style="color: #336699; text-decoration: none; box-sizing: border-box" href="http://blog.csdn.net/liminlu0314/article/details/8553926">http://blog.csdn.net/liminlu0314/article/details/8553926</a>&nbsp;<br /><a style="color: #336699; text-decoration: none; box-sizing: border-box" href="http://janmatuschek.de/LatitudeLongitudeBoundingCoordinates">http://janmatuschek.de/LatitudeLongitudeBoundingCoordinates</a>&nbsp;<br /><a style="color: #336699; text-decoration: none; box-sizing: border-box" href="http://www.cnblogs.com/LBSer/p/3310455.html">http://www.cnblogs.com/LBSer/p/3310455.html</a>&nbsp;<br /><a style="color: #336699; text-decoration: none; box-sizing: border-box" href="http://cevin.net/geohash/">http://cevin.net/geohash/</a></p><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">本文来自：<a style="color: #336699; text-decoration: none; box-sizing: border-box" href="http://blog.csdn.net/ghsau">高爽&#124;Coder</a>，原文地址：<a style="color: #336699; text-decoration: none; box-sizing: border-box" href="http://blog.csdn.net/ghsau/article/details/50591932">http://blog.csdn.net/ghsau/article/details/50591932</a>，转载请注明。</p>
]]>
</description>
</item><item>
<link>http://i.renjihe.com/blog/read.php?#blogcomment</link>
<title><![CDATA[[评论] 如何实现按距离排序、范围查找]]></title> 
<author> &lt;user@domain.com&gt;</author>
<category><![CDATA[评论]]></category>
<pubDate>Thu, 01 Jan 1970 00:00:00 +0000</pubDate> 
<guid>http://i.renjihe.com/blog/read.php?#blogcomment</guid> 
<description>
<![CDATA[ 
	
]]>
</description>
</item>
</channel>
</rss>