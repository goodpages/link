<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0">
<channel>
<title><![CDATA[流浪的龙－个人知识管理]]></title> 
<link>http://i.renjihe.com/blog/index.php</link> 
<description><![CDATA[]]></description> 
<language>zh-cn</language> 
<copyright><![CDATA[流浪的龙－个人知识管理]]></copyright>
<item>
<link>http://i.renjihe.com/blog/read.php?7527</link>
<title><![CDATA[mysql优化之索引优化]]></title> 
<author>renjihe1988 &lt;admin@yourname.com&gt;</author>
<category><![CDATA[web]]></category>
<pubDate>Thu, 01 Sep 2016 12:56:02 +0000</pubDate> 
<guid>http://i.renjihe.com/blog/read.php?7527</guid> 
<description>
<![CDATA[ 
	<p style="margin: 10px auto; padding: 0px; font-size: 14px; line-height: 21px"><a style="margin: 0px; padding: 0px; color: black" href="http://ddbiz.com/?p=931" title="mysql优化系列">第一篇 序章</a><br /><a style="margin: 0px; padding: 0px; color: black" href="http://ddbiz.com/?p=950" title="mysql优化之连接优化">第二篇 连接优化</a><br />第三篇 索引优化<br /><a style="margin: 0px; padding: 0px; color: black" href="http://ddbiz.com/?p=990" title="mysql优化之查询优化">第四篇 查询优化</a><br /><a style="margin: 0px; padding: 0px; color: black" href="http://ddbiz.com/?p=784" title="mysql优化之从实践中来，到实战中去">第五篇 到实战中去</a></p><h1 style="margin: 0px; padding: 0px; font-size: 28px">索引优化</h1><p style="margin: 10px auto; padding: 0px; font-size: 14px; line-height: 21px">索引优化涉及到几个方面，包括了索引的类型、如何让查询使用索引，查询是索引算法的选择等等操作。<a style="margin: 0px; padding: 0px; color: black" href="http://ddbiz.com/?p=961"><span style="margin: 0px; padding: 0px" class="copyme">(原文链接http://ddbiz.com/?p=961)</span></a><br />涉及到数据库的查询时，大多数情况都是要建立索引的，MySQL的索引类型以及创建索引方式，可以参考其<a style="margin: 0px; padding: 0px; color: black" href="http://ddbiz.com/doclib/mysql/cn51/optimization.html#indexes" target="_blank">文档</a>或者<a style="margin: 0px; padding: 0px; color: black" href="http://dev.mysql.com/doc/refman/5.6/en/optimization-indexes.html" target="_blank">这里</a>。</p><ol style="margin: 0px; padding: 0px 0px 0px 40px; font-size: 14px; line-height: 21px"><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal"><h1 style="margin: 0px; padding: 0px; font-size: 28px"><a style="margin: 0px; padding: 0px" name="server-options"></a>服务器参数设置</h1><p style="margin: 10px auto; padding: 0px">在于索引有关系的数据库参数中，有一些特别重要，如下：</p><ol style="margin: 0px; padding: 0px 0px 0px 40px"><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal"><h2 style="margin: 15px auto 2px; padding: 0px; font-size: 21px"><a style="margin: 0px; padding: 0px" name="key_buffer_size"></a>key_buffer_size</h2><p style="margin: 10px auto; padding: 0px">命令行参数: &ndash;key_buffer_size=#<br />ini/cnf参数: key_buffer_size<br />mysql 变量: key_buffer_size<br />全局变量，可动态调整，取值范围 8到4G(32bitOS), 在64bitOS上可以设置更高，只要你的系统有那么多物理内存。</p><p style="margin: 10px auto; padding: 0px">key_buffer_size 主要作用于MyISAM表的索引。我们知道，MyISAM的索引句柄是对全部连接用户共享的。状态参数 key_read_requests(响应用户请求时从缓存中获取的数据)和key_reads(响应用户请求时从文件中加载的数据) 可以用来检测key_buffer_size是否太小，根据<a style="margin: 0px; padding: 0px; color: black" href="http://ddbiz.com/doclib/mysql/en55/server-administration.html#statvar_Key_read_requests" target="_blank">文档</a>, key_reads/key_read_request 应该远小于0.01(当然我们的测试环境可能完全无法达到此设定，只能尽量接近了). 如果一个MyISAM的数据表的索引文件过G，除非物理内存远远高于索引大小，否则让key_reads/key_read_request接近0.01也是一件不可能的任务。</p><p style="margin: 10px auto; padding: 0px">MySQL还支持把索引提前加载到内存，本节后面将<a style="margin: 0px; padding: 0px; color: black" href="http://ddbiz.com/blog/mysql/mysql%e4%bc%98%e5%8c%96%e4%b9%8b%e7%b4%a2%e5%bc%95%e4%bc%98%e5%8c%96/961#load-index-into-cache">描述此方法及其限制</a>.</p><blockquote style="margin: 10px 0px; padding: 5px 10px; border: 2px solid #efefef; line-height: 1.6; color: #333333; background: none"><p style="margin: 10px auto; padding: 0px">受如下参数影响: 系统内存<br />将影响如下参数: 无<br />调整触发条件: key_reads/key_read_request &gt;0.01</p></blockquote></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal"><h2 style="margin: 15px auto 2px; padding: 0px; font-size: 21px"><a style="margin: 0px; padding: 0px" name="key_cache_block_size"></a>key_cache_block_size</h2><p style="margin: 10px auto; padding: 0px">与key_buffer_size相关联的另外一个参数是 key_cache_block_size<br />命令行参数: &ndash;key_cache_block_size=#<br />ini/cnf参数: key_cache_block_size<br />mysql 变量: key_cache_block_size<br />全局变量，可动态调整，取值范围 512bytes到16k。</p><p style="margin: 10px auto; padding: 0px">key_cache_block_size表明key_buffer_size被分割的区域的大小。可以通过 show status 来判断当前key_buffer_size被分为多少个块：</p><p style="margin: 10px auto; padding: 0px">Key_blocks_unused, 目前剩余可用的索引缓存空间<br />Key_blocks_used(历史上的最大峰值)</p><p style="margin: 10px auto; padding: 0px">对于一个key_buffer_size=4G的数据库来说， key_cache_block_size*Key_blocks_unused 就是剩余的可用的缓存空间。只要这个空间允许，我们都应该尽可能的把索引预装入缓存中（见<a style="margin: 0px; padding: 0px; color: black" href="http://ddbiz.com/blog/mysql/mysql%e4%bc%98%e5%8c%96%e4%b9%8b%e7%b4%a2%e5%bc%95%e4%bc%98%e5%8c%96/961#load-index-into-cache">LOAD INDEX INTO CACHE</a></p><p style="margin: 10px auto; padding: 0px">理论上讲，key_cache_block_size与操作系统的I/O buffer相同大小时工作（读取、写入）效率最高，比如linux中i/o缓存一般为1k. 对于mysql来说，可以通过&nbsp;<a style="margin: 0px; padding: 0px; color: black" href="http://ddbiz.com/blog/mysql/mysql%e4%bc%98%e5%8c%96%e4%b9%8b%e7%b4%a2%e5%bc%95%e4%bc%98%e5%8c%96/961#myisam-block-size">&ndash;myisam-block-size</a>来定义MyISAM索引文件的块大小，其最小为1k。</p></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal"><h2 style="margin: 15px auto 2px; padding: 0px; font-size: 21px"><a style="margin: 0px; padding: 0px" name="key_cache_division_limit"></a>key_cache_division_limit</h2><p style="margin: 10px auto; padding: 0px">命令行参数: &ndash;key_cache_division_limit=1~100<br />配置文件参数: key_cache_division_limit=#<br />MySQL变量: key_cache_division_limit<br />全局可调整变量，默认为100(即LRU队列)。<br />当MyISAM的key_buffer_size中设置了key_cache_division_limit(</p></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal"><h2 style="margin: 15px auto 2px; padding: 0px; font-size: 21px"><a style="margin: 0px; padding: 0px" name="key_cache_age_threshold"></a>key_cache_age_threshold</h2><p style="margin: 10px auto; padding: 0px">命令行参数: &ndash;key_cache_age_threshold=100~4G(32bitOS)或者100~~(64bitOS)<br />配置文件参数: key_cache_age_threshold=#<br />MySQL变量: key_cache_age_threshold<br />全局可调整变量，默认为300。<br />当MyISAM的key_buffer_size被分为热链和温链时，key_cache_age_threshold就被用来控制什么样的情况下处于热链的数据会被转移到温链中。key_cache_age_threshold是指的block个数，如果在最近的 （key_cache_age_threshold * key_cache_division_limit/100）次访问中，处于热链顶部的block没有被访问到，那么这些块将被移到温链的顶部（处于温链顶部的block会很快被移除出key cache）。</p><p style="margin: 10px auto; padding: 0px"><span style="margin: 0px; padding: 0px" class="warning">说明:<br />key_buffer_size, key_cache_block_size, key_cache_division_limit, key_cache_age_threshold 这4个变量是一个结构变量中的一组变量。本文后续有部分<a style="margin: 0px; padding: 0px; color: black" href="http://ddbiz.com/blog/mysql/mysql%e4%bc%98%e5%8c%96%e4%b9%8b%e7%b4%a2%e5%bc%95%e4%bc%98%e5%8c%96/961#cache_index">详细介绍</a>.</span></p></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal"><h2 style="margin: 15px auto 2px; padding: 0px; font-size: 21px"><a style="margin: 0px; padding: 0px" name="read_buffer_size"></a>read_buffer_size</h2><p style="margin: 10px auto; padding: 0px">命令行参数: &ndash;read_buffer_size=#<br />ini/cnf参数: read_buffer_size<br />mysql 变量: read_buffer_size<br />全局变量，可动态调整，默认128k，取值范围8k到2G.</p><p style="margin: 10px auto; padding: 0px">read_buffer_size主要作用于顺序读取一批数据时，减少数据库文件访问的次数。</p><blockquote style="margin: 10px 0px; padding: 5px 10px; border: 2px solid #efefef; line-height: 1.6; color: #333333; background: none"><p style="margin: 10px auto; padding: 0px">受如下参数影响:<br />将影响如下参数: KEY_BLOCK_SIZE（表创建时的参数）<br />调整触发条件:</p></blockquote></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal"><h2 style="margin: 15px auto 2px; padding: 0px; font-size: 21px"><a style="margin: 0px; padding: 0px" name="read_rnd_buffer_size"></a>read_rnd_buffer_size</h2><p style="margin: 10px auto; padding: 0px">命令行参数: &ndash;read_rnd_buffer_size=#<br />ini/cnf参数: read_rnd_buffer_size<br />mysql 变量: read_rnd_buffer_size<br />全局变量，可动态调整，默认256k，取值范围8k到4G.</p><p style="margin: 10px auto; padding: 0px">read_rnd_buffer_size用于<strong style="margin: 0px; padding: 0px">使用键/索引进行排序时</strong>的磁盘文件预读，一个足够大的read_rnd_buffer_size对ORDER BY语句会有很大影响。<br /><span style="margin: 0px; padding: 0px" class="notice">注意:read_rnd_buffer_size是和每一个session相关的，因此其大小需要谨慎处理，当并发连接很大时，尤其要小心。</span></p></li></ol></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal"><h1 style="margin: 0px; padding: 0px; font-size: 28px"><a style="margin: 0px; padding: 0px" name="load-index-into-cache"></a>LOAD CACHE INTO CACHE</h1><p style="margin: 10px auto; padding: 0px">MySQL可以把索引文件预先加载到<strong style="margin: 0px; padding: 0px">指定</strong>的缓存中:</p><blockquote style="margin: 10px 0px; padding: 5px 10px; border: 2px solid #efefef; line-height: 1.6; color: #333333; background: none"><p style="margin: 10px auto; padding: 0px">LOAD INDEX INTO CACHE table_name;<br />LOAD INDEX INTO CACHE table_name INDEX (index_name_1, index_name_2);<br />LOAD INDEX INTO CACHE table_name INDEX (index_name_1, index_name_2) IGNORE LEAVES;</p></blockquote><p style="margin: 10px auto; padding: 0px">对于查询型的超大型的表，当没有足够的内存时，可以使用 IGNORE LEAVES 的方式加载索引到缓存。比如一个接近1Billion的数据表，其索引可能也是几G大小的。下面这个例子就显示了当预先加载数据索引时，查询的速度变化，这个数据表有接近1亿条记录，3个索引，有超过3G的大小，对于同一个查询：</p><blockquote style="margin: 10px 0px; padding: 5px 10px; border: 2px solid #efefef; line-height: 1.6; color: #333333; background: none"><p style="margin: 10px auto; padding: 0px">#mysql&gt; select * from tbigdatatable where username in (&lsquo;ABCDEF&rsquo;, &lsquo;19740821&rsquo;)</p></blockquote><p style="margin: 10px auto; padding: 0px">在非预先加载索引以及预载索引的情况下，查询的响应区别:</p><blockquote style="margin: 10px 0px; padding: 5px 10px; border: 2px solid #efefef; line-height: 1.6; color: #333333; background: none"><p style="margin: 10px auto; padding: 0px">#mysqld_safe &ndash;key-buffer-cache=1073741824<br />####不预载索引#### 5 rows in set (0.65 sec)<br />######预载索引#### 5 rows in set (1.94 sec)</p></blockquote><p style="margin: 10px auto; padding: 0px">当然一个查询有很大的偶然性，不过从一个大量的查询平均来看，这个效果还是有很大的差别的。</p><p style="margin: 10px auto; padding: 0px">如果一个表的索引包含不同的key_block_size,那么这个预装载将会遇到困难, 如：</p><blockquote style="margin: 10px 0px; padding: 5px 10px; border: 2px solid #efefef; line-height: 1.6; color: #333333; background: none"><p style="margin: 10px auto; padding: 0px">alter table tbigdatatable add index idx_bigdatatable_username(username) key_block_size=8192, add index idx_bigdatatable_email(email) key_block_size=8192, add index idx_bigdatatable_id(id) key_block_size=1024;<br />load index into cache tbigdatatable index (idx_bigdatatable_username, idx_bigdatatable_email) ignore leaves;<br />+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;-+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-+<br />&#124; Table &#124; Op &#124; Msg_type &#124; Msg_text &#124;<br />+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;-+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-+<br />&#124; coredata.tbigdatatable &#124; preload_keys &#124; error &#124; Indexes use different block sizes &#124;<br />&#124; coredata.tbigdatatable &#124; preload_keys &#124; error &#124; Subpartition p178sp0 returned error &#124;<br />&#124; coredata.tbigdatatable &#124; preload_keys &#124; status &#124; Operation failed &#124;<br />+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;-+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-+</p></blockquote><p style="margin: 10px auto; padding: 0px">因为.MYI中包含不同block_size的索引，所以无法预加载！</p><p style="margin: 10px auto; padding: 0px"><span style="margin: 0px; padding: 0px" class="notice">MySQL 5.1 对分区表不能预装载索引：<br />preload_keys &#124; note &#124; The storage engine for the table doesn&rsquo;t support preload_keys<br />真是不幸, 这些版本包括: 5.1.47, 5.1.61-community-log</span></p><p style="margin: 10px auto; padding: 0px">因为手头上没有MySQL5.5的数据库可供使用，所以关于预装载索引到内存的方法只能暂时放一放，这也导致了我的另外一个测试项目差点夭折：9千万数据的<a style="margin: 0px; padding: 0px; color: black" href="http://ddbiz.com/%e6%b3%84%e5%af%86%e7%94%a8%e6%88%b7%e6%a3%80%e7%b4%a2" target="_blank">分区表查询</a>，每个查询要耗时1m左右，伤不起啊。</p></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal"><h1 style="margin: 0px; padding: 0px; font-size: 28px"><a style="margin: 0px; padding: 0px" name="cache_index"></a>CACHE INDEX</h1><p style="margin: 10px auto; padding: 0px">LOAD INDEX INTO CACHE可以把索引装入缓存中，除此外，MySQL还可以更有针对性的把索引装入制定的缓存中。key_buffer_size是一个结构中一个变量，这个结构是系统的默认缓存空间，我们还可以设定其他的缓存空间，比如：</p><blockquote style="margin: 10px 0px; padding: 5px 10px; border: 2px solid #efefef; line-height: 1.6; color: #333333; background: none"><p style="margin: 10px auto; padding: 0px">set global key1.key_buffer_size=128*1024*1024;<br />set global key2.key_buffer_size=512*1024*1024;</p></blockquote><p style="margin: 10px auto; padding: 0px">这样我们就能定义不同的缓存空间，配合 CACHE INDEX IN cache_region语句，就可以把不同的索引放入不同的缓存中。</p><blockquote style="margin: 10px 0px; padding: 5px 10px; border: 2px solid #efefef; line-height: 1.6; color: #333333; background: none"><p style="margin: 10px auto; padding: 0px">(接上)<br />cache index table_name index (index_name_1) in key1;<br />cache index table_name index (index_name_2) in key2;<br />load cache into cache table_name index (index_name_1);<br />load cache into cache table_name index (index_name_2) ignore leaves;</p></blockquote><p style="margin: 10px auto; padding: 0px">上面的语句就把 index_name_1放入了 key1, 把 index_name_2放入了 key2;至于何时使用不同的缓存，我们在后面的实战中再做讨论。</p><p style="margin: 10px auto; padding: 0px">结构化的变量，在mysql中没办法用 show variables like &lsquo;structure_name_1.key_buffer%&rsquo; ; 的方式来查询。假如我们定义了不同的结构变量（创建不同的缓存空间的）: staticdb.*，则可以用下面的方式来查询该空间的设置情况：</p><blockquote style="margin: 10px 0px; padding: 5px 10px; border: 2px solid #efefef; line-height: 1.6; color: #333333; background: none"><p style="margin: 10px auto; padding: 0px">set global staticdb.key_buffer_size=1000*1024*1024;<br />&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;<br />mysql&gt; select @@global.staticdb.key_buffer_size KBS<br />, @@global.staticdb.key_cache_division_limit KCDL<br />, @@global.staticdb.key_cache_age_threshold KCAT<br />, @@global.staticdb.key_cache_block_size KCBS;<br />+&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;+&mdash;&mdash;+&mdash;&mdash;+<br />&#124; KBS &#124; KCDL &#124; KCAT &#124; KCBS &#124;<br />+&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;+&mdash;&mdash;+&mdash;&mdash;+<br />&#124; 1048576000 &#124; 100 &#124; 300 &#124; 1024 &#124;<br />+&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;+&mdash;&mdash;+&mdash;&mdash;+<br />1 row in set (0.00 sec)</p></blockquote><p style="margin: 10px auto; padding: 0px">目前我还没有办法查看指定一个结构空间的使用情况，如果你知道如何查看的话，请留言给我。</p></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal"><h2 style="margin: 15px auto 2px; padding: 0px; font-size: 21px"><a style="margin: 0px; padding: 0px" name="summary"></a>要点总结</h2><p style="margin: 10px auto; padding: 0px">本节的要点是：</p><blockquote style="margin: 10px 0px; padding: 5px 10px; border: 2px solid #efefef; line-height: 1.6; color: #333333; background: none"><p style="margin: 10px auto; padding: 0px">对于MyISAM来说：设置尽可能大的缓存，最好把MyISAM表的索引能够全部装入缓存中</p></blockquote></li></ol>
]]>
</description>
</item><item>
<link>http://i.renjihe.com/blog/read.php?7526</link>
<title><![CDATA[Mysql limit 优化，百万至千万级快速分页，--复合索引的引用并应用于轻量级框架]]></title> 
<author>renjihe1988 &lt;admin@yourname.com&gt;</author>
<category><![CDATA[web]]></category>
<pubDate>Thu, 01 Sep 2016 12:55:28 +0000</pubDate> 
<guid>http://i.renjihe.com/blog/read.php?7526</guid> 
<description>
<![CDATA[ 
	<p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">MySql 性能到底能有多高？用了php半年多，真正如此深入的去思考这个问题还是从前天开始。有过痛苦有过绝望，到现在充满信心！MySql 这个数据库绝对是适合dba级的高手去玩的，一般做一点1万篇新闻的小型系统怎么写都可以，用xx框架可以实现快速开发。可是数据量到了10万，百万至千 万，他的性能还能那么高吗？一点小小的失误，可能造成整个系统的改写，甚至更本系统无法正常运行！好了，不那么多废话了。用事实说话，看例子：</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">数据表 collect ( id, title ,info ,vtype) 就这4个字段，其中 title 用定长，info 用text, id 是逐渐，vtype是tinyint，vtype是索引。这是一个基本的新闻系统的简单模型。现在往里面填充数据，填充10万篇新闻。</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">最后collect 为 10万条记录，数据库表占用硬盘1.6G。OK ,看下面这条sql语句：</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">select id,title from collect limit 1000,10; 很快；基本上0.01秒就OK，再看下面的</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">select id,title from collect limit 90000,10; 从9万条开始分页，结果？</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">8-9秒完成，my god 哪出问题了？？？？其实要优化这条数据，网上找得到答案。看下面一条语句:</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">select id from collect order by id limit 90000,10; 很快，0.04秒就OK。 为什么？因为用了id主键做索引当然快。网上的改法是：</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">select id,title from collect where id&gt;=(select id from collect order by id limit 90000,1) limit 10;</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">这就是用了id做索引的结果。可是问题复杂那么一点点，就完了。看下面的语句</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">select id from collect where vtype=1 order by id limit 90000,10; 很慢，用了8-9秒！</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">到了这里我相信很多人会和我一样，有崩溃感觉！vtype 做了索引了啊？怎么会慢呢？vtype做了索引是不错，你直接 select id from collect where vtype=1 limit 1000,10; 是很快的，基本上0.05秒，可是提高90倍，从9万开始，那就是0.05*90=4.5秒的速度了。和测试结果8-9秒到了一个数量级。从这里开始有人 提出了分表的思路，这个和discuz 论坛是一样的思路。思路如下：</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">建一个索引表： t (id,title,vtype) 并设置成定长，然后做分页，分页出结果再到 collect 里面去找info 。 是否可行呢？实验下就知道了。</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">10万条记录到 t(id,title,vtype) 里，数据表大小20M左右。用</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">select id from t where vtype=1 order by id limit 90000,10; 很快了。基本上0.1-0.2秒可以跑完。为什么会这样呢？我猜想是因为collect 数据太多，所以分页要跑很长的路。limit 完全和数据表的大小有关的。其实这样做还是全表扫描，只是因为数据量小，只有10万才快。OK， 来个疯狂的实验，加到100万条，测试性能。</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">加了10倍的数据，马上t表就到了200多M，而且是定长。还是刚才的查询语句，时间是0.1-0.2秒完成！分表性能没问题？错！因为我们的limit还是9万，所以快。给个大的，90万开始</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">select id from t where vtype=1 order by id limit 900000,10; 看看结果，时间是1-2秒！</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">why ?? 分表了时间还是这么长，非常之郁闷！有人说定长会提高limit的性能，开始我也以为，因为一条记录的长度是固定的，mysql 应该可以算出90万的位置才对啊？ 可是我们高估了mysql 的智能，他不是商务数据库，事实证明定长和非定长对limit影响不大？ 怪不得有人说 discuz到了100万条记录就会很慢，我相信这是真的，这个和数据库设计有关！</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1"><strong>难道MySQL 无法突破100万的限制吗？？？到了100万的分页就真的到了极限？？？</strong></p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1"><strong>答案是： NO !!!! 为什么突破不了100万是因为不会设计mysql造成的。下面介绍非分表法，来个疯狂的测试！一张表搞定100万记录，并且10G 数据库，如何快速分页！</strong></p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">好了，我们的测试又回到 collect表，开始测试结论是： 30万数据，用分表法可行，超过30万他的速度会慢道你无法忍受！当然如果用分表+我这种方法，那是绝对完美的。但是用了我这种方法后，不用分表也可以完美解决！</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">答案就是：复合索引！ 有一次设计mysql索引的时候，无意中发现索引名字可以任取，可以选择几个字段进来，这有什么用呢？开始的select id from collect order by id limit 90000,10; 这么快就是因为走了索引，可是如果加了where 就不走索引了。抱着试试看的想法加了 search(vtype,id) 这样的索引。然后测试</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">select id from collect where vtype=1 limit 90000,10; 非常快！0.04秒完成！</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">再测试: select id ,title from collect where vtype=1 limit 90000,10; 非常遗憾，8-9秒，没走search索引！</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">再测试：search(id,vtype)，还是select id 这个语句，也非常遗憾，0.5秒。</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1"><strong>综上：如果对于有where 条件，又想走索引用limit的，必须设计一个索引，将where 放第一位，limit用到的主键放第2位，而且只能select 主键！</strong></p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">完美解决了分页问题了。可以快速返回id就有希望优化limit ， 按这样的逻辑，百万级的limit 应该在0.0x秒就可以分完。看来mysql 语句的优化和索引时非常重要的！</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">好了，回到原题，如何将上面的研究成功快速应用于开发呢？如果用复合查询，我的轻量级框架就没的用了。分页字符串还得自己写，那多麻烦？这里再看一个例子，思路就出来了：</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">select * from collect where id in (9000,12,50,7000); 竟然 0秒就可以查完！</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">mygod ，mysql 的索引竟然对于in语句同样有效！看来网上说in无法用索引是错误的！</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">有了这个结论，就可以很简单的应用于轻量级框架了：</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">代码如下：</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">$db=dblink();<br />$db-&gt;pagesize=20;</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">$sql=&quot;select id from collect where vtype=$vtype&quot;;</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">$db-&gt;execute($sql);<br />$strpage=$db-&gt;strpage(); //将分页字符串保存在临时变量，方便输出<br />while($rs=$db-&gt;fetch_array())&#123;<br />&nbsp;&nbsp; $strid.=$rs['id'].',';<br />&#125;<br />$strid=substr($strid,0,strlen($strid)-1); //构造出id字符串<br />$db-&gt;pagesize=0; //很关键，在不注销类的情况下，将分页清空，这样只需要用一次数据库连接，不需要再开；<br />$db-&gt;execute(&quot;select id,title,url,sTime,gTime,vtype,tag from collect where id in ($strid)&quot;);</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">&lt;?php while($rs=$db-&gt;fetch_array()): ?&gt;<br />&lt;tr&gt;<br />&nbsp;&nbsp;&nbsp; &lt;td&gt;&amp;nbsp;&lt;?php echo $rs['id'];?&gt;&lt;/td&gt;<br />&nbsp;&nbsp;&nbsp; &lt;td&gt;&amp;nbsp;&lt;?php echo $rs['url'];?&gt;&lt;/td&gt;<br />&nbsp;&nbsp;&nbsp; &lt;td&gt;&amp;nbsp;&lt;?php echo $rs['sTime'];?&gt;&lt;/td&gt;<br />&nbsp;&nbsp;&nbsp; &lt;td&gt;&amp;nbsp;&lt;?php echo $rs['gTime'];?&gt;&lt;/td&gt;<br />&nbsp;&nbsp;&nbsp; &lt;td&gt;&amp;nbsp;&lt;?php echo $rs['vtype'];?&gt;&lt;/td&gt;<br />&nbsp;&nbsp;&nbsp; &lt;td&gt;&amp;nbsp;&lt;a xhref=&quot;?act=show&amp;id=&lt;?php echo $rs['id'];?&gt;&quot; target=&quot;_blank&quot;&gt;&lt;?php echo $rs['title'];?&gt;&lt;/a&gt;&lt;/td&gt;<br />&nbsp;&nbsp;&nbsp; &lt;td&gt;&amp;nbsp;&lt;?php echo $rs['tag'];?&gt;&lt;/td&gt;<br />&lt;/tr&gt;<br />&lt;?php endwhile; ?&gt;<br />&lt;/table&gt;<br />&lt;?php<br />echo $strpage;</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">通过简单的变换，其实思路很简单：1）通过优化索引，找出id，并拼成 &quot;123,90000,12000&quot; 这样的字符串。2）第2次查询找出结果。</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">小小的索引+一点点的改动就使mysql 可以支持百万甚至千万级的高效分页！</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">通过这里的例子，我反思了一点：对于大型系统，PHP千万不能用框架，尤其是那种连sql语句都看不到的框架！因为开始对于我的轻量级框架都差点崩 溃！只适合小型应用的快速开发，对于ERP,OA，大型网站，数据层包括逻辑层的东西都不能用框架。如果程序员失去了对sql语句的把控，那项目的风险将 会成几何级数增加！尤其是用mysql 的时候，mysql 一定需要专业的dba 才可以发挥他的最佳性能。一个索引所造成的性能差别可能是上千倍！</p><p style="line-height: 28px; margin: 0px 0px 10px; padding: 0px; color: #443e39; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; font-size: 16px; background-color: #f9f7f1">PS: 经过实际测试，到了100万的数据，160万数据，15G表，190M索引，就算走索引，limit都得0.49秒。所以<strong>分页最好别让别人看到10万条以后的数据</strong>， 要不然会很慢！就算用索引。经过这样的优化，mysql到了百万级分页是个极限！但有这样的成绩已经很不错，如果你是用sqlserver肯定卡死！而 160万的数据用 id in (str) 很快，基本还是0秒。如果这样，千万级的数据，mysql应该也很容易应付。</p>
]]>
</description>
</item><item>
<link>http://i.renjihe.com/blog/read.php?7525</link>
<title><![CDATA[mysql sql语句执行时间查询]]></title> 
<author>renjihe1988 &lt;admin@yourname.com&gt;</author>
<category><![CDATA[web]]></category>
<pubDate>Thu, 01 Sep 2016 12:55:05 +0000</pubDate> 
<guid>http://i.renjihe.com/blog/read.php?7525</guid> 
<description>
<![CDATA[ 
	<p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px; color: #3d464d; font-family: 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif; font-size: 16px; line-height: 30px">第一种：</p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px; color: #3d464d; font-family: 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif; font-size: 16px; line-height: 30px">开启profile</p><pre class="brush:shell; toolbar: true; auto-links: false; hljs bash" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: #777777; border-radius: 3px; line-height: 1.4; word-wrap: normal; background: #fdf6e3">mysql&gt; <span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: #dc322f" class="hljs-built_in">set</span> profiling=1; Query OK, 0 rows affected (0.00 sec)</pre><span style="font-size: 16px; line-height: 30px; font-family: 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif; color: #3d464d">eg：</span><pre class="brush:shell; toolbar: true; auto-links: false; hljs lua" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: #777777; border-radius: 3px; line-height: 1.4; word-wrap: normal; background: #fdf6e3">mysql&gt; <span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: #dc322f" class="hljs-built_in">select</span> * from test_1; mysql&gt; show profiles; +<span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: #93a1a1" class="hljs-comment">----------+------------+----------------------+</span> &#124; Query_ID &#124; Duration&nbsp;&nbsp; &#124; Query&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#124; +<span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: #93a1a1" class="hljs-comment">----------+------------+----------------------+</span> &#124;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: #2aa198" class="hljs-number">1</span> &#124; <span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: #2aa198" class="hljs-number">0.84718100</span> &#124; <span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: #dc322f" class="hljs-built_in">select</span> * from test_1 &#124; +<span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: #93a1a1" class="hljs-comment">----------+------------+----------------------+</span> <span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: #2aa198" class="hljs-number">1</span> row <span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: #859900" class="hljs-keyword">in</span> set (<span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: #2aa198" class="hljs-number">0.00</span> sec)</pre><span style="font-size: 16px; line-height: 30px; font-family: 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif; color: #3d464d">第二种：(通过时间差查看)</span><pre class="hljs sql" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: #777777; border-radius: 3px; line-height: 1.4; word-wrap: normal; background: #fdf6e3"><span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent">delimiter //</span> <span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: #859900" class="hljs-keyword">set</span> @d=<span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: #859900" class="hljs-keyword">now</span>(); <span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: #859900" class="hljs-keyword">select</span> * <span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: #859900" class="hljs-keyword">from</span> <span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: #859900" class="hljs-keyword">comment</span>; <span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: #859900" class="hljs-keyword">select</span> <span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: #859900" class="hljs-keyword">timestampdiff</span>(<span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: #859900" class="hljs-keyword">second</span>,@d,<span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: #859900" class="hljs-keyword">now</span>()); delimiter ;&nbsp;&nbsp; Query OK, 0 rows affected (1 min 55.58 sec)&nbsp;&nbsp; +<span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: #93a1a1" class="hljs-comment">----------------------------------+</span> &#124; timestampdiff(second, @d, now()) &#124; +<span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: #93a1a1" class="hljs-comment">----------------------------------+</span> &#124; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 &#124; +<span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: #93a1a1" class="hljs-comment">----------------------------------+</span> 1 row in <span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: #859900" class="hljs-keyword">set</span> (<span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: #2aa198" class="hljs-number">1</span> <span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: #859900" class="hljs-keyword">min</span> <span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: #2aa198" class="hljs-number">55.58</span> sec) </pre>
]]>
</description>
</item><item>
<link>http://i.renjihe.com/blog/read.php?7523</link>
<title><![CDATA[如何实现按距离排序、范围查找]]></title> 
<author>renjihe1988 &lt;admin@yourname.com&gt;</author>
<category><![CDATA[web]]></category>
<pubDate>Thu, 01 Sep 2016 12:53:46 +0000</pubDate> 
<guid>http://i.renjihe.com/blog/read.php?7523</guid> 
<description>
<![CDATA[ 
	<h1 style="margin: 0.8em 0px; padding: 0px; box-sizing: border-box; font-weight: 100; color: #333333; font-family: 'microsoft yahei'; line-height: 26px">简介</h1><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">现在几乎所有的O2O应用中都会存在&ldquo;按范围搜素、离我最近、显示距离&rdquo;等等基于位置的交互，那这样的功能是怎么实现的呢？本文提供的实现方式，适用于所有数据库。</p><h1 style="margin: 0.8em 0px; padding: 0px; box-sizing: border-box; font-weight: 100; color: #333333; font-family: 'microsoft yahei'; line-height: 26px"><a style="color: #336699; box-sizing: border-box" name="t1"></a>实现</h1><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">为了方便下面说明，先给出一个初始表结构，我使用的是<a style="color: #df3434; text-decoration: none; box-sizing: border-box; font-weight: bold" href="http://lib.csdn.net/base/14" target="_blank" title="undefined" class="replace_word">MySQL</a>：</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)"><span style="box-sizing: border-box" class="hljs-operator"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">CREATE</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">TABLE</span> <span style="box-sizing: border-box; color: #008800" class="hljs-string">`customer`</span> (&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #008800" class="hljs-string">`id`</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">INT</span>(<span style="box-sizing: border-box; color: #006666" class="hljs-number">11</span>) UNSIGNED <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NOT</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span style="box-sizing: border-box; color: #008800" class="hljs-string">'自增主键'</span>,&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #008800" class="hljs-string">`name`</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">VARCHAR</span>(<span style="box-sizing: border-box; color: #006666" class="hljs-number">5</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NOT</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NULL</span> COMMENT <span style="box-sizing: border-box; color: #008800" class="hljs-string">'名称'</span>,&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #008800" class="hljs-string">`lon`</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">DOUBLE</span>(<span style="box-sizing: border-box; color: #006666" class="hljs-number">9</span>,<span style="box-sizing: border-box; color: #006666" class="hljs-number">6</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NOT</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NULL</span> COMMENT <span style="box-sizing: border-box; color: #008800" class="hljs-string">'经度'</span>,&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #008800" class="hljs-string">`lat`</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">DOUBLE</span>(<span style="box-sizing: border-box; color: #006666" class="hljs-number">8</span>,<span style="box-sizing: border-box; color: #006666" class="hljs-number">6</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NOT</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NULL</span> COMMENT <span style="box-sizing: border-box; color: #008800" class="hljs-string">'纬度'</span>,&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">PRIMARY</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">KEY</span> (<span style="box-sizing: border-box; color: #008800" class="hljs-string">`id`</span>) ) COMMENT=<span style="box-sizing: border-box; color: #008800" class="hljs-string">'商户表'</span> CHARSET=utf8mb4 ENGINE=InnoDB ;</span><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li><li style="box-sizing: border-box; padding: 0px 5px">11</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li><li style="box-sizing: border-box; padding: 0px 5px">11</li></ul></pre><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">实现过程主要分为四步：&nbsp;<br />1. 搜索&nbsp;<br />在数据库中搜索出接近指定范围内的商户，如：搜索出1公里范围内的。&nbsp;<br />2. 过滤&nbsp;<br />搜索出来的结果可能会存在超过1公里的，需要再次过滤。如果对精度没有严格要求，可以跳过。&nbsp;<br />3. 排序&nbsp;<br />距离由近到远排序。如果不需要，可以跳过。&nbsp;<br />4. 分页&nbsp;<br />如果需要2、3步，才需要对分页特殊处理。如果不需要，可以在第1步直接SQL分页。</p><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">第1步数据库完成，后3步应用程序完成。</p><h2 style="margin: 0.8em 0px; padding: 0px; box-sizing: border-box; font-weight: 100; color: #333333; font-family: 'microsoft yahei'; line-height: 26px"><a style="color: #336699; box-sizing: border-box" name="t2"></a>step1 搜索</h2><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">搜索可以用下面两种方式来实现。</p><h3 style="margin: 0.8em 0px; padding: 0px; box-sizing: border-box; font-weight: 100; color: #333333; font-family: 'microsoft yahei'; line-height: 26px"><a style="color: #336699; box-sizing: border-box" name="t3"></a>区间查找</h3><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">customer表中使用两个字段存储了经度和纬度，如果提前计算出经纬度的范围，然后在这两个字段上加上索引，那搜索性能会很不错。&nbsp;<br />那怎么计算出经纬度的范围呢？已知条件是移动设备所在的经纬度，还有满足业务要求的半径，这很像初中的一道平面几何题：给定圆心坐标和半径，求该圆外切正方形四个顶点的坐标。而我们面对的是一个球体，可以使用<a style="color: #336699; text-decoration: none; box-sizing: border-box" href="https://github.com/locationtech/spatial4j">spatial4j</a>来计算。</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)"><span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;<span style="box-sizing: border-box; color: #000088" class="hljs-title">dependency</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;<span style="box-sizing: border-box; color: #000088" class="hljs-title">groupId</span>&gt;</span>com.spatial4j<span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;/<span style="box-sizing: border-box; color: #000088" class="hljs-title">groupId</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;<span style="box-sizing: border-box; color: #000088" class="hljs-title">artifactId</span>&gt;</span>spatial4j<span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;/<span style="box-sizing: border-box; color: #000088" class="hljs-title">artifactId</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;<span style="box-sizing: border-box; color: #000088" class="hljs-title">version</span>&gt;</span>0.5<span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;/<span style="box-sizing: border-box; color: #000088" class="hljs-title">version</span>&gt;</span> <span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;/<span style="box-sizing: border-box; color: #000088" class="hljs-title">dependency</span>&gt;</span><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li></ul></pre><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)">// 移动设备经纬度 double lon = <span style="box-sizing: border-box; color: #006666" class="hljs-number">116.312528</span>, lat = <span style="box-sizing: border-box; color: #006666" class="hljs-number">39.983733</span><span style="box-sizing: border-box; color: #880000" class="hljs-comment">;</span> // 千米 int radius = <span style="box-sizing: border-box; color: #006666" class="hljs-number">1</span><span style="box-sizing: border-box; color: #880000" class="hljs-comment">;</span>&nbsp;&nbsp;SpatialContext geo = SpatialContext<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.GEO</span><span style="box-sizing: border-box; color: #880000" class="hljs-comment">;</span> Rectangle rectangle = geo<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.getDistCalc</span>()<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.calcBoxByDistFromPt</span>(&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; geo<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.makePoint</span>(lon, lat), radius * DistanceUtils<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.KM</span>_TO_DEG, geo, null)<span style="box-sizing: border-box; color: #880000" class="hljs-comment">;</span> System<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.out</span><span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.println</span>(rectangle<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.getMinX</span>() + <span style="box-sizing: border-box; color: #008800" class="hljs-string">&quot;-&quot;</span> + rectangle<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.getMaxX</span>())<span style="box-sizing: border-box; color: #880000" class="hljs-comment">;// 经度范围</span> System<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.out</span><span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.println</span>(rectangle<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.getMinY</span>() + <span style="box-sizing: border-box; color: #008800" class="hljs-string">&quot;-&quot;</span> + rectangle<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.getMaxY</span>())<span style="box-sizing: border-box; color: #880000" class="hljs-comment">;// 纬度范围</span><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li></ul></pre><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">计算出经纬度范围之后，SQL是这样：</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)"><span style="box-sizing: border-box" class="hljs-operator"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">SELECT</span> id, name <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">FROM</span> customer <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">WHERE</span> (lon BETWEEN ? <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">AND</span> ?) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">AND</span> (lat BETWEEN ? <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">AND</span> ?);</span><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li></ul></pre><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">需要给lon、lat两个字段建立联合索引：</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)">INDEX <span style="box-sizing: border-box" class="hljs-escape">`i</span>dx_lon_lat<span style="box-sizing: border-box" class="hljs-escape">` </span>(<span style="box-sizing: border-box" class="hljs-escape">`l</span>on<span style="box-sizing: border-box" class="hljs-escape">`,</span> <span style="box-sizing: border-box" class="hljs-escape">`l</span>at<span style="box-sizing: border-box" class="hljs-escape">`)</span><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li></ul></pre><h3 style="margin: 0.8em 0px; padding: 0px; box-sizing: border-box; font-weight: 100; color: #333333; font-family: 'microsoft yahei'; line-height: 26px"><a style="color: #336699; box-sizing: border-box" name="t4"></a>geohash</h3><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">geohash的原理不讲了，详细可以看<a style="color: #336699; text-decoration: none; box-sizing: border-box" href="http://www.cnblogs.com/LBSer/p/3310455.html">这篇文章</a>，讲的很详细。geohash算法能把二维的经纬度编码成一维的字符串，它的特点是越相近的经纬度编码后越相似，所以可以通过前缀like的方式去匹配周围的商户。&nbsp;<br />customer表要增加一个字段，来存储每个商户的geohash编码，并且建立索引。</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)"><span style="box-sizing: border-box" class="hljs-operator"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">CREATE</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">TABLE</span> <span style="box-sizing: border-box; color: #008800" class="hljs-string">`customer`</span> (&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #008800" class="hljs-string">`id`</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">INT</span>(<span style="box-sizing: border-box; color: #006666" class="hljs-number">11</span>) UNSIGNED <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NOT</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span style="box-sizing: border-box; color: #008800" class="hljs-string">'自增主键'</span>,&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #008800" class="hljs-string">`name`</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">VARCHAR</span>(<span style="box-sizing: border-box; color: #006666" class="hljs-number">5</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NOT</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NULL</span> COMMENT <span style="box-sizing: border-box; color: #008800" class="hljs-string">'名称'</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">COLLATE</span> <span style="box-sizing: border-box; color: #008800" class="hljs-string">'latin1_swedish_ci'</span>,&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #008800" class="hljs-string">`lon`</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">DOUBLE</span>(<span style="box-sizing: border-box; color: #006666" class="hljs-number">9</span>,<span style="box-sizing: border-box; color: #006666" class="hljs-number">6</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NOT</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NULL</span> COMMENT <span style="box-sizing: border-box; color: #008800" class="hljs-string">'经度'</span>,&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #008800" class="hljs-string">`lat`</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">DOUBLE</span>(<span style="box-sizing: border-box; color: #006666" class="hljs-number">8</span>,<span style="box-sizing: border-box; color: #006666" class="hljs-number">6</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NOT</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NULL</span> COMMENT <span style="box-sizing: border-box; color: #008800" class="hljs-string">'纬度'</span>,&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #008800" class="hljs-string">`geo_code`</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">CHAR</span>(<span style="box-sizing: border-box; color: #006666" class="hljs-number">12</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NOT</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">NULL</span> COMMENT <span style="box-sizing: border-box; color: #008800" class="hljs-string">'geohash编码'</span>,&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">PRIMARY</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">KEY</span> (<span style="box-sizing: border-box; color: #008800" class="hljs-string">`id`</span>),&nbsp;&nbsp;&nbsp;&nbsp; INDEX <span style="box-sizing: border-box; color: #008800" class="hljs-string">`idx_geo_code`</span> (<span style="box-sizing: border-box; color: #008800" class="hljs-string">`geo_code`</span>) ) COMMENT=<span style="box-sizing: border-box; color: #008800" class="hljs-string">'商户表'</span> CHARSET=utf8mb4 ENGINE=InnoDB ;</span><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li><li style="box-sizing: border-box; padding: 0px 5px">11</li><li style="box-sizing: border-box; padding: 0px 5px">12</li><li style="box-sizing: border-box; padding: 0px 5px">13</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li><li style="box-sizing: border-box; padding: 0px 5px">11</li><li style="box-sizing: border-box; padding: 0px 5px">12</li><li style="box-sizing: border-box; padding: 0px 5px">13</li></ul></pre><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">在新增或修改一个商户的时候，维护好geo_code，那geo_code怎么计算呢？<a style="color: #336699; text-decoration: none; box-sizing: border-box" href="https://github.com/locationtech/spatial4j">spatial4j</a>也提供了一个工具类GeohashUtils.encodeLatLon(lat, lon)，默认精度是12位。这个存储做好后，就可以通过geo_code去搜索了。拿到移动设备的经纬度，计算geo_code，这时可以指定精度计算，那指定多长呢？我们需要一个geo_code长度和距离的对照表：</p><table border="0" style="box-sizing: border-box; width: 708px; border-collapse: collapse; border-spacing: 0px; border: 1px solid #eeeeee; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px"><thead><tr style="box-sizing: border-box"><th style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">geohash length</th><th style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">width</th><th style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">height</th></tr></thead><tbody><tr style="box-sizing: border-box"><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">1</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">5,009.4km</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">4,992.6km</td></tr><tr style="box-sizing: border-box"><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">2</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">1,252.3km</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">624.1km</td></tr><tr style="box-sizing: border-box"><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">3</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">156.5km</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">156km</td></tr><tr style="box-sizing: border-box"><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">4</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">39.1km</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">19.5km</td></tr><tr style="box-sizing: border-box"><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">5</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">4.9km</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">4.9km</td></tr><tr style="box-sizing: border-box"><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">6</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">1.2km</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">609.4m</td></tr><tr style="box-sizing: border-box"><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">7</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">152.9m</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">152.4m</td></tr><tr style="box-sizing: border-box"><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">8</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">38.2m</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">19m</td></tr><tr style="box-sizing: border-box"><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">9</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">4.8m</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">4.8m</td></tr><tr style="box-sizing: border-box"><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">10</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">1.2m</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">59.5cm</td></tr><tr style="box-sizing: border-box"><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">11</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">14.9cm</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">14.9cm</td></tr><tr style="box-sizing: border-box"><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">12</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">3.7cm</td><td style="box-sizing: border-box; padding: 8px; line-height: 20px; vertical-align: top; border: 1px solid #eeeeee">1.9cm</td></tr></tbody></table><blockquote style="box-sizing: border-box; margin: 0px 0px 1.1em; padding: 15px 20px; border-left-width: 10px; border-left-style: solid; border-left-color: rgba(128, 128, 128, 0.0745098); border-radius: 0px 5px 5px 0px; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px; background-color: rgba(128, 128, 128, 0.0470588)"><p style="box-sizing: border-box; margin: 0px; line-height: 1.25"><a style="color: #336699; text-decoration: none; box-sizing: border-box" href="https://en.wikipedia.org/wiki/Geohash#Cell_Dimensions">https://en.wikipedia.org/wiki/Geohash#Cell_Dimensions</a></p></blockquote><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">假设我们的需求是1公里范围内的商户，geo_code的长度设置为5就可以了，GeohashUtils.encodeLatLon(lat, lon, 5)。计算出移动设备经纬度的geo_code之后，SQL是这样：</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)"><span style="box-sizing: border-box" class="hljs-operator"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">SELECT</span> id, name <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">FROM</span> customer <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">WHERE</span> geo_code <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">LIKE</span> CONCAT(?, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'%'</span>);</span><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li></ul></pre><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">这样会比区间查找快很多，并且得益于geo_code的相似性，可以对热点区域做缓存。但这样使用geohash还存在一个问题，geohash最终是在地图上铺上了一个网格，每一个网格代表一个geohash值，当传入的坐标接近当前网格的边界时，用上面的搜索方式就会丢失它附近的数据。比如下图中，在绿点的位置搜索不到白家大院，绿点和白家大院在划分的时候就分到了两个格子中。&nbsp;<br /><img style="border: none; box-sizing: border-box; max-width: 100%" src="http://img.blog.csdn.net/20160715101657127" border="0" alt="这里写图片描述" />&nbsp;<br />解决这个问题思路也比较简单，我们查询时，除了使用绿点的geohash编码进行匹配外，还使用周围8个网格的geohash编码，这样可以避免这个问题。那怎么计算出周围8个网格的geohash呢，可以使用<a style="color: #336699; text-decoration: none; box-sizing: border-box" href="https://github.com/kungfoo/geohash-java">geohash-java</a>来解决。</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)"><span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;<span style="box-sizing: border-box; color: #000088" class="hljs-title">dependency</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;<span style="box-sizing: border-box; color: #000088" class="hljs-title">groupId</span>&gt;</span>ch.hsr<span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;/<span style="box-sizing: border-box; color: #000088" class="hljs-title">groupId</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;<span style="box-sizing: border-box; color: #000088" class="hljs-title">artifactId</span>&gt;</span>geohash<span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;/<span style="box-sizing: border-box; color: #000088" class="hljs-title">artifactId</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;<span style="box-sizing: border-box; color: #000088" class="hljs-title">version</span>&gt;</span>1.3.0<span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;/<span style="box-sizing: border-box; color: #000088" class="hljs-title">version</span>&gt;</span> <span style="box-sizing: border-box; color: #006666" class="hljs-tag">&lt;/<span style="box-sizing: border-box; color: #000088" class="hljs-title">dependency</span>&gt;</span><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li></ul></pre><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)">// 移动设备经纬度 double lon = <span style="box-sizing: border-box; color: #006666" class="hljs-number">116.312528</span>, lat = <span style="box-sizing: border-box; color: #006666" class="hljs-number">39.983733</span><span style="box-sizing: border-box; color: #880000" class="hljs-comment">;</span> GeoHash geoHash = GeoHash<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.withCharacterPrecision</span>(lat, lon, <span style="box-sizing: border-box; color: #006666" class="hljs-number">10</span>)<span style="box-sizing: border-box; color: #880000" class="hljs-comment">;</span> // 当前 System<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.out</span><span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.println</span>(geoHash<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.toBase</span>32())<span style="box-sizing: border-box; color: #880000" class="hljs-comment">;</span> // N, NE, E, SE, S, SW, W, NW GeoHash[] adjacent = geoHash<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.getAdjacent</span>()<span style="box-sizing: border-box; color: #880000" class="hljs-comment">;</span> for (GeoHash hash : adjacent) &#123;&nbsp;&nbsp;&nbsp;&nbsp; System<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.out</span><span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.println</span>(hash<span style="box-sizing: border-box; color: #444444" class="hljs-preprocessor">.toBase</span>32())<span style="box-sizing: border-box; color: #880000" class="hljs-comment">;</span> &#125;<ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li></ul></pre><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">最终我们的sql变成了这样：</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)"><span style="box-sizing: border-box" class="hljs-operator"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">SELECT</span> id, name <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">FROM</span> customer <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">WHERE</span> geo_code <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">LIKE</span> CONCAT(?, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'%'</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">OR</span> geo_code <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">LIKE</span> CONCAT(?, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'%'</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">OR</span> geo_code <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">LIKE</span> CONCAT(?, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'%'</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">OR</span> geo_code <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">LIKE</span> CONCAT(?, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'%'</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">OR</span> geo_code <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">LIKE</span> CONCAT(?, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'%'</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">OR</span> geo_code <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">LIKE</span> CONCAT(?, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'%'</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">OR</span> geo_code <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">LIKE</span> CONCAT(?, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'%'</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">OR</span> geo_code <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">LIKE</span> CONCAT(?, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'%'</span>) <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">OR</span> geo_code <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">LIKE</span> CONCAT(?, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'%'</span>);</span><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li><li style="box-sizing: border-box; padding: 0px 5px">11</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li><li style="box-sizing: border-box; padding: 0px 5px">11</li></ul></pre><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">原来的1次查询变成了9次查询，性能肯定会下降，这里可以优化下。还用上面的需求场景，搜索1公里范围内的商户，从上面的表格知道，geo_code长度为5时，网格宽高是4.9KM，用9个geo_code查询时，范围太大了，所以可以将geo_code长度设置为6，即缩小了查询范围，也满足了需求。还可以继续优化，在存储geo_code时，只计算到6位，这样就可以将sql变成这样：</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)"><span style="box-sizing: border-box" class="hljs-operator"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">SELECT</span> id, name <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">FROM</span> customer <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">WHERE</span> geo_code <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">IN</span> (?, ?, ?, ?, ?, ?, ?, ?, ?);</span><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li></ul></pre><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">这样将前缀匹配换成了直接匹配，速度会提升很多。</p><h2 style="margin: 0.8em 0px; padding: 0px; box-sizing: border-box; font-weight: 100; color: #333333; font-family: 'microsoft yahei'; line-height: 26px"><a style="color: #336699; box-sizing: border-box" name="t5"></a>step2 过滤</h2><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">上面两种搜索方式，都不是精确搜索，只是尽量缩小搜索范围，提升响应速度。所以需要在应用程序中做过滤，把距离大于1公里的商户过滤掉。计算距离同样使用<a style="color: #336699; text-decoration: none; box-sizing: border-box" href="https://github.com/locationtech/spatial4j">spatial4j</a>。</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)"><span style="box-sizing: border-box; color: #880000" class="hljs-comment">// 移动设备经纬度</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">double</span> lon1 = <span style="box-sizing: border-box; color: #006666" class="hljs-number">116.3125333347639</span>, lat1 = <span style="box-sizing: border-box; color: #006666" class="hljs-number">39.98355521792821</span>; <span style="box-sizing: border-box; color: #880000" class="hljs-comment">// 商户经纬度</span> <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">double</span> lon2 = <span style="box-sizing: border-box; color: #006666" class="hljs-number">116.312528</span>, lat2 = <span style="box-sizing: border-box; color: #006666" class="hljs-number">39.983733</span>;&nbsp;&nbsp;SpatialContext geo = SpatialContext.GEO; <span style="box-sizing: border-box; color: #000088" class="hljs-keyword">double</span> <span style="box-sizing: border-box; color: #660066" class="hljs-built_in">distance</span> = geo.calcDistance(geo.makePoint(lon1, lat1), geo.makePoint(lon2, lat2))&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* DistanceUtils.DEG_TO_KM; System.<span style="box-sizing: border-box; color: #000088" class="hljs-keyword">out</span>.println(<span style="box-sizing: border-box; color: #660066" class="hljs-built_in">distance</span>);<span style="box-sizing: border-box; color: #880000" class="hljs-comment">// KM</span><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li></ul></pre><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">过滤代码就不写了，遍历一遍搜索结果即可。</p><h2 style="margin: 0.8em 0px; padding: 0px; box-sizing: border-box; font-weight: 100; color: #333333; font-family: 'microsoft yahei'; line-height: 26px"><a style="color: #336699; box-sizing: border-box" name="t6"></a>step3 排序</h2><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">同样，排序也需要在应用程序中处理。排序基于上面的过滤结果做就可以了Collections.sort(list, comparator)。</p><h2 style="margin: 0.8em 0px; padding: 0px; box-sizing: border-box; font-weight: 100; color: #333333; font-family: 'microsoft yahei'; line-height: 26px"><a style="color: #336699; box-sizing: border-box" name="t7"></a>step4 分页</h2><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">如果需要2、3步，只能在内存中分页，做法也很简单，可以参考<a style="color: #336699; text-decoration: none; box-sizing: border-box" href="http://blog.csdn.net/ghsau/article/details/7243540">这篇文章</a>。</p><h1 style="margin: 0.8em 0px; padding: 0px; box-sizing: border-box; font-weight: 100; color: #333333; font-family: 'microsoft yahei'; line-height: 26px"><a style="color: #336699; box-sizing: border-box" name="t8"></a>总结</h1><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">全文的重点都在于搜索如何实现，更好的利用数据库的索引，两种搜索方式以百万数据量为分割线，第一种适用于百万以下，第二种适用于百万以上，未经过严格验证。可能有人会有疑问，过滤和排序都在应用层做，内存占用会不会很严重？这是个潜在问题，但大多数情况下不会。看我们大部分的应用场景，都是单一种类POI(Point Of Interest)的搜索，如酒店、美食、KTV、电影院等等，这种数据密度是很小，1公里内的酒店，能有多少家，50家都算多的，所以最终要看具体业务数据密度。本文没有分析原理，只讲了具体实现，有关分析的文章可以看参考链接。</p><hr style="box-sizing: border-box; margin: 2em 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-top-style: solid; border-top-color: rgba(128, 128, 128, 0.0980392); color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px" /><h1 style="margin: 0.8em 0px; padding: 0px; box-sizing: border-box; font-weight: 100; color: #333333; font-family: 'microsoft yahei'; line-height: 26px"><a style="color: #336699; box-sizing: border-box" name="t9"></a>参考</h1><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px"><a style="color: #336699; text-decoration: none; box-sizing: border-box" href="http://www.infoq.com/cn/articles/depth-study-of-Symfony2">http://www.infoq.com/cn/articles/depth-study-of-Symfony2</a>&nbsp;<br /><a style="color: #336699; text-decoration: none; box-sizing: border-box" href="http://tech.meituan.com/lucene-distance.html">http://tech.meituan.com/lucene-distance.html</a>&nbsp;<br /><a style="color: #336699; text-decoration: none; box-sizing: border-box" href="http://blog.csdn.net/liminlu0314/article/details/8553926">http://blog.csdn.net/liminlu0314/article/details/8553926</a>&nbsp;<br /><a style="color: #336699; text-decoration: none; box-sizing: border-box" href="http://janmatuschek.de/LatitudeLongitudeBoundingCoordinates">http://janmatuschek.de/LatitudeLongitudeBoundingCoordinates</a>&nbsp;<br /><a style="color: #336699; text-decoration: none; box-sizing: border-box" href="http://www.cnblogs.com/LBSer/p/3310455.html">http://www.cnblogs.com/LBSer/p/3310455.html</a>&nbsp;<br /><a style="color: #336699; text-decoration: none; box-sizing: border-box" href="http://cevin.net/geohash/">http://cevin.net/geohash/</a></p><p style="box-sizing: border-box; margin: 0px 0px 1.1em; color: #333333; font-family: 'microsoft yahei'; font-size: 14px; line-height: 26px">本文来自：<a style="color: #336699; text-decoration: none; box-sizing: border-box" href="http://blog.csdn.net/ghsau">高爽&#124;Coder</a>，原文地址：<a style="color: #336699; text-decoration: none; box-sizing: border-box" href="http://blog.csdn.net/ghsau/article/details/50591932">http://blog.csdn.net/ghsau/article/details/50591932</a>，转载请注明。</p>
]]>
</description>
</item><item>
<link>http://i.renjihe.com/blog/read.php?7520</link>
<title><![CDATA[DB主从一致性架构优化4种方法]]></title> 
<author>renjihe1988 &lt;admin@yourname.com&gt;</author>
<category><![CDATA[web]]></category>
<pubDate>Wed, 31 Aug 2016 12:29:22 +0000</pubDate> 
<guid>http://i.renjihe.com/blog/read.php?7520</guid> 
<description>
<![CDATA[ 
	<p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">需求缘起</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">大部分互联网的业务都是&ldquo;读多写少&rdquo;的场景，数据库层面，读性能往往成为瓶颈。如下图：业界通常采用&ldquo;一主多从，读写分离，冗余多个读库&rdquo;的数据库架构来提升数据库的读性能。</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe" align="center"><img style="max-width: 96%; height: auto; vertical-align: middle; border: 0px none; margin: 0px auto 10px; display: block" class="alignCenter" src="http://img1.tuicool.com/3uUjaue.png!web" border="0" /></p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">这种架构的一个潜在缺点是，业务方有可能读取到并不是最新的旧数据：</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe" align="center"><img style="max-width: 96%; height: auto; vertical-align: middle; border: 0px none; margin: 0px auto 10px; display: block" class="alignCenter" src="http://img1.tuicool.com/RJbMna.png!web" border="0" /></p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">（1）系统先对DB-master进行了一个写操作，写主库</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">（2）很短的时间内并发进行了一个读操作，读从库，此时主从同步没有完成，故读取到了一个旧数据</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">（3）主从同步完成</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">有没有办法解决或者缓解这类&ldquo;由于主从延时导致读取到旧数据&rdquo;的问题呢，这是本文要集中讨论的问题。</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">方案一（半同步复制）</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">不一致是因为写完成后，主从同步有一个时间差，假设是500ms，这个时间差有读请求落到从库上产生的。有没有办法做到，等主从同步完成之后，主库上的写请求再返回呢？答案是肯定的，就是大家常说的&ldquo;半同步复制&rdquo;semi-sync：</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe" align="center"><img style="max-width: 96%; height: auto; vertical-align: middle; border: 0px none; margin: 0px auto 10px; display: block" class="alignCenter" src="http://img0.tuicool.com/umEN7zR.png!web" border="0" /></p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">（1）系统先对DB-master进行了一个写操作，写主库</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">（2）等主从同步完成，写主库的请求才返回</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">（3）读从库，读到最新的数据（如果读请求先完成，写请求后完成，读取到的是&ldquo;当时&rdquo;最新的数据）</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">方案优点：利用数据库原生功能，比较简单</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">方案缺点：主库的写请求时延会增长，吞吐量会降低</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">方案二（强制读主库）</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">如果不使用&ldquo;增加从库&rdquo;的方式来增加提升系统的读性能，完全可以读写都落到主库，这样就不会出现不一致了：</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe" align="center"><img style="max-width: 96%; height: auto; vertical-align: middle; border: 0px none; margin: 0px auto 10px; display: block" class="alignCenter" src="http://img0.tuicool.com/umEN7zR.png!web" border="0" /></p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">方案优点：&ldquo;一致性&rdquo;上不需要进行系统改造</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">方案缺点：只能通过cache来提升系统的读性能，这里要进行系统改造</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">方案三（数据库中间件）</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">如果有了数据库中间件，所有的数据库请求都走中间件，这个主从不一致的问题可以这么解决：</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe" align="center"><img style="max-width: 96%; height: auto; vertical-align: middle; border: 0px none; margin: 0px auto 10px; display: block" class="alignCenter" src="http://img1.tuicool.com/ne6JFf7.png!web" border="0" /></p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">（1）所有的读写都走数据库中间件，通常情况下，写请求路由到主库，读请求路由到从库</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">（2）记录所有路由到写库的key，在经验主从同步时间窗口内（假设是500ms），如果有读请求访问中间件，此时有可能从库还是旧数据，就把这个key上的读请求路由到主库</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">（3）经验主从同步时间过完后，对应key的读请求继续路由到从库</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">方案优点：能保证绝对一致</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">方案缺点：数据库中间件的成本比较高</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">方案四（缓存记录写key法）</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">既然数据库中间件的成本比较高，有没有更低成本的方案来记录某一个库的某一个key上发生了写请求呢？很容易想到使用缓存，当写请求发生的时候：</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe" align="center"><img style="max-width: 96%; height: auto; vertical-align: middle; border: 0px none; margin: 0px auto 10px; display: block" class="alignCenter" src="http://img0.tuicool.com/IrYBVjq.png!web" border="0" /></p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">（1）将某个库上的某个key要发生写操作，记录在cache里，并设置&ldquo;经验主从同步时间&rdquo;的cache超时时间，例如500ms</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">（2）修改数据库</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">而读请求发生的时候：</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe" align="center"><img style="max-width: 96%; height: auto; vertical-align: middle; border: 0px none; margin: 0px auto 10px; display: block" class="alignCenter" src="http://img1.tuicool.com/iEZZJn6.png!web" border="0" /></p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">（1）先到cache里查看，对应库的对应key有没有相关数据</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">（2）如果cache hit，有相关数据，说明这个key上刚发生过写操作，此时需要将请求路由到主库读最新的数据</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">（3）如果cache miss，说明这个key上近期没有发生过写操作，此时将请求路由到从库，继续读写分离</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">方案优点：相对数据库中间件，成本较低</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">方案缺点：为了保证&ldquo;一致性&rdquo;，引入了一个cache组件，并且读写数据库时都多了一步cache操作</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">总结</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">为了解决主从数据库读取旧数据的问题，常用的方案有四种：</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">（1）半同步复制</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">（2）强制读主</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">（3）数据库中间件</p><p style="margin: 0px 0px 0.75em; font-size: 16px; line-height: 27.2px; text-indent: 1em; color: #333333; font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; background-color: #fefefe">（4）缓存记录写key</p>
]]>
</description>
</item><item>
<link>http://i.renjihe.com/blog/read.php?7519</link>
<title><![CDATA[DB主从一致性的几种解决方法]]></title> 
<author>renjihe1988 &lt;admin@yourname.com&gt;</author>
<category><![CDATA[web]]></category>
<pubDate>Wed, 31 Aug 2016 12:29:00 +0000</pubDate> 
<guid>http://i.renjihe.com/blog/read.php?7519</guid> 
<description>
<![CDATA[ 
	<div class="skin_center_t" style="box-sizing: border-box; margin: 0px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; vertical-align: baseline; color: #999999; font-family: Arial, sans-serif; line-height: 22px; background: transparent"><div class="skin_list" style="box-sizing: border-box; margin: 0px; padding: 0px 20px 0px 0px; border: 0px; outline: 0px; vertical-align: baseline; max-width: 1200px; background: transparent"><dl class="list_c clearfix detail_list" style="box-sizing: border-box; margin: 0px; padding: 0px 0px 5px; font-family: 'Microsoft YaHei'; list-style: none; border: 0px; outline: 0px; vertical-align: baseline; position: relative; background: transparent"><dd style="box-sizing: border-box; line-height: 1.42857; margin: 0px 0px 0px 95px; padding: 0px; list-style: none; border: 0px; outline: 0px; vertical-align: baseline; max-width: 1000px; background: transparent"><div id="article_content" class="skin_detail" style="box-sizing: border-box; margin: 0px; padding: 20px 0px; border: 0px; outline: 0px; vertical-align: baseline; word-break: break-word; background: transparent"><div class="markdown_views" style="box-sizing: border-box; margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: baseline; font-family: 'microsoft yahei'; background: transparent"><h1 style="box-sizing: border-box; margin: 0.8em 0px; font-size: 28px; font-family: 'Microsoft YaHei'; font-weight: 100; line-height: 30px; color: #666666; padding: 0px; border: 0px; outline: 0px; vertical-align: baseline; background: transparent">DB主从一致性的几种解决方法</h1><h2 style="box-sizing: border-box; font-family: 'Microsoft YaHei'; font-weight: 100; line-height: 1.1; color: #666666; margin: 0.8em 0px; font-size: 22px; padding: 0px; border: 0px; outline: 0px; vertical-align: baseline; background: transparent">起源</h2><p style="box-sizing: border-box; margin: 0px 0px 1.1em; padding: 0px; font-family: 'Microsoft YaHei'; border: 0px; outline: 0px; font-size: 15px; vertical-align: baseline; color: #666666; line-height: 26px; background: transparent">现在基本所有的程序中都会用到数据库，而数据库其实就是对所有业务逻辑处理结果的保存，所以不论在什么情况下数据的丢失都不被允许的，最坏的情况也要最小化数据的丢失程度，所以一般情况下，数据源都会至少配有两个节点，一个业务处理使用的节点，一个甚至多个从节点，这些从节点就是我们常说的冷备，业务处理节点（主节点）和备份节点一定的时间间隔内进行数据同步，从而来保证当一个数据源坏掉之后，数据也不会丢失，或着丢失很少（主要看同步的时间间隔）。但是为了提高资源的使用效率，所以有人就提出了，可不可以让冷备也被利用起来，替主节点分担部分压力，所以就提出了读写分离的方案。</p><h2 style="box-sizing: border-box; font-family: 'Microsoft YaHei'; font-weight: 100; line-height: 1.1; color: #666666; margin: 0.8em 0px; font-size: 22px; padding: 0px; border: 0px; outline: 0px; vertical-align: baseline; background: transparent">读写分离</h2><p style="box-sizing: border-box; margin: 0px 0px 1.1em; padding: 0px; font-family: 'Microsoft YaHei'; border: 0px; outline: 0px; font-size: 15px; vertical-align: baseline; color: #666666; line-height: 26px; background: transparent"><img style="box-sizing: border-box; border: 0px; vertical-align: middle; outline: 0px; margin: 0px; padding: 0px; max-width: 100%; background: transparent" src="http://img.blog.csdn.net/20160519201649725" border="0" alt="这里写图片描述" />&nbsp;<br />读写分离提高了资源的利用效率的同时也引出了一个问题，就是由于延时（网络传输，操作）而引起的数据库主从不一致的问题，对于这个问题，给一下集中解决方案。</p><hr style="box-sizing: border-box; height: 1px; margin: 2em 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-top-style: solid; border-top-color: rgba(128, 128, 128, 0.0980392); width: 999.188px; background-color: #eeeeee" /><h3 style="box-sizing: border-box; font-family: 'Microsoft YaHei'; font-weight: 100; line-height: 1.1; color: inherit; margin: 0.8em 0px; font-size: 14px; padding: 0px; border: 0px; outline: 0px; vertical-align: baseline; background: transparent">1-半同步复制</h3><p style="box-sizing: border-box; margin: 0px 0px 1.1em; padding: 0px; font-family: 'Microsoft YaHei'; border: 0px; outline: 0px; font-size: 15px; vertical-align: baseline; color: #666666; line-height: 26px; background: transparent">主从不一致的原因是延时引起的,所以要消除这个延时的影响，可以从主库进行CUD操作时进行规避，办法就是等主从同步完成之后，主库上的写请求再返回，就是大家常说的&ldquo;半同步复制&rdquo;semi-sync。</p><div class="sequence-diagram" style="box-sizing: border-box; margin: 0px 0px 1.1em; padding: 0px; border: 0px; outline: 0px; vertical-align: baseline; text-align: center; background: transparent">请求请求主库主库从库从库CUD操作开始同步同步完成CUD操作完成</div><ul style="box-sizing: border-box; margin: 0px 0px 22px; padding: 0px; font-family: 'Microsoft YaHei'; list-style: square inside; border: 0px; outline: 0px; vertical-align: baseline; background: transparent"><li style="box-sizing: border-box; margin: 0px; padding: 0px; list-style: none; border: 0px; outline: 0px; vertical-align: baseline; background: transparent"><strong style="box-sizing: border-box; margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: baseline; background: transparent">方案优点：利用数据库原生功能，比较简单</strong></li><li style="box-sizing: border-box; margin: 0px; padding: 0px; list-style: none; border: 0px; outline: 0px; vertical-align: baseline; background: transparent"><strong style="box-sizing: border-box; margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: baseline; background: transparent">方案缺点：主库的写请求时延会增长，吞吐量会降低</strong></li></ul><hr style="box-sizing: border-box; height: 1px; margin: 2em 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-top-style: solid; border-top-color: rgba(128, 128, 128, 0.0980392); width: 999.188px; background-color: #eeeeee" /><h3 style="box-sizing: border-box; font-family: 'Microsoft YaHei'; font-weight: 100; line-height: 1.1; color: inherit; margin: 0.8em 0px; font-size: 14px; padding: 0px; border: 0px; outline: 0px; vertical-align: baseline; background: transparent">2-数据库中间件</h3><h4 style="box-sizing: border-box; font-family: 'Microsoft YaHei'; font-weight: 100; line-height: 1.1; color: inherit; margin: 0.8em 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: baseline; background: transparent">CUD操作</h4><div class="sequence-diagram" style="box-sizing: border-box; margin: 0px 0px 1.1em; padding: 0px; border: 0px; outline: 0px; vertical-align: baseline; text-align: center; background: transparent">请求请求中间件中间件主库主库从库从库CUD操作路由同步</div><h4 style="box-sizing: border-box; font-family: 'Microsoft YaHei'; font-weight: 100; line-height: 1.1; color: inherit; margin: 0.8em 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: baseline; background: transparent">R操作</h4><div class="sequence-diagram" style="box-sizing: border-box; margin: 0px 0px 1.1em; padding: 0px; border: 0px; outline: 0px; vertical-align: baseline; text-align: center; background: transparent">请求请求中间件中间件主库主库从库从库R操作同步未完成同步完成</div><ul style="box-sizing: border-box; margin: 0px 0px 22px; padding: 0px; font-family: 'Microsoft YaHei'; list-style: square inside; border: 0px; outline: 0px; vertical-align: baseline; background: transparent"><li style="box-sizing: border-box; margin: 0px; padding: 0px; list-style: none; border: 0px; outline: 0px; vertical-align: baseline; background: transparent"><strong style="box-sizing: border-box; margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: baseline; background: transparent">方案优点：能保证绝对一致</strong></li><li style="box-sizing: border-box; margin: 0px; padding: 0px; list-style: none; border: 0px; outline: 0px; vertical-align: baseline; background: transparent"><strong style="box-sizing: border-box; margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: baseline; background: transparent">方案缺点：数据库中间件的成本比较高</strong></li></ul><hr style="box-sizing: border-box; height: 1px; margin: 2em 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-top-style: solid; border-top-color: rgba(128, 128, 128, 0.0980392); width: 999.188px; background-color: #eeeeee" /><h3 style="box-sizing: border-box; font-family: 'Microsoft YaHei'; font-weight: 100; line-height: 1.1; color: inherit; margin: 0.8em 0px; font-size: 14px; padding: 0px; border: 0px; outline: 0px; vertical-align: baseline; background: transparent">3-缓存记录写key法</h3><h4 style="box-sizing: border-box; font-family: 'Microsoft YaHei'; font-weight: 100; line-height: 1.1; color: inherit; margin: 0.8em 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: baseline; background: transparent">CUD操作</h4><p style="box-sizing: border-box; margin: 0px 0px 1.1em; padding: 0px; font-family: 'Microsoft YaHei'; border: 0px; outline: 0px; font-size: 15px; vertical-align: baseline; color: #666666; line-height: 26px; background: transparent">（1）将某个库上的某个key要发生写操作，记录在cache里，并设置&ldquo;经验主从同步时间&rdquo;的cache超时时间，例如500ms&nbsp;<br />（2）修改数据库</p><h4 style="box-sizing: border-box; font-family: 'Microsoft YaHei'; font-weight: 100; line-height: 1.1; color: inherit; margin: 0.8em 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: baseline; background: transparent">R操作</h4><p style="box-sizing: border-box; margin: 0px 0px 1.1em; padding: 0px; font-family: 'Microsoft YaHei'; border: 0px; outline: 0px; font-size: 15px; vertical-align: baseline; color: #666666; line-height: 26px; background: transparent">（1）先到cache里查看，对应库的对应key有没有相关数据&nbsp;<br />（2）如果cache hit，有相关数据，说明这个key上刚发生过写操作，此时需要将请求路由到主库读最新的数据&nbsp;<br />（3）如果cache miss，说明这个key上近期没有发生过写操作，此时将请求路由到从库，继续读写分离</p><ul style="box-sizing: border-box; margin: 0px 0px 22px; padding: 0px; font-family: 'Microsoft YaHei'; list-style: square inside; border: 0px; outline: 0px; vertical-align: baseline; background: transparent"><li style="box-sizing: border-box; margin: 0px; padding: 0px; list-style: none; border: 0px; outline: 0px; vertical-align: baseline; background: transparent"><strong style="box-sizing: border-box; margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: baseline; background: transparent">方案优点：相对数据库中间件，成本较低</strong></li><li style="box-sizing: border-box; margin: 0px; padding: 0px; list-style: none; border: 0px; outline: 0px; vertical-align: baseline; background: transparent"><strong style="box-sizing: border-box; margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: baseline; background: transparent">方案缺点：方案缺点：为了保证&ldquo;一致性&rdquo;，引入了一个cache组件，并且读写数据库时都多了一步cache操作</strong></li></ul></div></div></dd></dl></div><div class="skin_nav" style="box-sizing: border-box; margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: baseline; position: fixed; right: 275px; top: 70px; background: transparent"><div class="skin_edit" style="box-sizing: border-box; margin: 0px 0px 10px; padding: 0px; border: 2px solid #2f2f2f; outline: 0px; vertical-align: baseline; width: 28px; height: 28px; line-height: 24px; text-align: center; cursor: pointer; position: relative; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial"></div></div><div class="rssFix" style="box-sizing: border-box; margin: 0px; padding: 0px; border: 2px solid #2f2f2f; outline: 0px; vertical-align: baseline; width: 28px; height: 28px; text-align: center; line-height: 24px; position: fixed; bottom: 70px; right: 275px; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial"><a style="box-sizing: border-box; color: #444444; text-decoration: none; margin: 0px; padding: 0px; font-family: 'Microsoft YaHei'; outline: none; background: transparent" href="http://blog.csdn.net/xidiancyp/rss/list" class="column"></a></div></div><div class="detail_b" style="box-sizing: border-box; margin: 0px 0px 0px 95px; padding: 0px 60px 0px 0px; border: 0px; outline: 0px; font-size: 14px; vertical-align: baseline; max-width: 1250px; color: #999999; font-family: Arial, sans-serif; line-height: 22px; background: transparent"><p style="box-sizing: border-box; margin: 0px 0px 22px; padding: 0px; font-family: 'Microsoft YaHei'; border: 0px; outline: 0px; vertical-align: baseline; color: #e96d5b; background: transparent" class="reprint_copy">版权声明：本文为博主原创文章，未经博主允许不得转载。</p></div>
]]>
</description>
</item><item>
<link>http://i.renjihe.com/blog/read.php?7516</link>
<title><![CDATA[nodejs中Async库介绍]]></title> 
<author>renjihe1988 &lt;admin@yourname.com&gt;</author>
<category><![CDATA[web]]></category>
<pubDate>Mon, 29 Aug 2016 06:36:02 +0000</pubDate> 
<guid>http://i.renjihe.com/blog/read.php?7516</guid> 
<description>
<![CDATA[ 
	<p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">Async 地址：<a style="color: #999999; text-decoration: none; border-bottom-style: solid; border-bottom-width: 1px" href="https://github.com/caolan/async" target="_blank">https://github.com/caolan/async</a></p><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">Async的内容分为三部分：</p><ul style="font-size: 14px; padding: 0px; margin: 0px 0px 10px 25px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px"><li>流程控制：简化十种常见流程的处理</li><li>集合处理：如何使用异步操作处理集合中的数据</li><li>工具类：个常用的工具类</li></ul><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">本文介绍其中最简单最常用的流程控制部分。<br />由于nodejs是异步编程模型，有一些在同步编程中很容易做到的事情，现在却变得很麻烦。Async的流程控制就是为了简化这些操作。</p><h2 style="margin: 10px 0px; padding: 0px; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 40px; color: #333333; font-size: 20.5px"><a style="color: #ff9900" name="t0"></a>series(tasks, [callback]) （多个函数依次执行，之间没有数据交换）</h2><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">有多个异步函数需要依次调用，一个完成之后才能执行下一个。各函数之间没有数据的交换，仅仅需要保证其执行顺序。这时可使用series。<br />纯js代：</p><pre style="white-space: pre-wrap; word-wrap: break-word; padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: #333333; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; background-color: #f5f5f5">step1(function(err, v1) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; step2(function(err, v2) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; step3(function(err, v3) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // do somethig with the err or values v1/v2/v3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125; &#125;); </pre><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">从中可以看到这嵌套还是比较多深的，如果再多步，会更深。在代中忽略对了每一层err的处理，否则还都等上 if(err) return callback(err)，那就更麻烦了。<br />对于这种情况，使用async来处理，就是这的：</p><pre style="white-space: pre-wrap; word-wrap: break-word; padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: #333333; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; background-color: #f5f5f5">var async = require(&lsquo;async&rsquo;) async.series([step1, step2, step3], function(err, values) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // do somethig with the err or values v1/v2/v3 &#125;); </pre><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">可以看到代简洁了很多，而且自动处理每个回调中的错误。当然，这里只给出来最最简单的例子，在实际中，我们常会在每个step中执行一些操作，这时可写成：</p><pre style="white-space: pre-wrap; word-wrap: break-word; padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: #333333; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; background-color: #f5f5f5">var async = require(&lsquo;async&rsquo;) async.series([function(cb) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; step1(function(err, v1) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // do something with v1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cb(err, v1);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; function(cb) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; step2(...)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; function(cb) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; step3(...)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; function(err, values) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // do somethig with the err or values v1/v2/v3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;); </pre><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">该函数的详细解释为：<br />依次执行一个函数数组中的每个函数，每一个函数执行完成之后才能执行下一个函数。<br />如果任何一个函数向它的回调函数中了一个error，则后面的函数都不会被执行，并且将会立刻会将该error以及已经执行了的函数的结果，给series中最后那个callback。<br />当所有的函数执行完后（没有出错），则会把每个函数给其回调函数的结果合并为一个数组，给series最后的那个callback。<br />还可以json的形式来提供tasks。每一个属性都会被当作函数来执行，并且结果也会以json形式给series最后的那个callback。这种方式可读性更高一些。<br />具体例子可参考：https://github.com/freewind/async_demo/blob/master/series.js<br />其代中还包含了：<br />如果中间某个函数出错，series函数如何处理<br />如果某个函数给回调的值为undefined, null, &#123;&#125;, []等，series如何处理<br />另外还需要注意的是：多个series调用之间是不分先后的，为series本身也是异步调用。</p><h2 style="margin: 10px 0px; padding: 0px; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 40px; color: #333333; font-size: 20.5px"><a style="color: #ff9900" name="t1"></a>parallel(tasks, [callback]) （多个函数并行执行）</h2><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">并行执行多个函数，每个函数都是立即执行，不需要等待其它函数先执行。给最终callback的数组中的数据按照tasks中声明的顺序，而不是执行完成的顺序。<br />如果某个函数出错，则立刻将err和已经执行完的函数的结果值给parallel最终的callback。其它未执行完的函数的值不会到最终数据，但要个位置。<br />同时支持json形式的tasks，其最终callback的结果也为json形式。<br />示例代：</p><pre style="white-space: pre-wrap; word-wrap: break-word; padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: #333333; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; background-color: #f5f5f5">async.parallel([function(cb) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; t.fire('a400', cb, 400) &#125;, function(cb) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; t.fire('a200', cb, 200) &#125;, function(cb) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; t.fire('a300', cb, 300) &#125;], function(err, results) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log(&rsquo;1 err: &lsquo;, err); // -&gt; undefined&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log(&rsquo;1 results: &lsquo;, results); // -&gt;[ 'a400', 'a200', 'a300' ] &#125;); </pre><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">中途出错的示例：</p><pre style="white-space: pre-wrap; word-wrap: break-word; padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: #333333; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; background-color: #f5f5f5">async.parallel([function(cb) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log('1: ', 'start');&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; t.fire('a400', cb, 400) &#125;, // 该函数的值不会给最终callback，但要个位置 function(cb) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log('2: ', 'start');&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; t.err('e200', cb, 200) &#125;, function(cb) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log('3: ', 'start');&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; t.fire('a100', cb, 100) &#125;], function(err, results) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log(&rsquo;2 err: &lsquo;, err); // -&gt; e200&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log(&rsquo;2 results: &lsquo;, results); // -&gt; [ , undefined, 'a100' ] &#125;); </pre><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">以json形式入tasks</p><pre style="white-space: pre-wrap; word-wrap: break-word; padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: #333333; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; background-color: #f5f5f5">async.parallel(&#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; a: function(cb) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; t.fire(&lsquo;a400&prime;, cb, 400)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; b: function(cb) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; t.fire(&lsquo;c300&prime;, cb, 300)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125; &#125;, function(err, results) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log(&rsquo;3 err: &lsquo;, err); // -&gt; undefined&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log(&rsquo;3 results: &lsquo;, results); // -&gt; &#123; b: &lsquo;c300&prime;, a: &lsquo;a400&prime; &#125; &#125;); </pre><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">更详细示例参见：https://github.com/freewind/async_demo/blob/master/parallel.js</p><h2 style="margin: 10px 0px; padding: 0px; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 40px; color: #333333; font-size: 20.5px"><a style="color: #ff9900" name="t2"></a>waterfall(tasks, [callback]) （多个函数依次执行，且前一个的输出为后一个的输入）</h2><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">与seires相似，按顺序依次执行多个函数。不同之处，每一个函数产生的值，都将给下一个函数。如果中途出错，后面的函数将不会被执行。错误信息以及之前产生的结果，将给waterfall最终的callback。<br />这个函数名为waterfall(瀑布)，可以想像瀑布从上到下，中途冲过一层层突起的石头。注意，该函数不支持json式的tasks。</p><pre style="white-space: pre-wrap; word-wrap: break-word; padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: #333333; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; background-color: #f5f5f5">async.waterfall([function(cb) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log('1: ', 'start');&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cb(null, 3); &#125;, function(n, cb) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log('2: ', n);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; t.inc(n, cb); &#125;, function(n, cb) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log('3: ', n);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; t.fire(n * n, cb); &#125;], function(err, result) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log(&rsquo;1 err: &lsquo;, err); // -&gt; null&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log(&rsquo;1 result: &lsquo;, result); // -&gt; 16 &#125;); </pre><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">更详细示例参见：https://github.com/freewind/async_demo/blob/master/waterfall.js</p><h2 style="margin: 10px 0px; padding: 0px; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 40px; color: #333333; font-size: 20.5px"><a style="color: #ff9900" name="t3"></a>auto(tasks, [callback]) （多个函数有依赖关系，有的并行执行，有的依次执行）</h2><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">用来处理有依赖关系的多个任务的执行。比如某些任务之间彼此独立，可以并行执行；但某些任务依赖于其它某些任务，只能等那些任务完成后才能执行。<br />虽然我们可以使用async.parallel和async.series结合起来实现该功能，但如果任务之间关系复杂，则代会相当复杂，以后如果想添一个新任务，也会很麻烦。这时使用async.auto，则会事半功倍。<br />如果有任务中途出错，则会把该错误给最终callback，所有任务（包括已经执行完的）产生的数据将被忽略。<br />这里假设我要写一个程序，它要完成以下件事：<br />从某处取得数据<br />在硬盘上建立一个新的目录<br />将数据写入到目录下某文件<br />发送邮件，将文件以附件形式发送给其它人。<br />分析该任务，可以知道1与2可以并行执行，3需要等1和2完成，4要等3完成。</p><pre style="white-space: pre-wrap; word-wrap: break-word; padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: #333333; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; background-color: #f5f5f5">async.auto(&#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; getData: function(callback) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; setTimeout(function() &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&rsquo;1 : got data&rsquo;);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; callback();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 300);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; makeFolder: function(callback) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; setTimeout(function() &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&rsquo;1 : made folder&rsquo;);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; callback();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 200);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; writeFile: ['getData', 'makeFolder',&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; function(callback) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; setTimeout(function() &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log('1: wrote file');&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; callback(null, 'myfile');&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 300);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; emailFiles: ['writeFile',&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; function(callback, results) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log('1: emailed file: ', results.writeFile); // -&gt; myfile&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; callback(null, results.writeFile);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;] &#125;, function(err, results) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log(&rsquo;1 : err: &lsquo;, err); // -&gt; null&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log(&rsquo;1 : results: &lsquo;, results); // -&gt; &#123; makeFolder: undefined,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // getData: undefined,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // writeFile: &lsquo;myfile&rsquo;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // emailFiles: &lsquo;myfile&rsquo; &#125; &#125;); </pre><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">更多详细示例参见：https://github.com/freewind/async_demo/blob/master/auto.js</p><h2 style="margin: 10px 0px; padding: 0px; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 40px; color: #333333; font-size: 20.5px"><a style="color: #ff9900" name="t4"></a>whilst(test, fn, callback)（用可于异步调用的while）</h2><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">相当于while，但其中的异步调用将在完成后才会进行下一次循环。举例如下：</p><pre style="white-space: pre-wrap; word-wrap: break-word; padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: #333333; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; background-color: #f5f5f5">var count1 = 0; async.whilst(function() &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return count1 &lt; 3 &#125;, function(cb) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log(&rsquo;1 count: &lsquo;, count1);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; count1++;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; setTimeout(cb, 1000); &#125;, function(err) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // 3s have passed&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log(&rsquo;1 err: &lsquo;, err); // -&gt; undefined &#125;); </pre><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">它相当于：</p><pre style="white-space: pre-wrap; word-wrap: break-word; padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: #333333; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; background-color: #f5f5f5">try &#123;&nbsp;&nbsp;&nbsp;&nbsp; whilst(test) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fn();&nbsp;&nbsp;&nbsp;&nbsp; &#125;&nbsp;&nbsp;&nbsp;&nbsp; callback(); &#125; catch(err) &#123;&nbsp;&nbsp;&nbsp;&nbsp; callback(err); &#125; </pre><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">该函数的功能比较简单，条件变量通常定义在外面，可供每个函数访问。在循环中，异步调用时产生的值实际上被丢弃了，为最后那个callback只能入错误信息。<br />另外，第二个函数fn需要能接受一个函数cb，这个cb最终必须被执行，用于表示出错或正常结束。<br />更详细示例参见：https://github.com/freewind/async_demo/blob/master/whilst_until.js</p><h2 style="margin: 10px 0px; padding: 0px; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 40px; color: #333333; font-size: 20.5px"><a style="color: #ff9900" name="t5"></a>until(test, fn, callback) （与while相似，但判断条件相反）</h2><pre style="white-space: pre-wrap; word-wrap: break-word; padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: #333333; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; background-color: #f5f5f5">var count4 = 0;&nbsp;&nbsp;async.until(function() &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return count4 &gt; 3&nbsp;&nbsp;&#125;,&nbsp;&nbsp;function(cb) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log(&rsquo;4 count: &lsquo;, count4);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count4++;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setTimeout(cb, 200);&nbsp;&nbsp;&#125;,&nbsp;&nbsp;function(err) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// 4s have passed&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log(&rsquo;4 err: &lsquo;, err); // -&gt; undefined&nbsp;&nbsp;&#125;); </pre><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">当第一个函数条件为false时，继续执行第二个函数，否则跳出。</p><h2 style="margin: 10px 0px; padding: 0px; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 40px; color: #333333; font-size: 20.5px"><a style="color: #ff9900" name="t6"></a>queue （可设定worker数量的队列）</h2><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">queue相当于一个强版的parallel，主要是限制了worker数量，不再一次性全部执行。当worker数量不够用时，新入的任务将会排队等候，直到有新的worker可用。<br />该函数有多个点可供回调，如worker用完时、等候任务时、全部执行完时等。<br />定义一个queue，其worker数量为2，并在任务执行时，记录一下日志：</p><pre style="white-space: pre-wrap; word-wrap: break-word; padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: #333333; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; background-color: #f5f5f5">var q = async.queue(function(task, callback) &#123;&nbsp;&nbsp;&nbsp;&nbsp; log(&lsquo;worker is processing task: &lsquo;, task.name);&nbsp;&nbsp;&nbsp;&nbsp; task.run(callback); &#125;, 2); </pre><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">worker数量将用完时，会调用saturated函数：</p><pre style="white-space: pre-wrap; word-wrap: break-word; padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: #333333; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; background-color: #f5f5f5">q.saturated = function() &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log(&lsquo;all workers to be used&rsquo;);&nbsp;&nbsp;&nbsp;&nbsp;&#125; </pre><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">当最后一个任务交给worker执行时，会调用empty函数</p><pre style="white-space: pre-wrap; word-wrap: break-word; padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: #333333; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; background-color: #f5f5f5">q.empty = function() &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log(&lsquo;no more tasks wating&rsquo;);&nbsp;&nbsp;&nbsp;&nbsp;&#125; </pre><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">当所有任务都执行完时，会调用drain函数</p><pre style="white-space: pre-wrap; word-wrap: break-word; padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: #333333; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; background-color: #f5f5f5">q.drain = function() &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;console.log(&lsquo;all tasks have been processed&rsquo;);&nbsp;&nbsp;&nbsp;&nbsp;&#125; </pre><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">放入多个任务，可一次放一个，或一次放多个</p><pre style="white-space: pre-wrap; word-wrap: break-word; padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: #333333; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; background-color: #f5f5f5">q.push(&#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; name: &rsquo;t1&prime;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; run: function(cb) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log(&lsquo;t1 is running, waiting tasks: &lsquo;, q.length());&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; t.fire(&lsquo;t1&prime;, cb, 400); // 400ms后执行&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125; &#125;, function(err) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log(&lsquo;t1 executed&rsquo;); &#125;);&nbsp;&nbsp;q.push([&#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; name: 't3',&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; run: function(cb) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log('t3 is running, waiting tasks: ', q.length());&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; t.fire('t3', cb, 300); // 300ms后执行&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125; &#125;, &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; name: 't4',&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; run: function(cb) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log('t4 is running, waiting tasks: ', q.length());&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; t.fire('t4', cb, 500); // 500ms后执行&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125; &#125;], function(err) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log(&lsquo;t3 / 4 executed&rsquo;); &#125;); </pre><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">更多详细示例参见：https://github.com/freewind/async_demo/blob/master/queue.js</p><h2 style="margin: 10px 0px; padding: 0px; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 40px; color: #333333; font-size: 20.5px"><a style="color: #ff9900" name="t7"></a>iterator(tasks) （将个函数包装为iterator）</h2><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">将一组函数包装成为一个iterator，可通过next()得到以下一个函数为起点的新的iterator。该函数通常由async在内部使用，但如果需要时，也可在我们的代中使用它。</p><pre style="white-space: pre-wrap; word-wrap: break-word; padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: #333333; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; background-color: #f5f5f5">var iter = async.iterator([function() &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log('111') &#125;, function() &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log('222') &#125;, function() &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log('333') &#125;]); console.log(iter()); console.log(iter.next()); </pre><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">直接调用()，会执行当前函数，并返回一个由下个函数为起点的新的iterator。调用next()，不会执行当前函数，直接返回由下个函数为起点的新iterator。<br />对于同一个iterator，多次调用next()，不会影响自己。如果只剩下一个元，调用next()会返回null。<br />更详细示例参见：https://github.com/freewind/async_demo/blob/master/iterator.js</p><h2 style="margin: 10px 0px; padding: 0px; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 40px; color: #333333; font-size: 20.5px"><a style="color: #ff9900" name="t8"></a>apply(function, arguments..) （给函数预绑定参数）</h2><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">apply是一个非常好用的函数，可以让我们给一个函数预绑定多个参数并生成一个可直接调用的新函数，简化代。<br />对于函数：</p><pre style="white-space: pre-wrap; word-wrap: break-word; padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: #333333; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; background-color: #f5f5f5">function(callback) &#123; t.inc(3, callback); &#125; </pre><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">可以用apply改写为：</p><pre style="white-space: pre-wrap; word-wrap: break-word; padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: #333333; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; background-color: #f5f5f5">async.apply(t.inc, 3); </pre><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">还可以给某些函数预设值，得到一个新函数：</p><pre style="white-space: pre-wrap; word-wrap: break-word; padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: #333333; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; background-color: #f5f5f5">var log = async.apply(console.log, &quot;&gt;&quot;);&nbsp;&nbsp;&nbsp;&nbsp;log(&lsquo;hello&rsquo;);&nbsp;&nbsp;&nbsp;&nbsp;// &gt; hello </pre><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">更详细代参见：https://github.com/freewind/async_demo/blob/master/apply.js</p><h2 style="margin: 10px 0px; padding: 0px; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 40px; color: #333333; font-size: 20.5px"><a style="color: #ff9900" name="t9"></a>nextTick(callback) （在nodejs与浏览器两边行为一致）</h2><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">nextTick的作用与nodejs的nextTick一，都是把某个函数调用放在队列的尾部。但在浏览器端，只能使用setTimeout(callback,0)，但这个方法有时候会让其它高优先级的任务插到前面去。<br />所以提供了这个nextTick，让同的代在服务器端和浏览器端表现一致。</p><pre style="white-space: pre-wrap; word-wrap: break-word; padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: #333333; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; background-color: #f5f5f5">var calls = []; async.nextTick(function() &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; calls.push(&lsquo;two&rsquo;); &#125;); calls.push(&lsquo;one&rsquo;); async.nextTick(function() &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(calls); // -&gt; [ 'one', 'two' ] &#125;); </pre><p style="margin: 0px 0px 10px; padding: 0px; font-size: 14px; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">更详细代参见：https://github.com/freewind/async_demo/blob/master/nextTick.js</p><blockquote style="font-size: 14px; padding: 0px 0px 0px 15px; margin: 0px 0px 20px; border-left-width: 5px; border-left-style: solid; border-left-color: #eeeeee; color: #333333; font-family: Monaco, Menlo, Consolas, 'Courier New', 'Lucida Sans Unicode', 'Lucida Sans', 'Lucida Console', monospace; line-height: 20px">文章出处:&nbsp;<a style="color: #999999; text-decoration: none; border-bottom-style: dotted; border-bottom-width: 1px" href="http://my.oschina.net/huangsz/blog/176203" target="_blank">开源中国</a>&nbsp;<br />文章地址:&nbsp;<a style="color: #999999; text-decoration: none; border-bottom-style: solid; border-bottom-width: 1px" href="http://my.oschina.net/huangsz/blog/176203" target="_blank">http://my.oschina.net/huangsz/blog/176203</a>&nbsp;<br />本文地址:&nbsp;<a style="color: #999999; text-decoration: none; border-bottom-style: solid; border-bottom-width: 1px" href="http://www.webrube.com/node.js-web_rube/1468" target="_blank">http://www.webrube.com/node.js-web_rube/1468</a>&nbsp;<br />本文由&nbsp;<a style="color: #999999; text-decoration: none; border-bottom-style: dotted; border-bottom-width: 1px" href="http://www.webrube.com/" target="_blank" class="mini-icon">噜吧</a>&nbsp;整理，转载请保留以上信息; 如有侵犯您的版权, 请联系微信: 3715397 。</blockquote>
]]>
</description>
</item><item>
<link>http://i.renjihe.com/blog/read.php?7515</link>
<title><![CDATA[JS魔法堂：ES6新特性——GeneratorFunction介绍]]></title> 
<author>renjihe1988 &lt;admin@yourname.com&gt;</author>
<category><![CDATA[web]]></category>
<pubDate>Mon, 29 Aug 2016 06:35:39 +0000</pubDate> 
<guid>http://i.renjihe.com/blog/read.php?7515</guid> 
<description>
<![CDATA[ 
	<div id="cnblogs_post_body" style="margin: 0px 0px 20px; padding: 0px; word-break: break-word; color: #333333; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 25.2px"><p style="margin: 10px auto; padding: 0px"><span style="margin: 0px; padding: 0px; line-height: 1.8; font-size: 18px; background-color: #888888"><strong style="margin: 0px; padding: 0px">一、前言　　　　　　　　　　　　　　　　　　　　　　　　　　　&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br /></strong></span></p><p style="margin: 10px auto; padding: 0px">&nbsp; 第一次看koajs的示例时，发现该语句&nbsp;<span style="margin: 5px 0px; padding: 3px; border: 1px solid #cccccc; overflow: auto; line-height: 1.8; font-size: 12px !important; font-family: 'Courier New'; color: #000000; background-color: #f5f5f5" class="cnblogs_code">function *(next)&#123;...............&#125;</span>&nbsp;，这是啥啊？于是搜索一下，原来这是就是ES6的新特性Generator Function(生成器函数)。</p><p style="margin: 10px auto; padding: 0px">&nbsp; 那什么是生成器函数呢？其实就相当于C#2.0中通过yield关键字实现的迭代器的生成器（细节有所不同），那么理解的关键就在迭代器和yield关键字两部分了。下面将尝试从表象出发，逐步对生成器函数及利用它进行异步编程进行浅层的分析理解。</p><p style="margin: 10px auto; padding: 0px">&nbsp;</p><p style="margin: 10px auto; padding: 0px"><span style="margin: 0px; padding: 0px; line-height: 1.8; font-size: 18px; background-color: #888888"><strong style="margin: 0px; padding: 0px">二、表象&mdash;&mdash;语法及基本使用　　　　　　　　　　　　　　　　　　　&nbsp;&nbsp;&nbsp;<br /></strong></span></p><p style="margin: 10px auto; padding: 0px"><strong style="margin: 0px; padding: 0px">&nbsp;&nbsp;<span style="margin: 0px; padding: 0px; line-height: 1.8; font-size: 15px">示例：</span></strong></p><div class="cnblogs_code" style="margin: 5px 0px; padding: 5px; border: 1px solid #cccccc; overflow: auto; color: #000000; font-family: 'Courier New' !important; font-size: 12px !important; background-color: #f5f5f5"><div class="cnblogs_code_toolbar" style="margin: 5px 0px 0px; padding: 0px"><span style="margin: 0px; padding: 0px 5px 0px 0px; line-height: 1.8" class="cnblogs_code_copy"><a style="margin: 0px; padding: 0px; border: none !important" title="复制代码"><img style="margin: 0px; padding: 0px; max-width: 900px; border: none !important" src="http://common.cnblogs.com/images/copycode.gif" border="0" alt="复制代码" /></a></span></div><pre style="margin-top: 0px; margin-bottom: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New' !important; font-size: 12px !important"><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 定义生成器函数</span> function *<span style="margin: 0px; padding: 0px; line-height: 1.8">enumerable(msg)&#123;&nbsp;&nbsp; console.log(msg)&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> msg1 = <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">yield</span> msg + <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">&nbsp;&nbsp;after </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8">&nbsp;&nbsp; console.log(msg1)&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> msg2 = <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">yield</span> msg1 + <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000"> after</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span>&nbsp;&nbsp; <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">try</span><span style="margin: 0px; padding: 0px; line-height: 1.8">&#123;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> msg3 = <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">yield</span> msg2 + <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">after</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8">&nbsp;&nbsp;&nbsp;&nbsp; console.log(</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">ok</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8">)&nbsp;&nbsp; &#125;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">catch</span><span style="margin: 0px; padding: 0px; line-height: 1.8">(e)&#123;&nbsp;&nbsp;&nbsp;&nbsp; console.log(e)&nbsp;&nbsp; &#125;&nbsp;&nbsp; console.log(msg2 </span>+ <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000"> over</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8">) &#125;&nbsp;&nbsp;</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 初始化迭代器</span> <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> enumerator = enumerable(<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">hello</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8">) </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> ret = enumerator.next() <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 控制台显示 hello，ret的值&#123;value:'hello after',done:false&#125;</span> ret =&nbsp;&nbsp;enumerator.next(<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">world</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span>) <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 控制台显示 world，ret的值&#123;value:'world after',done:false&#125;</span> ret = enumerator.next(<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">game</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span>) <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 控制台显示game，ret的值&#123;value:'game after',done:false&#125; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 抛出异常信息</span> ret = enumerator.<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">throw</span>(<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">new</span> Error(<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">test</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span>)) <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 控制台显示new Error('test')信息，然后显示game over。ret的值为&#123;done:true&#125;&nbsp;&nbsp;</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> for...of语句</span> enumerator = enumerable(<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">hello</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8">) </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">for</span><span style="margin: 0px; padding: 0px; line-height: 1.8">(ret of enumerator)&nbsp;&nbsp; console.log(JSON.stringify(ret)); </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 控制台依次显示 </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> hello </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> &#123;value:'hello after',done:false&#125; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> world </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> &#123;value:'world after',done:false&#125; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> &#123;value:'game after',done:false&#125; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> game over </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> &#123;done:true&#125;</span></pre><div class="cnblogs_code_toolbar" style="margin: 5px 0px 0px; padding: 0px"><span style="margin: 0px; padding: 0px 5px 0px 0px; line-height: 1.8" class="cnblogs_code_copy"><a style="margin: 0px; padding: 0px; border: none !important" title="复制代码"><img style="margin: 0px; padding: 0px; max-width: 900px; border: none !important" src="http://common.cnblogs.com/images/copycode.gif" border="0" alt="复制代码" /></a></span></div></div><p style="margin: 10px auto; padding: 0px">&nbsp;</p><p style="margin: 10px auto; padding: 0px"><strong style="margin: 0px; padding: 0px">&nbsp;<span style="margin: 0px; padding: 0px; line-height: 1.8; font-size: 15px">&nbsp;1. 生成器语函数定义</span></strong></p><div class="cnblogs_code" style="margin: 5px 0px; padding: 5px; border: 1px solid #cccccc; overflow: auto; color: #000000; font-family: 'Courier New' !important; font-size: 12px !important; background-color: #f5f5f5"><pre style="margin-top: 0px; margin-bottom: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New' !important; font-size: 12px !important">function*<span style="margin: 0px; padding: 0px; line-height: 1.8"> test()&#123;&#125; function </span>*<span style="margin: 0px; padding: 0px; line-height: 1.8"> test()&#123;&#125; function </span>*<span style="margin: 0px; padding: 0px; line-height: 1.8">test()&#123;&#125; test </span>= function*<span style="margin: 0px; padding: 0px; line-height: 1.8"> ()&#123;&#125;&nbsp;&nbsp;test </span>= function *()&#123;&#125;</pre></div><p style="margin: 10px auto; padding: 0px">&nbsp; 普通函数添加*号后则成为了成为了生成器函数了。</p><div class="cnblogs_code" style="margin: 5px 0px; padding: 5px; border: 1px solid #cccccc; overflow: auto; color: #000000; font-family: 'Courier New' !important; font-size: 12px !important; background-color: #f5f5f5"><pre style="margin-top: 0px; margin-bottom: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New' !important; font-size: 12px !important">Object.prototype.toString.call(test) <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 显示[object GeneratorFunction]</span></pre></div><p style="margin: 10px auto; padding: 0px">&nbsp; 生成器函数的行为与普通函数并不相同，表现为如下3点：</p><p style="margin: 10px auto; padding: 0px">&nbsp; 1. 通过new运算符或函数调用的形式调用生成器函数，均会返回一个生成器实例；</p><p style="margin: 10px auto; padding: 0px">&nbsp; 2.&nbsp;通过new运算符或函数调用的形式调用生成器函数，均不会马上执行函数体的代码；</p><p style="margin: 10px auto; padding: 0px">&nbsp; 3. 必须调用生成器实例的next方法才会执行生成器函数体的代码。</p><div class="cnblogs_code" style="margin: 5px 0px; padding: 5px; border: 1px solid #cccccc; overflow: auto; color: #000000; font-family: 'Courier New' !important; font-size: 12px !important; background-color: #f5f5f5"><pre style="margin-top: 0px; margin-bottom: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New' !important; font-size: 12px !important">function *<span style="margin: 0px; padding: 0px; line-height: 1.8">say(msg)&#123;&nbsp;&nbsp; console.log(msg) &#125; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> gen = say(<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">hello world</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span>) <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 没有显示hello world</span> console.log(Object.prototype.toString.call(gen)) <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 显示[object Generator]</span> gen.next() <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 显示hello world</span></pre></div><p style="margin: 10px auto; padding: 0px"><span style="margin: 0px; padding: 0px; line-height: 1.8; font-size: 15px"><strong style="margin: 0px; padding: 0px">&nbsp; 2、 关键字yield&mdash;&mdash;迭代器生成器</strong></span></p><p style="margin: 10px auto; padding: 0px">&nbsp;&nbsp; 用于马上退出代码块并保留现场，当执行迭代器的next函数时，则能从退出点恢复现场并继续执行下去。下面有2点需要注意：</p><p style="margin: 10px auto; padding: 0px">&nbsp;&nbsp;&nbsp; 1. yield后面的表达式将作为迭代器next函数的返回值；</p><p style="margin: 10px auto; padding: 0px">&nbsp;&nbsp;&nbsp; 2. 迭代器next函数的入参将作为yield的返回值（有点像运算符）。</p><p style="margin: 10px auto; padding: 0px"><span style="margin: 0px; padding: 0px; line-height: 1.8; font-size: 15px"><strong style="margin: 0px; padding: 0px">&nbsp; 3、迭代器(Generator)</strong></span></p><p style="margin: 10px auto; padding: 0px">&nbsp; &nbsp; 迭代器是一个拥有&nbsp;<span style="margin: 5px 0px; padding: 3px; border: 1px solid #cccccc; overflow: auto; line-height: 1.8; font-size: 12px !important; font-family: 'Courier New'; color: #000000; background-color: #f5f5f5" class="cnblogs_code">&#123;value:&#123;*&#125;, done:&#123;Boolean&#125;&#125; next([*])方法</span>&nbsp;和&nbsp;<span style="margin: 5px 0px; padding: 3px; border: 1px solid #cccccc; overflow: auto; line-height: 1.8; font-size: 12px !important; font-family: 'Courier New'; color: #000000; background-color: #f5f5f5" class="cnblogs_code">&#123;undefined&#125;&nbsp;<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">throw</span>([*])方法</span>&nbsp;的对象，通过next函数不断执行以关键字yield分割的代码段，通过throw函数令yield分割的代码段抛出异常。</p><p style="margin: 10px auto; padding: 0px">&nbsp;</p><p style="margin: 10px auto; padding: 0px"><span style="margin: 0px; padding: 0px; line-height: 1.8; font-size: 18px; background-color: #888888"><strong style="margin: 0px; padding: 0px">三、核心1&mdash;&mdash;迭代器　　　　　　　　　　　　　　　　　　　　　&nbsp;&nbsp;<br /></strong></span></p><p style="margin: 10px auto; padding: 0px">&nbsp; 迭代器更多的是指迭代器模式，迭代器模式是指通过一个名为迭代器的对象按一定的规则遍历集合元素，调用者只需告诉迭代器获取下一个元素即可，而集合的类型、如何获取元素等因素均由具体的迭代器自行处理。（又一次地关注点分离！）并且由于迭代器模式可以做到 按需执行/延迟执行 的效果，因此能降低遍历无限序列时内存/栈溢出的问题，也能作为异步编程模式使用。</p><p style="margin: 10px auto; padding: 0px"><strong style="margin: 0px; padding: 0px">&nbsp; 模式理解的注意点：</strong></p><p style="margin: 10px auto; padding: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1. 迭代器每次进访问集合的一个元素，并由调用者发起访问请求时迭代器才执行下一次访问操作</p><p style="margin: 10px auto; padding: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2. &ldquo;按一定的规则&rdquo;，意味着不一定遍历集合中所有的元素，并且规则可以内聚到迭代器的具体实现上，也可通过策略模式外移到其他模块中；</p><p style="margin: 10px auto; padding: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3. &ldquo;集合&rdquo;，集合可以是一开始就已经初始化好的有限序列集合（如[1,2,3,4,5,6,7]），也可以是按需生成的无限序列集合（如1到无限大）</p><p style="margin: 10px auto; padding: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4. &ldquo;集合元素&rdquo;，可以是整数集合、字符串集合等数据集合，也可以是函数等指令+数据的集合；</p><p style="margin: 10px auto; padding: 0px">&nbsp; 若触过C#、Java等服务端语句的朋友应该对迭代器有一定程度的了解，C#的IEnumrable、IEnumerator和Java的Iterable、Iterator就是跟迭代器相关的接口定义，继承上述接口的迭代器实现均可以通过foreach或for...in语句作循环操作。</p><p style="margin: 10px auto; padding: 0px"><strong style="margin: 0px; padding: 0px">&nbsp; 那么这里有2点是要注意的：</strong></p><p style="margin: 10px auto; padding: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1. 迭代器是指设计模式，跟具体的语言无关，因此所有语言均可根据该模式实现具体的迭代器；</p><p style="margin: 10px auto; padding: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2. foreach或for...in语句是语法层面的支持，跟迭代器模式没有必然联系。（若语法层面不支持，那函数式编程中的递归的效果是一样的，假如编译器/解析器支持尾递归则更好了，可以JS不支持）</p><p style="margin: 10px auto; padding: 0px">&nbsp; 下面我们通过迭代器来实现Python中的range函数，并通过range函数创建一个超大的有限序列正整数集合（直接用数组的话绝有可能导致栈溢出哦！）。</p><div class="cnblogs_code" style="margin: 5px 0px; padding: 5px; border: 1px solid #cccccc; overflow: auto; color: #000000; font-family: 'Courier New' !important; font-size: 12px !important; background-color: #f5f5f5"><div class="cnblogs_code_toolbar" style="margin: 5px 0px 0px; padding: 0px"><span style="margin: 0px; padding: 0px 5px 0px 0px; line-height: 1.8" class="cnblogs_code_copy"><a style="margin: 0px; padding: 0px; border: none !important" title="复制代码"><img style="margin: 0px; padding: 0px; max-width: 900px; border: none !important" src="http://common.cnblogs.com/images/copycode.gif" border="0" alt="复制代码" /></a></span></div><pre style="margin-top: 0px; margin-bottom: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New' !important; font-size: 12px !important"><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 迭代器构造函数</span> <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> RangeIterator =<span style="margin: 0px; padding: 0px; line-height: 1.8"> function(start,end,scan)&#123;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">this</span>.start = arguments.length &gt;= <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800080">2</span> ? start : <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800080">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">this</span>.end = end == undefined ?<span style="margin: 0px; padding: 0px; line-height: 1.8"> start : end&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">this</span>.scan = scan &#124;&#124; <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800080">1</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">this</span>.idx = <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">this</span><span style="margin: 0px; padding: 0px; line-height: 1.8">.start &#125; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 向迭代器发起访问下一个元素的请求 </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> FF和ES6下迭代器接口规范定义了迭代器必须通过名为next的函数发起访问下一个元素的请求</span> RangeIterator.prototype.next =<span style="margin: 0px; padding: 0px; line-height: 1.8"> function()&#123;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">if</span> (<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">this</span>.idx &gt; <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">this</span><span style="margin: 0px; padding: 0px; line-height: 1.8">.end)&nbsp;&nbsp;　　　　</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">if</span> (!!<span style="margin: 0px; padding: 0px; line-height: 1.8">StopIteration) &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;　　</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">throw</span><span style="margin: 0px; padding: 0px; line-height: 1.8"> StopIteration&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#125;</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">else</span><span style="margin: 0px; padding: 0px; line-height: 1.8">&#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">return</span> <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">void</span> <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800080">0</span><span style="margin: 0px; padding: 0px; line-height: 1.8">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#125;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> ret = <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">this</span><span style="margin: 0px; padding: 0px; line-height: 1.8">.idx&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">this</span>.idx += <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">this</span><span style="margin: 0px; padding: 0px; line-height: 1.8">.scan&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">return</span><span style="margin: 0px; padding: 0px; line-height: 1.8"> ret &#125; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> Python中的range函数</span> <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> range =<span style="margin: 0px; padding: 0px; line-height: 1.8"> function(start, end, scan)&#123;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> iterator = <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">new</span><span style="margin: 0px; padding: 0px; line-height: 1.8"> RangeIterator(start, end, scan)&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">return</span><span style="margin: 0px; padding: 0px; line-height: 1.8"> &#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> FF下令for...in语句调用对象的迭代器的接口规范</span> <span style="margin: 0px; padding: 0px; line-height: 1.8">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__iterator__: function()&#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">return</span><span style="margin: 0px; padding: 0px; line-height: 1.8"> iterator&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 暴露迭代器的next函数</span> <span style="margin: 0px; padding: 0px; line-height: 1.8">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next: function()&#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">return</span><span style="margin: 0px; padding: 0px; line-height: 1.8"> iterator.next()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; toString: function()&#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 可能会导致栈溢出</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> array =<span style="margin: 0px; padding: 0px; line-height: 1.8"> []&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">for</span> (<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> i = <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">this</span>.next(); i != <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">void</span> <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800080">0</span>; i = <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">this</span><span style="margin: 0px; padding: 0px; line-height: 1.8">.next())&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; array.push(i)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">return</span> array + <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">''</span><span style="margin: 0px; padding: 0px; line-height: 1.8">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125; &#125; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> r = range(<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800080">1</span>, <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800080">100000000000000000000</span><span style="margin: 0px; padding: 0px; line-height: 1.8">) </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> FF下 </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 参考：</span><span style="margin: 0px; padding: 0px; line-height: 1.8; text-decoration: underline; color: #008000">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Iterators_and_Generators</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">#.E5.AE.9A.E4.B9.89.E8.87.AA.E5.AE.9A.E4.B9.89.E8.BF.AD.E4.BB.A3.E5.99.A8</span> <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">for</span>(<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> i <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">in</span><span style="margin: 0px; padding: 0px; line-height: 1.8"> r)&nbsp;&nbsp; console.log(i) </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 显示1到99999999999999999999 </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 所有浏览器</span> <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">for</span> (<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> i = r.next(); i != <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">void</span> <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800080">0</span>; i =<span style="margin: 0px; padding: 0px; line-height: 1.8"> r.next())&nbsp;&nbsp; console.log(i) </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 显示1到99999999999999999999</span></pre><div class="cnblogs_code_toolbar" style="margin: 5px 0px 0px; padding: 0px"><span style="margin: 0px; padding: 0px 5px 0px 0px; line-height: 1.8" class="cnblogs_code_copy"><a style="margin: 0px; padding: 0px; border: none !important" title="复制代码"><img style="margin: 0px; padding: 0px; max-width: 900px; border: none !important" src="http://common.cnblogs.com/images/copycode.gif" border="0" alt="复制代码" /></a></span></div></div><p style="margin: 10px auto; padding: 0px">&nbsp; 由于JS是单线程运行，并且当UI线程被阻塞N秒后，浏览器会询问是否停止脚本的执行，但上述代码并不会由于序列过大造成栈溢出的问题。假如预先生成1到<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #000000">99999999999999999999或更大数字</span>的数组，那很有可能造成stack overflow。那是由于迭代器实质为一状态机，而调用next函数则是触发状态的转换，而状态机中同一时刻用于存放变量的存储空间固定，并不会出现无限增长的情况。</p><p style="margin: 10px auto; padding: 0px">&nbsp;</p><p style="margin: 10px auto; padding: 0px"><span style="margin: 0px; padding: 0px; line-height: 1.8; font-size: 18px; background-color: #888888"><strong style="margin: 0px; padding: 0px">四、核心2&mdash;&mdash;yield关键字　　　　　　　　　　　　　　　　　　&nbsp;&nbsp;<br /></strong></span></p><p style="margin: 10px auto; padding: 0px">&nbsp;&nbsp; 回到关键字yield上了，其实yield关键字就是以一种更直观、便捷的方式让我们创建用于遍历有限序列集合的迭代器，而yield则用于将生成器函数的代码切片作为有限序列集合的元素（元素的类型为指令+数据，而不仅仅是数据而已）。下面我们一起看看yield关键字是怎样对代码切片的吧！</p><div class="cnblogs_code" style="margin: 5px 0px; padding: 5px; border: 1px solid #cccccc; overflow: auto; color: #000000; font-family: 'Courier New' !important; font-size: 12px !important; background-color: #f5f5f5"><div class="cnblogs_code_toolbar" style="margin: 5px 0px 0px; padding: 0px"><span style="margin: 0px; padding: 0px 5px 0px 0px; line-height: 1.8" class="cnblogs_code_copy"><a style="margin: 0px; padding: 0px; border: none !important" title="复制代码"><img style="margin: 0px; padding: 0px; max-width: 900px; border: none !important" src="http://common.cnblogs.com/images/copycode.gif" border="0" alt="复制代码" /></a></span></div><pre style="margin-top: 0px; margin-bottom: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New' !important; font-size: 12px !important"><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 定义生成器函数</span> function *<span style="margin: 0px; padding: 0px; line-height: 1.8">enumerable(msg)&#123;&nbsp;&nbsp; console.log(msg)&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> msg1 = <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">yield</span> msg + <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">&nbsp;&nbsp;after </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8">&nbsp;&nbsp; console.log(msg1)&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> msg2 = <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">yield</span> msg1 + <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000"> after</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8">&nbsp;&nbsp; console.log(msg2 </span>+ <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000"> over</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8">) &#125;</span></pre><div class="cnblogs_code_toolbar" style="margin: 5px 0px 0px; padding: 0px"><span style="margin: 0px; padding: 0px 5px 0px 0px; line-height: 1.8" class="cnblogs_code_copy"><a style="margin: 0px; padding: 0px; border: none !important" title="复制代码"><img style="margin: 0px; padding: 0px; max-width: 900px; border: none !important" src="http://common.cnblogs.com/images/copycode.gif" border="0" alt="复制代码" /></a></span></div></div><p style="margin: 10px auto; padding: 0px">&nbsp; 上述代码最终会被解析为下面的代码：</p><div class="cnblogs_code" style="margin: 5px 0px; padding: 5px; border: 1px solid #cccccc; overflow: auto; color: #000000; font-family: 'Courier New' !important; font-size: 12px !important; background-color: #f5f5f5"><div class="cnblogs_code_toolbar" style="margin: 5px 0px 0px; padding: 0px"><span style="margin: 0px; padding: 0px 5px 0px 0px; line-height: 1.8" class="cnblogs_code_copy"><a style="margin: 0px; padding: 0px; border: none !important" title="复制代码"><img style="margin: 0px; padding: 0px; max-width: 900px; border: none !important" src="http://common.cnblogs.com/images/copycode.gif" border="0" alt="复制代码" /></a></span></div><pre style="margin-top: 0px; margin-bottom: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New' !important; font-size: 12px !important"><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> enumerable =<span style="margin: 0px; padding: 0px; line-height: 1.8"> function(msg)&#123;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> state = -<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800080">1</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">return</span><span style="margin: 0px; padding: 0px; line-height: 1.8"> &#123;&nbsp;&nbsp;&nbsp;&nbsp; next: function(val)&#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">switch</span>(++<span style="margin: 0px; padding: 0px; line-height: 1.8">state)&#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">case</span> <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800080">0</span><span style="margin: 0px; padding: 0px; line-height: 1.8">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(msg </span>+ <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000"> after</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8">)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">break</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">case</span> <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800080">1</span><span style="margin: 0px; padding: 0px; line-height: 1.8">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> msg1 =<span style="margin: 0px; padding: 0px; line-height: 1.8"> val&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(msg1 </span>+ <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000"> after</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8">)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">break</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">case</span> <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800080">2</span><span style="margin: 0px; padding: 0px; line-height: 1.8">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> msg2 =<span style="margin: 0px; padding: 0px; line-height: 1.8"> val&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(msg2 </span>+ <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000"> over</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8">)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">break</span><span style="margin: 0px; padding: 0px; line-height: 1.8">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;&nbsp;&nbsp;&nbsp;&nbsp; &#125;&nbsp;&nbsp; &#125; &#125;</span></pre><div class="cnblogs_code_toolbar" style="margin: 5px 0px 0px; padding: 0px"><span style="margin: 0px; padding: 0px 5px 0px 0px; line-height: 1.8" class="cnblogs_code_copy"><a style="margin: 0px; padding: 0px; border: none !important" title="复制代码"><img style="margin: 0px; padding: 0px; max-width: 900px; border: none !important" src="http://common.cnblogs.com/images/copycode.gif" border="0" alt="复制代码" /></a></span></div></div><p style="margin: 10px auto; padding: 0px">(注意：上述仅仅简单的分析，更复杂的情况（条件控制、循环、迭代、异常捕获处理等）可以参考@赵劼的<a style="margin: 0px; padding: 0px; text-decoration: none; color: #000000; border-bottom-width: 1px; border-bottom-style: dotted; border-bottom-color: #333333" href="http://blog.zhaojie.me/2010/01/decompile-methods-with-yield-manually.html" target="_blank">《人肉反编译使用关键字yield的方法》</a>)</p><p style="margin: 10px auto; padding: 0px">&nbsp;</p><p style="margin: 10px auto; padding: 0px">&nbsp;<span style="margin: 0px; padding: 0px; line-height: 1.8; font-size: 18px; background-color: #888888"><strong style="margin: 0px; padding: 0px">五、异步调用中的应用　　　　　　　　　　　　　　　　　　　 &nbsp; &nbsp;</strong></span></p><p style="margin: 10px auto; padding: 0px"><span style="margin: 0px; padding: 0px; line-height: 1.8; font-size: 15px">&nbsp; 由于迭代器模式实现 延迟执行/按需执行，因此可作为一种异步编程模式来应用。</span></p><div class="cnblogs_code" style="margin: 5px 0px; padding: 5px; border: 1px solid #cccccc; overflow: auto; color: #000000; font-family: 'Courier New' !important; font-size: 12px !important; background-color: #f5f5f5"><div class="cnblogs_code_toolbar" style="margin: 5px 0px 0px; padding: 0px"><span style="margin: 0px; padding: 0px 5px 0px 0px; line-height: 1.8" class="cnblogs_code_copy"><a style="margin: 0px; padding: 0px; border: none !important" title="复制代码"><img style="margin: 0px; padding: 0px; max-width: 900px; border: none !important" src="http://common.cnblogs.com/images/copycode.gif" border="0" alt="复制代码" /></a></span></div><pre style="margin-top: 0px; margin-bottom: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New' !important; font-size: 12px !important"><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> iterator = getArticles(<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">dummy.json</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8">) </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 开始执行</span> <span style="margin: 0px; padding: 0px; line-height: 1.8">iterator.next() </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 异步任务模型</span> <span style="margin: 0px; padding: 0px; line-height: 1.8">function getData(src)&#123;&nbsp;&nbsp; setTimeout(function()&#123;&nbsp;&nbsp;&nbsp;&nbsp; iterator.next(&#123;tpl: </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">tpl.html</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span>, name: <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">fsjohnhuang</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8">&#125;)&nbsp;&nbsp; &#125;, </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800080">1000</span><span style="margin: 0px; padding: 0px; line-height: 1.8">) &#125; function getTpl(tpl)&#123;&nbsp;&nbsp; setTimeout(function()&#123;&nbsp;&nbsp;&nbsp;&nbsp; iterator.next(</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">hello $&#123;name&#125;</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8">)&nbsp;&nbsp; &#125;, </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800080">3000</span><span style="margin: 0px; padding: 0px; line-height: 1.8">) &#125;<br />// 同步任务 function render(data, tpl)&#123;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">return</span> tpl.replace(/&#92;$&#92;&#123;(&#92;w+)&#92;&#125;/<span style="margin: 0px; padding: 0px; line-height: 1.8">, function()&#123;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">return</span> data[arguments[<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800080">1</span>]] ==&nbsp;&nbsp;<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">void</span> <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800080">0</span> ? arguments[<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800080">0</span>] : data[arguments[<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800080">1</span><span style="margin: 0px; padding: 0px; line-height: 1.8">]]&nbsp;&nbsp; &#125;) &#125;&nbsp;&nbsp;</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 主逻辑</span> function *<span style="margin: 0px; padding: 0px; line-height: 1.8">getAritcles(src)&#123;&nbsp;&nbsp; console.log(</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">begin</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8">)&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> data = <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">yield</span><span style="margin: 0px; padding: 0px; line-height: 1.8"> getData(src)&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> tpl = <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">yield</span><span style="margin: 0px; padding: 0px; line-height: 1.8"> getTpl(data.tpl)&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> res =<span style="margin: 0px; padding: 0px; line-height: 1.8"> render(data, tpl)&nbsp;&nbsp; console.log(rest) &#125;</span></pre><div class="cnblogs_code_toolbar" style="margin: 5px 0px 0px; padding: 0px"><span style="margin: 0px; padding: 0px 5px 0px 0px; line-height: 1.8" class="cnblogs_code_copy"><a style="margin: 0px; padding: 0px; border: none !important" title="复制代码"><img style="margin: 0px; padding: 0px; max-width: 900px; border: none !important" src="http://common.cnblogs.com/images/copycode.gif" border="0" alt="复制代码" /></a></span></div></div><p style="margin: 10px auto; padding: 0px">&nbsp; 主逻辑中异步调用的写法与同步调用的基本没差异了，爽了吧！但异步任务模型与生成器函数及其生成的迭代器耦合性太大，还是不太好用。下面我们通过实现了Promises/A+规范的Q来进一步解耦。</p><p style="margin: 10px auto; padding: 0px">&nbsp; 若执行引擎不支持关键字yield，那么上述代码不就无法执行了吗？还是那句话，yield关键字其实就是语法糖，最终还是会被解析为一个迭代器。因此我们自行实现一个迭代器也是能实现上述效果的，不过过程会繁琐很多（若如第2节的示例那样存在try...catch语句，就繁琐死了@~@），并且代码的整洁性、可维护性就全靠攻城狮来保证了。（语法糖从语法层面简化编程和维护难度，但理解底层的工作原理也十分重要哦！）</p><p style="margin: 10px auto; padding: 0px">&nbsp;</p><p style="margin: 10px auto; padding: 0px"><span style="margin: 0px; padding: 0px; line-height: 1.8; font-size: 18px; background-color: #888888"><strong style="margin: 0px; padding: 0px">六、与Q结合　　　　　　　　　　　　　　　　　　　　　　　　</strong></span></p><div class="cnblogs_code" style="margin: 5px 0px; padding: 5px; border: 1px solid #cccccc; overflow: auto; color: #000000; font-family: 'Courier New' !important; font-size: 12px !important; background-color: #f5f5f5"><div class="cnblogs_code_toolbar" style="margin: 5px 0px 0px; padding: 0px"><span style="margin: 0px; padding: 0px 5px 0px 0px; line-height: 1.8" class="cnblogs_code_copy"><a style="margin: 0px; padding: 0px; border: none !important" title="复制代码"><img style="margin: 0px; padding: 0px; max-width: 900px; border: none !important" src="http://common.cnblogs.com/images/copycode.gif" border="0" alt="复制代码" /></a></span></div><pre style="margin-top: 0px; margin-bottom: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New' !important; font-size: 12px !important"><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 异步任务模型</span> <span style="margin: 0px; padding: 0px; line-height: 1.8">function getData(src)&#123;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> deferred =<span style="margin: 0px; padding: 0px; line-height: 1.8"> Q.defer()&nbsp;&nbsp; setTimeout(function()&#123;&nbsp;&nbsp;&nbsp;&nbsp;defer.resolve(&#123;tpl: </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">tpl.html</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span>, name: <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">fsjohnhuang</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8">&#125;)&nbsp;&nbsp; &#125;, </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800080">1000</span><span style="margin: 0px; padding: 0px; line-height: 1.8">)&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">return</span><span style="margin: 0px; padding: 0px; line-height: 1.8"> deferred.promise &#125; function getTpl(tpl)&#123;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> deferred =<span style="margin: 0px; padding: 0px; line-height: 1.8"> Q.defer()&nbsp;&nbsp; setTimeout(function()&#123;&nbsp;&nbsp;&nbsp;&nbsp;defer.resolve(</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">hello $&#123;name&#125;</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8">)&nbsp;&nbsp; &#125;, </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800080">3000</span><span style="margin: 0px; padding: 0px; line-height: 1.8">)&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">return</span><span style="margin: 0px; padding: 0px; line-height: 1.8"> deferred.promise &#125; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 同步任务</span> <span style="margin: 0px; padding: 0px; line-height: 1.8">function render(data, tpl)&#123;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">return</span> tpl.replace(/&#92;$&#92;&#123;(&#92;w+)&#92;&#125;/<span style="margin: 0px; padding: 0px; line-height: 1.8">, function()&#123;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">return</span> data[arguments[<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800080">1</span>]] ==&nbsp;&nbsp;<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">void</span> <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800080">0</span> ? arguments[<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800080">0</span>] : data[arguments[<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800080">1</span><span style="margin: 0px; padding: 0px; line-height: 1.8">]]&nbsp;&nbsp; &#125;) &#125;&nbsp;&nbsp;</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 主逻辑</span> Q.<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">async</span>(function *<span style="margin: 0px; padding: 0px; line-height: 1.8">()&#123;&nbsp;&nbsp; console.log(</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">begin</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8">)&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> data = <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">yield</span> getData(<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">dummy.json</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8">)&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> tpl = <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">yield</span><span style="margin: 0px; padding: 0px; line-height: 1.8"> getTpl(data.tpl)&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> res =<span style="margin: 0px; padding: 0px; line-height: 1.8"> render(data, tpl)&nbsp;&nbsp; console.log(rest) &#125;)</span></pre><div class="cnblogs_code_toolbar" style="margin: 5px 0px 0px; padding: 0px"><span style="margin: 0px; padding: 0px 5px 0px 0px; line-height: 1.8" class="cnblogs_code_copy"><a style="margin: 0px; padding: 0px; border: none !important" title="复制代码"><img style="margin: 0px; padding: 0px; max-width: 900px; border: none !important" src="http://common.cnblogs.com/images/copycode.gif" border="0" alt="复制代码" /></a></span></div></div><p style="margin: 10px auto; padding: 0px">&nbsp; 暂未阅读Q的源代码，暂不作详细分析。反正API就这样用，呵呵！</p><p style="margin: 10px auto; padding: 0px">&nbsp;</p><p style="margin: 10px auto; padding: 0px"><span style="margin: 0px; padding: 0px; line-height: 1.8; font-size: 18px; background-color: #888888"><strong style="margin: 0px; padding: 0px">七、与iPromise结合　　　　　　　　　　　　　　　　　　　　</strong></span></p><p style="margin: 10px auto; padding: 0px">&nbsp; iPromise是我开发的一个Promises/A+的完整实现，阅读源码你会发现它继承了jQuery.Deferred1.5~2.1、jsDeferred、mmDeferred和Promises/A官网实现示例的精妙设计，并且从v0.0.6开始支持ES6特性GeneratorFunction。使用示例如下：</p><div class="cnblogs_code" style="margin: 5px 0px; padding: 5px; border: 1px solid #cccccc; overflow: auto; color: #000000; font-family: 'Courier New' !important; font-size: 12px !important; background-color: #f5f5f5"><div class="cnblogs_code_toolbar" style="margin: 5px 0px 0px; padding: 0px"><span style="margin: 0px; padding: 0px 5px 0px 0px; line-height: 1.8" class="cnblogs_code_copy"><a style="margin: 0px; padding: 0px; border: none !important" title="复制代码"><img style="margin: 0px; padding: 0px; max-width: 900px; border: none !important" src="http://common.cnblogs.com/images/copycode.gif" border="0" alt="复制代码" /></a></span></div><pre style="margin-top: 0px; margin-bottom: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New' !important; font-size: 12px !important"><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> getData =<span style="margin: 0px; padding: 0px; line-height: 1.8"> function(dataSrc)&#123;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">return</span><span style="margin: 0px; padding: 0px; line-height: 1.8"> iPromise(function(r)&#123;&nbsp;&nbsp;&nbsp;&nbsp; setTimeout(function()&#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r(dataSrc </span>+ <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000"> has loaded</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8">)&nbsp;&nbsp;&nbsp;&nbsp; &#125;, </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800080">1000</span><span style="margin: 0px; padding: 0px; line-height: 1.8">)&nbsp;&nbsp; &#125;) &#125; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> getTpl =<span style="margin: 0px; padding: 0px; line-height: 1.8"> function(tplSrc)&#123;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">return</span><span style="margin: 0px; padding: 0px; line-height: 1.8"> iPromise(function(r)&#123;&nbsp;&nbsp;&nbsp;&nbsp; setTimeout(function()&#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r(tplStr </span>+ <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000"> has loaded</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8">)&nbsp;&nbsp;&nbsp;&nbsp; &#125;, </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800080">2000</span><span style="margin: 0px; padding: 0px; line-height: 1.8">)&nbsp;&nbsp; &#125;) &#125; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> render =<span style="margin: 0px; padding: 0px; line-height: 1.8"> function(data, tpl)&#123;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">throw</span> <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">new</span> Error(<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">OMG!</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8">) &#125;<br /> iPromise(function </span>*<span style="margin: 0px; padding: 0px; line-height: 1.8">(dataSrc, tplSrc)&#123;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">try</span><span style="margin: 0px; padding: 0px; line-height: 1.8">&#123;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> data = <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">yield</span><span style="margin: 0px; padding: 0px; line-height: 1.8"> getData(dataSrc)&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> tpl = <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">yield</span><span style="margin: 0px; padding: 0px; line-height: 1.8"> getTpl(tplSrc)&nbsp;&nbsp;&nbsp;&nbsp; render(data, tpl)&nbsp;&nbsp; &#125;&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">catch</span><span style="margin: 0px; padding: 0px; line-height: 1.8">(e)&#123;&nbsp;&nbsp;&nbsp;&nbsp; console.log(e)&nbsp;&nbsp; &#125;&nbsp;&nbsp; console.log(</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">over!</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8">) &#125;, </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">dummyData.json</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span>, <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">dummyTpl.json</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8">) </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">/*</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 结果如下 </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">*/</span> <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 等待1秒多显示 dummyData.json has loaded </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 等待2秒多显示 dummyTpl.json has loaded </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 显示 Error: OMG! </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">&nbsp;&nbsp;&nbsp;&nbsp; Stack trace: </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">&nbsp;&nbsp;&nbsp;&nbsp; test10/render/&lt;/&lt;@file:</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">/home/fsjohnhuang/repos/iPromise/test/v0.0.2.html:190:6 </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 显示 over!</span></pre><div class="cnblogs_code_toolbar" style="margin: 5px 0px 0px; padding: 0px"><span style="margin: 0px; padding: 0px 5px 0px 0px; line-height: 1.8" class="cnblogs_code_copy"><a style="margin: 0px; padding: 0px; border: none !important" title="复制代码"><img style="margin: 0px; padding: 0px; max-width: 900px; border: none !important" src="http://common.cnblogs.com/images/copycode.gif" border="0" alt="复制代码" /></a></span></div></div><p style="margin: 10px auto; padding: 0px">v0.6.0的中通过递归来实现，具体如下（<a style="margin: 0px; padding: 0px; text-decoration: none; color: #000000; border-bottom-width: 1px; border-bottom-style: dotted; border-bottom-color: #333333" href="https://github.com/fsjohnhuang/iPromise/blob/master/src/iPromise.js#L76" target="_blank">https://github.com/fsjohnhuang/iPromise/blob/master/src/iPromise.js#L76</a>）：</p><div class="cnblogs_code" style="margin: 5px 0px; padding: 5px; border: 1px solid #cccccc; overflow: auto; color: #000000; font-family: 'Courier New' !important; font-size: 12px !important; background-color: #f5f5f5"><div class="cnblogs_code_toolbar" style="margin: 5px 0px 0px; padding: 0px"><span style="margin: 0px; padding: 0px 5px 0px 0px; line-height: 1.8" class="cnblogs_code_copy"><a style="margin: 0px; padding: 0px; border: none !important" title="复制代码"><img style="margin: 0px; padding: 0px; max-width: 900px; border: none !important" src="http://common.cnblogs.com/images/copycode.gif" border="0" alt="复制代码" /></a></span></div><pre style="margin-top: 0px; margin-bottom: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New' !important; font-size: 12px !important"><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> FF下生成器函数的入参必须在创建迭代器时传递 </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000">//</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #008000"> 若第一次调用迭代器的next函数传递参数，则会报TypeError: attempt to send 第一个入参值 to newborn generator</span> <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> iterator = mixin.apply(<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">null</span>, toArray(arguments,<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800080">1</span><span style="margin: 0px; padding: 0px; line-height: 1.8">)) </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> next =<span style="margin: 0px; padding: 0px; line-height: 1.8"> function()&#123; 　　</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> deferred =<span style="margin: 0px; padding: 0px; line-height: 1.8"> iPromise() 　　deferred.resolve.apply(deferred, arguments)&nbsp;&nbsp;　　</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">return</span><span style="margin: 0px; padding: 0px; line-height: 1.8"> deferred.then(function()&#123; 　　　　</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">var</span> yieldReturn =<span style="margin: 0px; padding: 0px; line-height: 1.8"> iterator.next.apply(iterator, arguments)&nbsp;&nbsp;&nbsp;&nbsp;　　</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">if</span>(yieldReturn.done) <span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">throw</span> Error(<span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">StopIteration</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #800000">'</span><span style="margin: 0px; padding: 0px; line-height: 1.8">)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;　　&nbsp;&nbsp; </span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">return</span><span style="margin: 0px; padding: 0px; line-height: 1.8"> yieldReturn.value 　　&#125;).then(next, function(e)&#123; 　　　　iterator.</span><span style="margin: 0px; padding: 0px; line-height: 1.8; color: #0000ff">throw</span><span style="margin: 0px; padding: 0px; line-height: 1.8">(e)<br />　　&#125;) &#125; deferred.resolve() deferred.then(next)</span></pre><div class="cnblogs_code_toolbar" style="margin: 5px 0px 0px; padding: 0px"><span style="margin: 0px; padding: 0px 5px 0px 0px; line-height: 1.8" class="cnblogs_code_copy"><a style="margin: 0px; padding: 0px; border: none !important" title="复制代码"><img style="margin: 0px; padding: 0px; max-width: 900px; border: none !important" src="http://common.cnblogs.com/images/copycode.gif" border="0" alt="复制代码" /></a></span></div></div><p style="margin: 10px auto; padding: 0px">&nbsp;</p><p style="margin: 10px auto; padding: 0px"><span style="margin: 0px; padding: 0px; line-height: 1.8; font-size: 18px; background-color: #888888"><strong style="margin: 0px; padding: 0px">八、总结　　　　　　　　　　　　　　　　　　　　　　　　　　</strong></span></p><p style="margin: 10px auto; padding: 0px">&nbsp; Generator Function并不是为异步编程而生，但可以将它结合Promise来实现良好的异步编程模型。本篇内容仅简单介绍Generator Function及相关的异步编程内容，若有纰漏请各位指正，谢谢！</p><p style="margin: 10px auto; padding: 0px">&nbsp; 尊重原创，转载请注明来自：<a id="Editor_Edit_hlEntryLink" style="margin: 0px; padding: 0px; text-decoration: none; color: #000000; border-bottom-width: 1px; border-bottom-style: dotted; border-bottom-color: #333333" href="http://www.cnblogs.com/fsjohnhuang/p/4166267.html" target="_blank" title="view: JS魔法堂：ES6新特性&mdash;&mdash;GeneratorFunction介绍">http://www.cnblogs.com/fsjohnhuang/p/4166267.html</a>&nbsp;^_^肥仔John</p><p style="margin: 10px auto; padding: 0px">&nbsp;</p><p style="margin: 10px auto; padding: 0px"><span style="margin: 0px; padding: 0px; line-height: 1.8; font-size: 18px; background-color: #888888"><strong style="margin: 0px; padding: 0px">九、 参考　　　　　　　　　　　　　　　　　　　　　　　　　　</strong></span></p><p style="margin: 10px auto; padding: 0px">http://huangj.in/765</p><p style="margin: 10px auto; padding: 0px">https://www.imququ.com/post/generator-function-in-es6.html</p><p style="margin: 10px auto; padding: 0px">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/The_Iterator_protocol</p><p style="margin: 10px auto; padding: 0px">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/function*</p><p style="margin: 10px auto; padding: 0px">http://www.cnblogs.com/yangecnu/archive/2012/03/17/2402432.html</p><p style="margin: 10px auto; padding: 0px">http://www.cnblogs.com/draem0507/p/3795189.html</p><p style="margin: 10px auto; padding: 0px">http://blog.zhaojie.me/2010/06/code-for-fun-iterator-generator-yield-in-javascript-answer-2-loop-and-interpreter.html</p><p style="margin: 10px auto; padding: 0px">http://blog.zhaojie.me/2010/06/code-for-fun-iterator-generator-yield-in-javascript.html</p><p style="margin: 10px auto; padding: 0px">http://blog.zhaojie.me/2010/07/why-java-sucks-and-csharp-rocks-6-yield.html</p></div><div id="MySignature" style="margin: 0px; padding: 0px; color: #333333; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 25.2px"><p style="margin: 12px 0px 0px; padding: 0px">如果您觉得本文的内容有趣就扫一下吧！捐赠互勉！</p></div>
]]>
</description>
</item><item>
<link>http://i.renjihe.com/blog/read.php?7514</link>
<title><![CDATA[Node.js最新技术栈之Promise篇]]></title> 
<author>renjihe1988 &lt;admin@yourname.com&gt;</author>
<category><![CDATA[web]]></category>
<pubDate>Mon, 29 Aug 2016 06:35:22 +0000</pubDate> 
<guid>http://i.renjihe.com/blog/read.php?7514</guid> 
<description>
<![CDATA[ 
	<p style="margin: 0px 0px 1em; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">时间原因，阉割了很多内容，其实内容少点应该更容易理解的，以下是直播的全部内容</p><h1 style="margin: 30px 0px 15px; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; line-height: 40px; color: #333333; text-rendering: optimizeLegibility; font-size: 32.5px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #eeeeee">前言</h1><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">大家好，我是桑世龙，github和cnodejs上的i5ting，目前在天津创业，公司目前使用技术主要是nodejs，算所谓的MEAN（mongodb&nbsp;&nbsp;+ express + angular + node），所有代码都部署在阿里云上</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">我的名字i5ting，原因是我媳妇叫张婷，哈哈</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">闲言少叙，下面开始正题 《Node.js最新技术栈之Promise篇》</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">js流程控制的演进过程，分以下5部分</p><ul style="padding: 0px; margin: 0px 0px 10px 25px; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-size: 14px; line-height: 28px"><li style="line-height: 2em"><ol style="padding: 0px; margin: 0px 0px 0px 25px"><li style="line-height: 2em">回调函数Callbacks</li></ol></li><li style="line-height: 2em"><ol style="padding: 0px; margin: 0px 0px 0px 25px"><li style="line-height: 2em">异步JavaScript</li></ol></li><li style="line-height: 2em"><ol style="padding: 0px; margin: 0px 0px 0px 25px"><li style="line-height: 2em">Promise/a+</li></ol></li><li style="line-height: 2em"><ol style="padding: 0px; margin: 0px 0px 0px 25px"><li style="line-height: 2em">生成器Generators/ yield</li></ol></li><li style="line-height: 2em"><ol style="padding: 0px; margin: 0px 0px 0px 25px"><li style="line-height: 2em">Async/ await</li></ol></li></ul><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif"><img style="height: auto; max-width: 100%; vertical-align: middle; border: 0px; cursor: pointer" src="http://dn-cnode.qbox.me/FgKu20kvFqHrkgpjbQxXkV1DmrG1" border="0" alt="1.png" /></p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">首先回调和异步是大家常见的，这里跳过，本节课主要讲promise/a+原理、实现和实践，并展望下一代的Generators/yield和Async/await等。</p><h1 style="margin: 30px 0px 15px; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; line-height: 40px; color: #333333; text-rendering: optimizeLegibility; font-size: 32.5px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #eeeeee">0）痛点</h1><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">我们知道nodejs的最大的优点是高并发，适合适合I/O密集型应用</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif"><img style="height: auto; max-width: 100%; vertical-align: middle; border: 0px; cursor: pointer" src="http://dn-cnode.qbox.me/FlPgjSEeYky4OEsdWokPlzTnQVln" border="0" alt="arch.png" /></p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">每一个函数都是异步，并发上去了，但痛苦也来了，比如</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">我现在要执行4个步骤，依次执行，于是就有下面的代码</p><pre class="prettyprint" style="line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; color: #333333; border-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; border-color: initial; background: #f7f7f7"><span style="color: #000000" class="pln">step1</span><span style="color: #666600" class="pun">(</span><span style="color: #000088" class="kwd">function</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">value1</span><span style="color: #666600" class="pun">)</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; step2</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">value1</span><span style="color: #666600" class="pun">,</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">function</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">value2</span><span style="color: #666600" class="pun">)</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; step3</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">value2</span><span style="color: #666600" class="pun">,</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">function</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">value3</span><span style="color: #666600" class="pun">)</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; step4</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">value3</span><span style="color: #666600" class="pun">,</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">function</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">value4</span><span style="color: #666600" class="pun">)</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #880000" class="com">// Do something with value4</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #666600" class="pun">&#125;);</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #666600" class="pun">&#125;);</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #666600" class="pun">&#125;);</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;);</span></pre><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">这里只有4个，那如果更多呢？会不会崩溃，反正我会</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">有解决办法么？</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">答案是就是：promise/a+规范，下面我们看一下promise/a+规范</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">我们再来个伏笔，看一下链式写法</p><h1 style="margin: 30px 0px 15px; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; line-height: 40px; color: #333333; text-rendering: optimizeLegibility; font-size: 32.5px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #eeeeee">链式写法</h1><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">先举个jQuery的链式写法例子</p><pre class="prettyprint" style="line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; color: #333333; border-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; border-color: initial; background: #f7f7f7"><span style="color: #000000" class="pln">$</span><span style="color: #666600" class="pun">(</span><span style="color: #008800" class="str">'#tab'</span><span style="color: #666600" class="pun">).</span><span style="color: #000000" class="pln">eq</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">$</span><span style="color: #666600" class="pun">(</span><span style="color: #000088" class="kwd">this</span><span style="color: #666600" class="pun">).</span><span style="color: #000000" class="pln">index</span><span style="color: #666600" class="pun">()).</span><span style="color: #000000" class="pln">show</span><span style="color: #666600" class="pun">().</span><span style="color: #000000" class="pln">siblings</span><span style="color: #666600" class="pun">().</span><span style="color: #000000" class="pln">hide</span><span style="color: #666600" class="pun">();</span></pre><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">链式写法的核心是：每个方法都返回this（自己看jquery源码）</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">下面举一个this的简单例子</p><pre class="prettyprint" style="line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; color: #333333; border-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; border-color: initial; background: #f7f7f7"><span style="color: #000088" class="kwd">var</span><span style="color: #000000" class="pln"> obj </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp; step1</span><span style="color: #666600" class="pun">:</span><span style="color: #000088" class="kwd">function</span><span style="color: #666600" class="pun">()&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; console</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">log</span><span style="color: #666600" class="pun">(</span><span style="color: #008800" class="str">'a'</span><span style="color: #666600" class="pun">);</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #000088" class="kwd">return</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">this</span><span style="color: #666600" class="pun">;</span><span style="color: #000000" class="pln">&nbsp;&nbsp; </span><span style="color: #666600" class="pun">&#125;,</span><span style="color: #000000" class="pln">&nbsp;&nbsp; step2</span><span style="color: #666600" class="pun">:</span><span style="color: #000088" class="kwd">function</span><span style="color: #666600" class="pun">()&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; console</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">log</span><span style="color: #666600" class="pun">(</span><span style="color: #008800" class="str">'b'</span><span style="color: #666600" class="pun">);</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #000088" class="kwd">return</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">this</span><span style="color: #666600" class="pun">;</span><span style="color: #000000" class="pln">&nbsp;&nbsp; </span><span style="color: #666600" class="pun">&#125;,</span><span style="color: #000000" class="pln">&nbsp;&nbsp; step3</span><span style="color: #666600" class="pun">:</span><span style="color: #000088" class="kwd">function</span><span style="color: #666600" class="pun">()&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; console</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">log</span><span style="color: #666600" class="pun">(</span><span style="color: #008800" class="str">'c'</span><span style="color: #666600" class="pun">);</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #000088" class="kwd">return</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">this</span><span style="color: #666600" class="pun">;</span><span style="color: #000000" class="pln">&nbsp;&nbsp; </span><span style="color: #666600" class="pun">&#125;,</span><span style="color: #000000" class="pln">&nbsp;&nbsp; step4</span><span style="color: #666600" class="pun">:</span><span style="color: #000088" class="kwd">function</span><span style="color: #666600" class="pun">()&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; console</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">log</span><span style="color: #666600" class="pun">(</span><span style="color: #008800" class="str">'d'</span><span style="color: #666600" class="pun">);</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #000088" class="kwd">return</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">this</span><span style="color: #666600" class="pun">;</span><span style="color: #000000" class="pln">&nbsp;&nbsp; </span><span style="color: #666600" class="pun">&#125;</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;console</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">log</span><span style="color: #666600" class="pun">(</span><span style="color: #008800" class="str">'-----&#92;n'</span><span style="color: #666600" class="pun">);</span><span style="color: #000000" class="pln"> obj</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">step1</span><span style="color: #666600" class="pun">().</span><span style="color: #000000" class="pln">step2</span><span style="color: #666600" class="pun">().</span><span style="color: #000000" class="pln">step3</span><span style="color: #666600" class="pun">();</span><span style="color: #000000" class="pln"> console</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">log</span><span style="color: #666600" class="pun">(</span><span style="color: #008800" class="str">'-----&#92;n'</span><span style="color: #666600" class="pun">);</span><span style="color: #000000" class="pln"> obj</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">step4</span><span style="color: #666600" class="pun">().</span><span style="color: #000000" class="pln">step2</span><span style="color: #666600" class="pun">().</span><span style="color: #000000" class="pln">step1</span><span style="color: #666600" class="pun">();</span></pre><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">这只是一个简单返回this的链式写法而已</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">执行结果</p><pre class="prettyprint" style="line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; color: #333333; border-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; border-color: initial; background: #f7f7f7"><span style="color: #000000" class="pln">$ node doc</span><span style="color: #666600" class="pun">/</span><span style="color: #000088" class="kwd">this</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">js </span><span style="color: #666600" class="pun">-----</span><span style="color: #000000" class="pln">&nbsp;&nbsp;a b c </span><span style="color: #666600" class="pun">-----</span><span style="color: #000000" class="pln">&nbsp;&nbsp;c b a</span></pre><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">为啥要讲这个呢？先回到异步调用的场景，我们能这样调用么？如果每一个操作都可以连起来，是不是很爽</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">比如</p><pre class="prettyprint" style="line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; color: #333333; border-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; border-color: initial; background: #f7f7f7"><span style="color: #000088" class="kwd">return</span><span style="color: #000000" class="pln"> step1</span><span style="color: #666600" class="pun">().</span><span style="color: #000000" class="pln">step2</span><span style="color: #666600" class="pun">().</span><span style="color: #000000" class="pln">step3</span><span style="color: #666600" class="pun">().</span><span style="color: #000000" class="pln">step4</span><span style="color: #666600" class="pun">()</span></pre><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">这样做的好处</p><ul style="padding: 0px; margin: 0px 0px 10px 25px; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-size: 14px; line-height: 28px"><li style="line-height: 2em">1）每一个操作都是独立的函数</li><li style="line-height: 2em">2）可组装，拼就好了</li></ul><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">我们还可以再苛刻点</p><ul style="padding: 0px; margin: 0px 0px 10px 25px; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-size: 14px; line-height: 28px"><li style="line-height: 2em">1）如果要是上一步的结果作为下一步的输入就更好了（linux里的pipe：ps -ef&#124;grep node&#124;awk &lsquo;&#123;print $2&#125;&rsquo;&#124;xargs kill -9）</li><li style="line-height: 2em">2）如果出错能捕获异常就更好了</li><li style="line-height: 2em">3）如果能在函数里面也能控制流程就更好了</li></ul><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">会有人说：&ldquo;你要求的是不是太多了？&rdquo;</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">&ldquo;but，很好，我们来制定一个叫promisesaplus的规范吧，涵盖上面的所有内容&rdquo;</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">于是就有了promise/a+规范&hellip;</p><h1 style="margin: 30px 0px 15px; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; line-height: 40px; color: #333333; text-rendering: optimizeLegibility; font-size: 32.5px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #eeeeee">1）promise/a+规范</h1><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">这里面讲很多链式相关的东西，是我们异步操作里常见的问题，我们希望有更好的解决方案，promise/a+规范便应运而生</p><h2 style="margin: 30px 0px 15px; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; line-height: 40px; color: #333333; text-rendering: optimizeLegibility; font-size: 26px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #eeeeee">什么是promise/a+规范？</h2><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">Promise表示一个异步操作的最终结果。与Promise最主要的交互方法是通过将函数传入它的then方法从而获取得Promise最终的值或Promise最终最拒绝（reject）的原因。</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">想想我们刚才的那个例子，让我们来庖解一下</p><ul style="padding: 0px; margin: 0px 0px 10px 25px; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-size: 14px; line-height: 28px"><li style="line-height: 2em">a) 异步操作的最终结果</li></ul><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">简单点看，它也是一个链式操作,类似</p><pre class="prettyprint" style="line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; color: #333333; border-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; border-color: initial; background: #f7f7f7"><span style="color: #000088" class="kwd">return</span><span style="color: #000000" class="pln"> step1</span><span style="color: #666600" class="pun">().</span><span style="color: #000000" class="pln">step2</span><span style="color: #666600" class="pun">().</span><span style="color: #000000" class="pln">step3</span><span style="color: #666600" class="pun">().</span><span style="color: #000000" class="pln">step4</span><span style="color: #666600" class="pun">()</span></pre><ul style="padding: 0px; margin: 0px 0px 10px 25px; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-size: 14px; line-height: 28px"><li style="line-height: 2em">b) 与Promise最主要的交互方法是通过将函数传入它的then方法</li></ul><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">但它有点差别</p><pre class="prettyprint" style="line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; color: #333333; border-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; border-color: initial; background: #f7f7f7"><span style="color: #000088" class="kwd">return</span><span style="color: #000000" class="pln"> step1</span><span style="color: #666600" class="pun">().</span><span style="color: #000088" class="kwd">then</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">step2</span><span style="color: #666600" class="pun">).</span><span style="color: #000088" class="kwd">then</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">step3</span><span style="color: #666600" class="pun">).</span><span style="color: #000088" class="kwd">then</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">step4</span><span style="color: #666600" class="pun">)</span></pre><ul style="padding: 0px; margin: 0px 0px 10px 25px; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-size: 14px; line-height: 28px"><li style="line-height: 2em">c1) 从而获取得Promise最终的值或Promise最终最拒绝（reject）的原因</li></ul><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">比如step1执行成功了，那么就会执行step2，如果step2执行成功了就会执行下一个，以此类推</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">那么如果失败呢？于是应该改成这样：</p><pre class="prettyprint" style="line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; color: #333333; border-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; border-color: initial; background: #f7f7f7"><span style="color: #000088" class="kwd">return</span><span style="color: #000000" class="pln"> step1</span><span style="color: #666600" class="pun">().</span><span style="color: #000088" class="kwd">then</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">step2</span><span style="color: #666600" class="pun">).</span><span style="color: #000088" class="kwd">then</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">step3</span><span style="color: #666600" class="pun">).</span><span style="color: #000088" class="kwd">then</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">step4</span><span style="color: #666600" class="pun">).</span><span style="color: #000088" class="kwd">catch</span><span style="color: #666600" class="pun">(</span><span style="color: #000088" class="kwd">function</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">err</span><span style="color: #666600" class="pun">)&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp; </span><span style="color: #880000" class="com">// do something when err</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;);</span></pre><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">加了一个catch error回调，当出现异常就会直接到这个流程，会不会很好呢？</p><ul style="padding: 0px; margin: 0px 0px 10px 25px; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-size: 14px; line-height: 28px"><li style="line-height: 2em">c2) 从而获取得Promise最终的值或Promise最终最拒绝（reject）的原因</li></ul><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">这句话了有一个reject，其实还对应一个resolve方法</p><ul style="padding: 0px; margin: 0px 0px 10px 25px; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-size: 14px; line-height: 28px"><li style="line-height: 2em">reject 是拒绝，跳转到catch error</li><li style="line-height: 2em">resolve 是解决，下一步，即跳转到下一个promise操作</li></ul><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">我们还以上面的例子来说，如果step1失败了，走step3，step3失败了step4,如果step4出错就结束，报错，看一下代码</p><pre class="prettyprint" style="line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; color: #333333; border-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; border-color: initial; background: #f7f7f7"><span style="color: #000088" class="kwd">function</span><span style="color: #000000" class="pln"> step1</span><span style="color: #666600" class="pun">()&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp; </span><span style="color: #000088" class="kwd">if</span><span style="color: #666600" class="pun">(</span><span style="color: #000088" class="kwd">false</span><span style="color: #666600" class="pun">)&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #000088" class="kwd">return</span><span style="color: #000000" class="pln"> step3</span><span style="color: #666600" class="pun">().</span><span style="color: #000088" class="kwd">then</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">step4</span><span style="color: #666600" class="pun">).</span><span style="color: #000088" class="kwd">catch</span><span style="color: #666600" class="pun">(</span><span style="color: #000088" class="kwd">function</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">err</span><span style="color: #666600" class="pun">)&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #880000" class="com">// do something when err</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #666600" class="pun">&#125;);</span><span style="color: #000000" class="pln">&nbsp;&nbsp; </span><span style="color: #666600" class="pun">&#125;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #666600" class="pun">&#125;</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">return</span><span style="color: #000000" class="pln"> step1</span><span style="color: #666600" class="pun">().</span><span style="color: #000088" class="kwd">then</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">step2</span><span style="color: #666600" class="pun">).</span><span style="color: #000088" class="kwd">then</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">step3</span><span style="color: #666600" class="pun">).</span><span style="color: #000088" class="kwd">then</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">step4</span><span style="color: #666600" class="pun">).</span><span style="color: #000088" class="kwd">catch</span><span style="color: #666600" class="pun">(</span><span style="color: #000088" class="kwd">function</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">err</span><span style="color: #666600" class="pun">)&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp; </span><span style="color: #880000" class="com">// do something when err</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;);</span></pre><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">总结一下：以上就是promise/a+规范的定义，我们拆解了一下，涵盖了上面我提出的几个痛点</p><h2 style="margin: 30px 0px 15px; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; line-height: 40px; color: #333333; text-rendering: optimizeLegibility; font-size: 26px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #eeeeee">术语</h2><h3 style="margin: 30px 0px 15px; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; line-height: 40px; color: #333333; text-rendering: optimizeLegibility; font-size: 24.5px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #eeeeee">promise</h3><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">是一个包含了兼容promise规范then方法的对象或函数</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">我们可以这样理解，每一个promise只要返回的可以then的都可以。就像上面举例返回的this一样，只要每一个都返回this，她就可以无限的链式下去，</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">这里的this约定为每一个对象或函数返回的都是兼容promise规范then方法。</p><h3 style="margin: 30px 0px 15px; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; line-height: 40px; color: #333333; text-rendering: optimizeLegibility; font-size: 24.5px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #eeeeee">thenable</h3><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">是一个包含了then方法的对象或函数。</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">这个可以这样理解，上面的例子，每个方法都返回this，比较麻烦，</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">那能不能只有then方法promise对象，每一个操作都返回一样的promise对象，是不是就可以无限链接下去了？</p><h3 style="margin: 30px 0px 15px; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; line-height: 40px; color: #333333; text-rendering: optimizeLegibility; font-size: 24.5px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #eeeeee">value</h3><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">是任何Javascript值。 (包括 undefined, thenable, promise等).</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">promise/a+规范约定的几个概念而已</p><h3 style="margin: 30px 0px 15px; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; line-height: 40px; color: #333333; text-rendering: optimizeLegibility; font-size: 24.5px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #eeeeee">exception</h3><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">是由throw表达式抛出来的值。</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">上面讲的，当流程出现异常的适合，把异常抛出来，由catch err处理。</p><h3 style="margin: 30px 0px 15px; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; line-height: 40px; color: #333333; text-rendering: optimizeLegibility; font-size: 24.5px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #eeeeee">reason</h3><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">是一个用于描述Promise被拒绝原因的值。</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">就是给你一个犯了错误，自我交待，争取宽大处理的机会。</p><h2 style="margin: 30px 0px 15px; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; line-height: 40px; color: #333333; text-rendering: optimizeLegibility; font-size: 26px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #eeeeee">参考</h2><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">还有一些promise里流程处理相关的东西，比较复杂，没啥大意义，有兴趣的可以看看官方网址</p><ul style="padding: 0px; margin: 0px 0px 10px 25px; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-size: 14px; line-height: 28px"><li style="line-height: 2em"><a style="color: #0088cc; text-decoration: none" href="https://promisesaplus.com/" target="_blank">https://promisesaplus.com/</a></li></ul><h2 style="margin: 30px 0px 15px; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; line-height: 40px; color: #333333; text-rendering: optimizeLegibility; font-size: 26px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #eeeeee">总结一下</h2><ul style="padding: 0px; margin: 0px 0px 10px 25px; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-size: 14px; line-height: 28px"><li style="line-height: 2em"><ol style="padding: 0px; margin: 0px 0px 0px 25px"><li style="line-height: 2em">每个操作都返回一样的promise对象，保证链式操作</li></ol></li><li style="line-height: 2em"><ol style="padding: 0px; margin: 0px 0px 0px 25px"><li style="line-height: 2em">每个链式都通过then方法</li></ol></li><li style="line-height: 2em"><ol style="padding: 0px; margin: 0px 0px 0px 25px"><li style="line-height: 2em">每个操作内部允许犯错，出了错误，统一由catch error处理</li></ol></li><li style="line-height: 2em"><ol style="padding: 0px; margin: 0px 0px 0px 25px"><li style="line-height: 2em">操作内部，也可以是一个操作链，通过reject或resolve再造流程</li></ol></li></ul><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">理解这些，实际上nodejs里就没有啥难点了。当然我还要告诉更多好处，让你受益一生（吹吹牛）</p><h2 style="margin: 30px 0px 15px; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; line-height: 40px; color: #333333; text-rendering: optimizeLegibility; font-size: 26px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #eeeeee">八卦一下</h2><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">哪个语言不需要回调呢？callback并不是js所特有的，举个例子oc里的block（如果愿意扯，也可以扯扯函数指针），如果用asi或者afnetworking处理http请求，你都可以选择用block方式，那么你如果一个业务里有多个请求呢？</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">你也只能嵌套，因为嵌套没有太多层，因为可以有其他解耦方式，其实我最想表达的是，它也可以使用promise方式的。</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">这里展示一个例子</p><pre class="prettyprint" style="line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; color: #333333; border-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; border-color: initial; background: #f7f7f7"><span style="color: #666600" class="pun">[</span><span style="color: #000088" class="kwd">self</span><span style="color: #000000" class="pln"> login</span><span style="color: #666600" class="pun">].</span><span style="color: #000088" class="kwd">then</span><span style="color: #666600" class="pun">(^&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #880000" class="com">// our login method wrapped an async task in a promise</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #000088" class="kwd">return</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">[</span><span style="color: #000000" class="pln">API fetchKittens</span><span style="color: #666600" class="pun">];</span><span style="color: #000000" class="pln">&nbsp;&nbsp;</span><span style="color: #666600" class="pun">&#125;).</span><span style="color: #000088" class="kwd">then</span><span style="color: #666600" class="pun">(^(</span><span style="color: #660066" class="typ">NSArray</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">*</span><span style="color: #000000" class="pln">fetchedKittens</span><span style="color: #666600" class="pun">)&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #880000" class="com">// our API class wraps our API and returns promises</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #880000" class="com">// fetchKittens returned a promise that resolves with an array of kittens</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #000088" class="kwd">self</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">kittens </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln"> fetchedKittens</span><span style="color: #666600" class="pun">;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #666600" class="pun">[</span><span style="color: #000088" class="kwd">self</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">tableView reloadData</span><span style="color: #666600" class="pun">];</span><span style="color: #000000" class="pln">&nbsp;&nbsp;</span><span style="color: #666600" class="pun">&#125;).</span><span style="color: #000088" class="kwd">catch</span><span style="color: #666600" class="pun">(^(</span><span style="color: #660066" class="typ">NSError</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">*</span><span style="color: #000000" class="pln">error</span><span style="color: #666600" class="pun">)&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #880000" class="com">// any errors in any of the above promises land here</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #666600" class="pun">[[[</span><span style="color: #660066" class="typ">UIAlertView</span><span style="color: #000000" class="pln"> alloc</span><span style="color: #666600" class="pun">]</span><span style="color: #000000" class="pln"> init</span><span style="color: #666600" class="pun">&hellip;]</span><span style="color: #000000" class="pln"> show</span><span style="color: #666600" class="pun">];</span><span style="color: #000000" class="pln">&nbsp;&nbsp;</span><span style="color: #666600" class="pun">&#125;);</span><span style="color: #000000" class="pln"> </span></pre><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">详见http://promisekit.org/introduction/</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">是不是很奇怪，咋和上面的promise写法一样呢？</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">官方解释是</p><pre class="prettyprint" style="line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; color: #333333; border-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; border-color: initial; background: #f7f7f7"><span style="color: #660066" class="typ">PromiseKit</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">is</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">not</span><span style="color: #000000" class="pln"> just a promises implementation</span></pre><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">好吧，这只是冰山一角</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">如果各位熟悉前端js，相信你一定了解</p><ul style="padding: 0px; margin: 0px 0px 10px 25px; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-size: 14px; line-height: 28px"><li style="line-height: 2em">jQuery（1.5+）的deferred</li><li style="line-height: 2em">Angularjs的$q对象</li></ul><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">nodejs里的实现</p><ul style="padding: 0px; margin: 0px 0px 10px 25px; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-size: 14px; line-height: 28px"><li style="line-height: 2em">bluebird （<a style="color: #0088cc; text-decoration: none" href="https://github.com/petkaantonov/bluebird" target="_blank">https://github.com/petkaantonov/bluebird</a>&nbsp;后面继续讲，保持神秘）</li><li style="line-height: 2em">q （<a style="color: #0088cc; text-decoration: none" href="https://github.com/kriskowal/q" target="_blank">https://github.com/kriskowal/q</a>&nbsp;Angularjs的$q对象是q的精简版）</li><li style="line-height: 2em">then （teambition作品&nbsp;<a style="color: #0088cc; text-decoration: none" href="https://github.com/teambition/then.js" target="_blank">https://github.com/teambition/then.js</a>&nbsp;没用过）</li><li style="line-height: 2em">when （<a style="color: #0088cc; text-decoration: none" href="https://github.com/cujojs/when" target="_blank">https://github.com/cujojs/when</a>&nbsp;没用过）</li><li style="line-height: 2em">async （<a style="color: #0088cc; text-decoration: none" href="https://github.com/caolan/async" target="_blank">https://github.com/caolan/async</a>&nbsp;最简单的）</li><li style="line-height: 2em">eventproxy（朴灵作品&nbsp;<a style="color: #0088cc; text-decoration: none" href="https://github.com/JacksonTian/eventproxy%EF%BC%8C%E4%BD%BF%E7%94%A8event%E6%9D%A5%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%EF%BC%8C%E4%B9%9F%E6%98%AF%E4%B8%8D%E9%94%99%E7%9A%84%E5%B0%9D%E8%AF%95%EF%BC%89" target="_blank">https://github.com/JacksonTian/eventproxy，使用event来处理流程，也是不错的尝试）</a></li></ul><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">其他语言实现，详见 <a style="color: #0088cc; text-decoration: none" href="https://promisesaplus.com/implementations" target="_blank">https://promisesaplus.com/implementations</a></p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">其实，只要掌握了promise/a+规范，你就可以在n种语言里使用了</p><h1 style="margin: 30px 0px 15px; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; line-height: 40px; color: #333333; text-rendering: optimizeLegibility; font-size: 32.5px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #eeeeee">2）如何实现</h1><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">promise/a+规范是一个通用解决方案，不只是对nodejs管用，只要你掌握了原理，就只是换个语言实现而已</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">下面我就带着大家看一下js里是如何实现的</p><pre class="prettyprint" style="line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; color: #333333; border-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; border-color: initial; background: #f7f7f7"><span style="color: #000088" class="kwd">var</span><span style="color: #000000" class="pln"> </span><span style="color: #660066" class="typ">Promise</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">function</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">()</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;</span><span style="color: #000088" class="kwd">var</span><span style="color: #000000" class="pln"> isPromise </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">function</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">value</span><span style="color: #666600" class="pun">)</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #000088" class="kwd">return</span><span style="color: #000000" class="pln"> value </span><span style="color: #000088" class="kwd">instanceof</span><span style="color: #000000" class="pln"> </span><span style="color: #660066" class="typ">Promise</span><span style="color: #666600" class="pun">;</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;</span><span style="color: #000088" class="kwd">var</span><span style="color: #000000" class="pln"> defer </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">function</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">()</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #000088" class="kwd">var</span><span style="color: #000000" class="pln"> pending </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">[],</span><span style="color: #000000" class="pln"> value</span><span style="color: #666600" class="pun">;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #000088" class="kwd">var</span><span style="color: #000000" class="pln"> promise </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">new</span><span style="color: #000000" class="pln"> </span><span style="color: #660066" class="typ">Promise</span><span style="color: #666600" class="pun">();</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; promise</span><span style="color: #666600" class="pun">.</span><span style="color: #000088" class="kwd">then</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">function</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">callback</span><span style="color: #666600" class="pun">)</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #000088" class="kwd">if</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">pending</span><span style="color: #666600" class="pun">)</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pending</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">push</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">callback</span><span style="color: #666600" class="pun">);</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #666600" class="pun">&#125;</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">else</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; callback</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">value</span><span style="color: #666600" class="pun">);</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #666600" class="pun">&#125;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #666600" class="pun">&#125;;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #000088" class="kwd">return</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; resolve</span><span style="color: #666600" class="pun">:</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">function</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">_value</span><span style="color: #666600" class="pun">)</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #000088" class="kwd">if</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">pending</span><span style="color: #666600" class="pun">)</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; value </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln"> _value</span><span style="color: #666600" class="pun">;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #000088" class="kwd">for</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">(</span><span style="color: #000088" class="kwd">var</span><span style="color: #000000" class="pln"> i </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln"> </span><span style="color: #006666" class="lit">0</span><span style="color: #666600" class="pun">,</span><span style="color: #000000" class="pln"> ii </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln"> pending</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">length</span><span style="color: #666600" class="pun">;</span><span style="color: #000000" class="pln"> i </span><span style="color: #666600" class="pun">&lt;</span><span style="color: #000000" class="pln"> ii</span><span style="color: #666600" class="pun">;</span><span style="color: #000000" class="pln"> i</span><span style="color: #666600" class="pun">++)</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #000088" class="kwd">var</span><span style="color: #000000" class="pln"> callback </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln"> pending</span><span style="color: #666600" class="pun">[</span><span style="color: #000000" class="pln">i</span><span style="color: #666600" class="pun">];</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; callback</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">value</span><span style="color: #666600" class="pun">);</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #666600" class="pun">&#125;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pending </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">undefined</span><span style="color: #666600" class="pun">;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #666600" class="pun">&#125;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #666600" class="pun">&#125;,</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; promise</span><span style="color: #666600" class="pun">:</span><span style="color: #000000" class="pln"> promise&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #666600" class="pun">&#125;;</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;;</span></pre><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">首先</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">1） 声明promise对象</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">var promise = new Promise();</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">2）给promise对象增加then方法</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">promise.then = function (callback) &#123;</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">3）给defer对象返回resolve和promise</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">4）value，在resolve事件里传参，是第几个就执行第几个</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">本来想讲的更多一点，但时间不允许啊（后面还有很多内容），此处暂时讲到这里</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">cnode里的William17写的挺好的，完整的实现可以参考</p><ul style="padding: 0px; margin: 0px 0px 10px 25px; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-size: 14px; line-height: 28px"><li style="line-height: 2em"><a style="color: #0088cc; text-decoration: none" href="https://cnodejs.org/topic/5603cb8a152fdd025f0f5014" target="_blank">https://cnodejs.org/topic/5603cb8a152fdd025f0f5014</a></li><li style="line-height: 2em"><a style="color: #0088cc; text-decoration: none" href="https://github.com/William17/taxi" target="_blank">https://github.com/William17/taxi</a></li></ul><h2 style="margin: 30px 0px 15px; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; line-height: 40px; color: #333333; text-rendering: optimizeLegibility; font-size: 26px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #eeeeee">关于Q</h2><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">q是一个不错的项目，也是比较早的promise实现，而且angularjs的$q就是它的精简版，如果掌握了q，学习angular和bluebird都会比较简单</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">当然它还有更棒的，它把q的7个版本是如何实现的都详细记录了，刚才我给出的v1实际上就q的早期版本</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif"><a style="color: #0088cc; text-decoration: none" href="https://github.com/kriskowal/q/tree/v1/design" target="_blank">https://github.com/kriskowal/q/tree/v1/design</a></p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">很多人都以为是跟着人学，但人有不确定性，而且互联网让世界是平的了，我们如果能够学会从开源项目里学习，这才是长久的学习力</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">曾经写过一篇《如何学习之善用github篇：向 <a style="color: #0088cc; text-decoration: none" href="http://cnodejs.org/user/Pana" target="_blank">@Pana</a> 学习》，有兴趣的可以去翻翻</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif"><a style="color: #0088cc; text-decoration: none" href="http://mp.weixin.qq.com/s?__biz=MzAxMTU0NTc4Nw==&amp;mid=223428929&amp;idx=1&amp;sn=8296f5a96aa34f836ab83000f7ad995b#rd" target="_blank">http://mp.weixin.qq.com/s?__biz=MzAxMTU0NTc4Nw==&amp;mid=223428929&amp;idx=1&amp;sn=8296f5a96aa34f836ab83000f7ad995b#rd</a></p><h1 style="margin: 30px 0px 15px; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; line-height: 40px; color: #333333; text-rendering: optimizeLegibility; font-size: 32.5px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #eeeeee">3）真实项目里的实践</h1><h2 style="margin: 30px 0px 15px; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; line-height: 40px; color: #333333; text-rendering: optimizeLegibility; font-size: 26px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #eeeeee">技术选项：先看基准测试</h2><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">2015-01-05 当时最新的模块，比较结果如下</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif"><img style="height: auto; max-width: 100%; vertical-align: middle; border: 0px; cursor: pointer" src="http://dn-cnode.qbox.me/Fq-FM_N-zrlVEm-_7RS291Afo8dW" border="0" alt="benchmark.png" /></p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">对比一下结果</p><pre class="prettyprint" style="line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; color: #333333; border-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; border-color: initial; background: #f7f7f7"><span style="color: #666600" class="pun">顺序执行</span><span style="color: #000000" class="pln"> promises</span><span style="color: #666600" class="pun">-</span><span style="color: #000000" class="pln">bluebird</span><span style="color: #666600" class="pun">-</span><span style="color: #000000" class="pln">generator</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">js&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006666" class="lit">235</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #006666" class="lit">38.04</span><span style="color: #000000" class="pln"> promises</span><span style="color: #666600" class="pun">-</span><span style="color: #000000" class="pln">bluebird</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">js&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006666" class="lit">335</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #006666" class="lit">52.08</span><span style="color: #000000" class="pln">&nbsp;&nbsp;</span><span style="color: #666600" class="pun">并发执行</span><span style="color: #000000" class="pln"> promises</span><span style="color: #666600" class="pun">-</span><span style="color: #000000" class="pln">bluebird</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">js&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #006666" class="lit">389</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #006666" class="lit">53.49</span><span style="color: #000000" class="pln"> promises</span><span style="color: #666600" class="pun">-</span><span style="color: #000000" class="pln">bluebird</span><span style="color: #666600" class="pun">-</span><span style="color: #000000" class="pln">generator</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">js&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #006666" class="lit">491</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #006666" class="lit">55.52</span></pre><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">不管是哪种，bluebird都是前三名。然后扒一扒第一名的callbacks-baseline.js,其实就我们最讨厌的最基本的回调写法，也就说，bb实际比原生js稍慢，但比其他promise库都快</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">综合一下bb的特性</p><ul style="padding: 0px; margin: 0px 0px 10px 25px; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-size: 14px; line-height: 28px"><li style="line-height: 2em">速度最快</li><li style="line-height: 2em">api和文档完善，（对各个库支持都不错）</li><li style="line-height: 2em">支持generator等未来发展趋势</li><li style="line-height: 2em">github活跃</li><li style="line-height: 2em">还有让人眼前一亮的功能点（保密，下面会讲）</li></ul><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">我们的结论只有bb是目前最好的最好的选择</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">我个人的一个小喜好，对caolan的async挺喜欢的，我的选项</p><ul style="padding: 0px; margin: 0px 0px 10px 25px; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-size: 14px; line-height: 28px"><li style="line-height: 2em">公司项目是bb</li><li style="line-height: 2em">开源大点的还是bb</li><li style="line-height: 2em">小工具啥的我会选async</li></ul><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">其实when，then，eventproxy等也不错，只是懒得折腾</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">大家在直播过程中有任何不明白或者想提问的可以随时私信给小助手，我会在答疑阶段统一回答</p><h2 style="margin: 30px 0px 15px; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; line-height: 40px; color: #333333; text-rendering: optimizeLegibility; font-size: 26px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #eeeeee">场景</h2><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">下面举几个实际场景</p><h3 style="margin: 30px 0px 15px; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; line-height: 40px; color: #333333; text-rendering: optimizeLegibility; font-size: 24.5px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #eeeeee">神器，bluebird的promisify</h3><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">promisify原理</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">就是你给他传一个对象或者prototype，它去遍历，给他们加上async方法，此方法返回promise对象，你就可以为所欲为了</p><ul style="padding: 0px; margin: 0px 0px 10px 25px; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-size: 14px; line-height: 28px"><li style="line-height: 2em">优点：使用简单</li><li style="line-height: 2em">缺点：谨防对象过大，内存问题</li></ul><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">nodejs api支持</p><pre class="prettyprint" style="line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; color: #333333; border-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; border-color: initial; background: #f7f7f7"><span style="color: #880000" class="com">//Read more about promisification in the API Reference:</span><span style="color: #000000" class="pln"> </span><span style="color: #880000" class="com">//API.md</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">var</span><span style="color: #000000" class="pln"> fs </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln"> </span><span style="color: #660066" class="typ">Promise</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">promisifyAll</span><span style="color: #666600" class="pun">(</span><span style="color: #000088" class="kwd">require</span><span style="color: #666600" class="pun">(</span><span style="color: #008800" class="str">&quot;fs&quot;</span><span style="color: #666600" class="pun">));</span><span style="color: #000000" class="pln">&nbsp;&nbsp;fs</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">readFileAsync</span><span style="color: #666600" class="pun">(</span><span style="color: #008800" class="str">&quot;myfile.json&quot;</span><span style="color: #666600" class="pun">).</span><span style="color: #000088" class="kwd">then</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">JSON</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">parse</span><span style="color: #666600" class="pun">).</span><span style="color: #000088" class="kwd">then</span><span style="color: #666600" class="pun">(</span><span style="color: #000088" class="kwd">function</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">json</span><span style="color: #666600" class="pun">)</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; console</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">log</span><span style="color: #666600" class="pun">(</span><span style="color: #008800" class="str">&quot;Successful json&quot;</span><span style="color: #666600" class="pun">);</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;).</span><span style="color: #000088" class="kwd">catch</span><span style="color: #666600" class="pun">(</span><span style="color: #660066" class="typ">SyntaxError</span><span style="color: #666600" class="pun">,</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">function</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">e</span><span style="color: #666600" class="pun">)</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; console</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">error</span><span style="color: #666600" class="pun">(</span><span style="color: #008800" class="str">&quot;file contains invalid json&quot;</span><span style="color: #666600" class="pun">);</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;).</span><span style="color: #000088" class="kwd">catch</span><span style="color: #666600" class="pun">(</span><span style="color: #660066" class="typ">Promise</span><span style="color: #666600" class="pun">.</span><span style="color: #660066" class="typ">OperationalError</span><span style="color: #666600" class="pun">,</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">function</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">e</span><span style="color: #666600" class="pun">)</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; console</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">error</span><span style="color: #666600" class="pun">(</span><span style="color: #008800" class="str">&quot;unable to read file, because: &quot;</span><span style="color: #666600" class="pun">,</span><span style="color: #000000" class="pln"> e</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">message</span><span style="color: #666600" class="pun">);</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;);</span></pre><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">熟悉fs的API的都知道，fs有</p><ul style="padding: 0px; margin: 0px 0px 10px 25px; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-size: 14px; line-height: 28px"><li style="line-height: 2em">fs.readFile</li><li style="line-height: 2em">fs.readFileSync</li></ul><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">但没有</p><ul style="padding: 0px; margin: 0px 0px 10px 25px; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-size: 14px; line-height: 28px"><li style="line-height: 2em">fs.readFileAsync</li></ul><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">实际上fs.readFileAsync是bluebird加上去的</p><pre class="prettyprint" style="line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; color: #333333; border-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; border-color: initial; background: #f7f7f7"><span style="color: #000088" class="kwd">var</span><span style="color: #000000" class="pln"> fs </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln"> </span><span style="color: #660066" class="typ">Promise</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">promisifyAll</span><span style="color: #666600" class="pun">(</span><span style="color: #000088" class="kwd">require</span><span style="color: #666600" class="pun">(</span><span style="color: #008800" class="str">&quot;fs&quot;</span><span style="color: #666600" class="pun">));</span></pre><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">其实也没什么神奇的，只是bb做的更多而已，让调用足够简便</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">下面我们来看一下mvc里的model层如何使用bb，我们先假定使用的是mongoose啊</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">先定义模型</p><pre class="prettyprint" style="line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; color: #333333; border-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; border-color: initial; background: #f7f7f7"><span style="color: #000088" class="kwd">var</span><span style="color: #000000" class="pln"> mongoose </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">require</span><span style="color: #666600" class="pun">(</span><span style="color: #008800" class="str">'mongoose'</span><span style="color: #666600" class="pun">);</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">var</span><span style="color: #000000" class="pln"> </span><span style="color: #660066" class="typ">Schema</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln"> mongoose</span><span style="color: #666600" class="pun">.</span><span style="color: #660066" class="typ">Schema</span><span style="color: #666600" class="pun">;</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">var</span><span style="color: #000000" class="pln"> </span><span style="color: #660066" class="typ">Promise</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">require</span><span style="color: #666600" class="pun">(</span><span style="color: #008800" class="str">&quot;bluebird&quot;</span><span style="color: #666600" class="pun">);</span><span style="color: #000000" class="pln">&nbsp;&nbsp;</span><span style="color: #660066" class="typ">UserSchema</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">new</span><span style="color: #000000" class="pln"> </span><span style="color: #660066" class="typ">Schema</span><span style="color: #666600" class="pun">(&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp; username</span><span style="color: #666600" class="pun">:</span><span style="color: #000000" class="pln"> </span><span style="color: #660066" class="typ">String</span><span style="color: #666600" class="pun">,</span><span style="color: #000000" class="pln">&nbsp;&nbsp; password</span><span style="color: #666600" class="pun">:</span><span style="color: #000000" class="pln"> </span><span style="color: #660066" class="typ">String</span><span style="color: #666600" class="pun">,</span><span style="color: #000000" class="pln">&nbsp;&nbsp; created_at</span><span style="color: #666600" class="pun">:</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; type</span><span style="color: #666600" class="pun">:</span><span style="color: #000000" class="pln"> </span><span style="color: #660066" class="typ">Date</span><span style="color: #666600" class="pun">,</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #008800" class="str">&quot;default&quot;</span><span style="color: #666600" class="pun">:</span><span style="color: #000000" class="pln"> </span><span style="color: #660066" class="typ">Date</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">now&nbsp;&nbsp; </span><span style="color: #666600" class="pun">&#125;</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;);</span><span style="color: #000000" class="pln">&nbsp;&nbsp;</span><span style="color: #000088" class="kwd">var</span><span style="color: #000000" class="pln"> </span><span style="color: #660066" class="typ">User</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln"> mongoose</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">model</span><span style="color: #666600" class="pun">(</span><span style="color: #008800" class="str">'User'</span><span style="color: #666600" class="pun">,</span><span style="color: #000000" class="pln"> </span><span style="color: #660066" class="typ">UserSchema</span><span style="color: #666600" class="pun">);</span><span style="color: #000000" class="pln">&nbsp;&nbsp;</span><span style="color: #660066" class="typ">Promise</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">promisifyAll</span><span style="color: #666600" class="pun">(</span><span style="color: #660066" class="typ">User</span><span style="color: #666600" class="pun">);</span><span style="color: #000000" class="pln"> </span><span style="color: #660066" class="typ">Promise</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">promisifyAll</span><span style="color: #666600" class="pun">(</span><span style="color: #660066" class="typ">User</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">prototype</span><span style="color: #666600" class="pun">);</span></pre><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">利用上面定义好的User模型，我们就可以写业务逻辑了</p><pre class="prettyprint" style="line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; color: #333333; border-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; border-color: initial; background: #f7f7f7"><span style="color: #660066" class="typ">User</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">findAsync</span><span style="color: #666600" class="pun">(&#123;</span><span style="color: #000000" class="pln">username</span><span style="color: #666600" class="pun">:</span><span style="color: #000000" class="pln"> username</span><span style="color: #666600" class="pun">&#125;).</span><span style="color: #000088" class="kwd">then</span><span style="color: #666600" class="pun">(</span><span style="color: #000088" class="kwd">function</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">data</span><span style="color: #666600" class="pun">)</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #666600" class="pun">...</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;).</span><span style="color: #000088" class="kwd">catch</span><span style="color: #666600" class="pun">(</span><span style="color: #000088" class="kwd">function</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">err</span><span style="color: #666600" class="pun">)</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #666600" class="pun">...</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;);</span></pre><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">再来个复杂的</p><pre class="prettyprint" style="line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; color: #333333; border-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; border-color: initial; background: #f7f7f7"><span style="color: #660066" class="typ">TeamPartner</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">updateAsync</span><span style="color: #666600" class="pun">(&#123;</span><span style="color: #000000" class="pln"> &nbsp;&nbsp;</span><span style="color: #666600" class="pun">...</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;,</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln"> &nbsp;&nbsp;$set</span><span style="color: #666600" class="pun">:</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln"> &nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #666600" class="pun">...</span><span style="color: #000000" class="pln"> &nbsp;&nbsp;</span><span style="color: #666600" class="pun">&#125;</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;).</span><span style="color: #000088" class="kwd">then</span><span style="color: #666600" class="pun">(</span><span style="color: #000088" class="kwd">function</span><span style="color: #666600" class="pun">()</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln"> &nbsp;&nbsp;</span><span style="color: #000088" class="kwd">return</span><span style="color: #000000" class="pln"> </span><span style="color: #660066" class="typ">User</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">findByIdAsync</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">user_id</span><span style="color: #666600" class="pun">);</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;).</span><span style="color: #000088" class="kwd">then</span><span style="color: #666600" class="pun">(</span><span style="color: #000088" class="kwd">function</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">team_owner</span><span style="color: #666600" class="pun">)</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln"> &nbsp;&nbsp;</span><span style="color: #000088" class="kwd">if</span><span style="color: #666600" class="pun">(</span><span style="color: #000088" class="kwd">typeof</span><span style="color: #000000" class="pln"> team_owner</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">partner_count </span><span style="color: #666600" class="pun">!=</span><span style="color: #000000" class="pln"> </span><span style="color: #008800" class="str">'undefined'</span><span style="color: #666600" class="pun">)</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; team_new_count </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln"> team_owner</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">partner_count </span><span style="color: #666600" class="pun">+</span><span style="color: #000000" class="pln"> </span><span style="color: #006666" class="lit">1</span><span style="color: #666600" class="pun">;</span><span style="color: #000000" class="pln">&nbsp;&nbsp; </span><span style="color: #666600" class="pun">&#125;</span><span style="color: #000088" class="kwd">else</span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; team_new_count </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln"> </span><span style="color: #006666" class="lit">1</span><span style="color: #666600" class="pun">;</span><span style="color: #000000" class="pln">&nbsp;&nbsp; </span><span style="color: #666600" class="pun">&#125;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #880000" class="com">// 创始人成员+1</span><span style="color: #000000" class="pln">&nbsp;&nbsp; </span><span style="color: #000088" class="kwd">return</span><span style="color: #000000" class="pln"> </span><span style="color: #660066" class="typ">User</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">findByIdAndUpdateAsync</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">user_id</span><span style="color: #666600" class="pun">,</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; $set</span><span style="color: #666600" class="pun">:</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #666600" class="pun">...</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #666600" class="pun">&#125;</span><span style="color: #000000" class="pln">&nbsp;&nbsp; </span><span style="color: #666600" class="pun">&#125;,</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; upsert</span><span style="color: #666600" class="pun">:</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">true</span><span style="color: #000000" class="pln">&nbsp;&nbsp; </span><span style="color: #666600" class="pun">&#125;);</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;).</span><span style="color: #000088" class="kwd">then</span><span style="color: #666600" class="pun">(</span><span style="color: #000088" class="kwd">function</span><span style="color: #666600" class="pun">()</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln"> &nbsp;&nbsp;</span><span style="color: #000088" class="kwd">return</span><span style="color: #000000" class="pln"> </span><span style="color: #660066" class="typ">Notify</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">findByIdAndUpdateAsync</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">notify_id</span><span style="color: #666600" class="pun">,</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln"> &nbsp;&nbsp;&nbsp;&nbsp;$set</span><span style="color: #666600" class="pun">:</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;read_status</span><span style="color: #666600" class="pun">:</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">true</span><span style="color: #000000" class="pln"> &nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #666600" class="pun">&#125;</span><span style="color: #000000" class="pln"> &nbsp;&nbsp;</span><span style="color: #666600" class="pun">&#125;);</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;).</span><span style="color: #000088" class="kwd">then</span><span style="color: #666600" class="pun">(</span><span style="color: #000088" class="kwd">function</span><span style="color: #666600" class="pun">()</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp; </span><span style="color: #000088" class="kwd">var</span><span style="color: #000000" class="pln"> notifySave </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">new</span><span style="color: #000000" class="pln"> </span><span style="color: #660066" class="typ">Notify</span><span style="color: #666600" class="pun">(&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #666600" class="pun">...</span><span style="color: #000000" class="pln">&nbsp;&nbsp; </span><span style="color: #666600" class="pun">&#125;);</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000088" class="kwd">return</span><span style="color: #000000" class="pln"> notifySave</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">saveAsync</span><span style="color: #666600" class="pun">();</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;).</span><span style="color: #000088" class="kwd">then</span><span style="color: #666600" class="pun">(</span><span style="color: #000088" class="kwd">function</span><span style="color: #666600" class="pun">()</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln"> &nbsp;&nbsp;</span><span style="color: #000088" class="kwd">return</span><span style="color: #000000" class="pln"> </span><span style="color: #660066" class="typ">User</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">findByIdAsync</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">user_join</span><span style="color: #666600" class="pun">);</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;).</span><span style="color: #000088" class="kwd">then</span><span style="color: #666600" class="pun">(</span><span style="color: #000088" class="kwd">function</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">joiner</span><span style="color: #666600" class="pun">)</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp; </span><span style="color: #000088" class="kwd">var</span><span style="color: #000000" class="pln"> teamSave </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">new</span><span style="color: #000000" class="pln"> </span><span style="color: #660066" class="typ">Team</span><span style="color: #666600" class="pun">(&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #666600" class="pun">...</span><span style="color: #000000" class="pln">&nbsp;&nbsp; </span><span style="color: #666600" class="pun">&#125;);</span><span style="color: #000000" class="pln">&nbsp;&nbsp; </span><span style="color: #000088" class="kwd">return</span><span style="color: #000000" class="pln"> teamSave</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">saveAsync</span><span style="color: #666600" class="pun">();</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;).</span><span style="color: #000088" class="kwd">then</span><span style="color: #666600" class="pun">(</span><span style="color: #000088" class="kwd">function</span><span style="color: #666600" class="pun">()</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln"> &nbsp;&nbsp;res</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">status</span><span style="color: #666600" class="pun">(</span><span style="color: #006666" class="lit">200</span><span style="color: #666600" class="pun">).</span><span style="color: #000000" class="pln">json</span><span style="color: #666600" class="pun">(&#123;</span><span style="color: #000000" class="pln"> &nbsp;&nbsp;&nbsp;&nbsp;data</span><span style="color: #666600" class="pun">:</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;&#125;,</span><span style="color: #000000" class="pln"> &nbsp;&nbsp;&nbsp;&nbsp;status</span><span style="color: #666600" class="pun">:</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;code</span><span style="color: #666600" class="pun">:</span><span style="color: #000000" class="pln"> </span><span style="color: #006666" class="lit">0</span><span style="color: #666600" class="pun">,</span><span style="color: #000000" class="pln"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msg</span><span style="color: #666600" class="pun">:</span><span style="color: #000000" class="pln"> </span><span style="color: #008800" class="str">'success'</span><span style="color: #000000" class="pln"> &nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #666600" class="pun">&#125;</span><span style="color: #000000" class="pln"> &nbsp;&nbsp;</span><span style="color: #666600" class="pun">&#125;);</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;).</span><span style="color: #000088" class="kwd">catch</span><span style="color: #666600" class="pun">(</span><span style="color: #000088" class="kwd">function</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">err</span><span style="color: #666600" class="pun">)</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln"> &nbsp;&nbsp;console</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">log</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">err</span><span style="color: #666600" class="pun">);</span><span style="color: #000000" class="pln"> &nbsp;&nbsp;res</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">status</span><span style="color: #666600" class="pun">(</span><span style="color: #006666" class="lit">200</span><span style="color: #666600" class="pun">).</span><span style="color: #000000" class="pln">json</span><span style="color: #666600" class="pun">(&#123;</span><span style="color: #000000" class="pln"> &nbsp;&nbsp;&nbsp;&nbsp;data</span><span style="color: #666600" class="pun">:</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;&#125;,</span><span style="color: #000000" class="pln"> &nbsp;&nbsp;&nbsp;&nbsp;status</span><span style="color: #666600" class="pun">:</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;code</span><span style="color: #666600" class="pun">:</span><span style="color: #000000" class="pln"> err</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">code</span><span style="color: #666600" class="pun">,</span><span style="color: #000000" class="pln"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msg</span><span style="color: #666600" class="pun">:</span><span style="color: #000000" class="pln"> err</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">name &nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #666600" class="pun">&#125;</span><span style="color: #000000" class="pln"> &nbsp;&nbsp;</span><span style="color: #666600" class="pun">&#125;);</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;);</span></pre><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">很抱歉，伤害大家了，但确切是有这样用，我想问，脑子抽么？</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">优化方案</p><ul style="padding: 0px; margin: 0px 0px 10px 25px; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-size: 14px; line-height: 28px"><li style="line-height: 2em">mongoose上的static和method上扩展，别暴漏太多细节在控制层</li><li style="line-height: 2em">面向promise，保证每个操作都是一个函数，让流程可以组装，不要忘了最初then的初衷</li></ul><pre class="prettyprint" style="line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; color: #333333; border-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; border-color: initial; background: #f7f7f7"><span style="color: #000088" class="kwd">function</span><span style="color: #000000" class="pln"> find_user</span><span style="color: #666600" class="pun">()</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln"> &nbsp;&nbsp;</span><span style="color: #000088" class="kwd">return</span><span style="color: #000000" class="pln"> </span><span style="color: #660066" class="typ">User</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">findByIdAsync</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">user_id</span><span style="color: #666600" class="pun">);</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;</span><span style="color: #000088" class="kwd">function</span><span style="color: #000000" class="pln"> find_user2</span><span style="color: #666600" class="pun">()</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln"> &nbsp;&nbsp;</span><span style="color: #000088" class="kwd">return</span><span style="color: #000000" class="pln"> </span><span style="color: #660066" class="typ">User</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">findByIdAsync</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">user_id</span><span style="color: #666600" class="pun">);</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;</span><span style="color: #000088" class="kwd">function</span><span style="color: #000000" class="pln"> error</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">ex</span><span style="color: #666600" class="pun">)&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp; console</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">log</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">ex</span><span style="color: #666600" class="pun">);</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;</span><span style="color: #660066" class="typ">TeamPartner</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">updateByXXAsync</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">a</span><span style="color: #666600" class="pun">,</span><span style="color: #000000" class="pln">b</span><span style="color: #666600" class="pun">,</span><span style="color: #000000" class="pln">c</span><span style="color: #666600" class="pun">).</span><span style="color: #000088" class="kwd">then</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">find_user</span><span style="color: #666600" class="pun">).</span><span style="color: #000088" class="kwd">then</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">find_user2</span><span style="color: #666600" class="pun">).</span><span style="color: #000088" class="kwd">catch</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">error</span><span style="color: #666600" class="pun">)</span></pre><h2 style="margin: 30px 0px 15px; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; line-height: 40px; color: #333333; text-rendering: optimizeLegibility; font-size: 26px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #eeeeee">开源项目里的promise</h2><ul style="padding: 0px; margin: 0px 0px 10px 25px; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-size: 14px; line-height: 28px"><li style="line-height: 2em">ioredis</li><li style="line-height: 2em">mongoose &amp;&amp; mongoskin</li></ul><h3 style="margin: 30px 0px 15px; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; line-height: 40px; color: #333333; text-rendering: optimizeLegibility; font-size: 24.5px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #eeeeee">ioredis</h3><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif"><a style="color: #0088cc; text-decoration: none" href="https://github.com/luin/ioredis" target="_blank">https://github.com/luin/ioredis</a></p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">ioredis是redis库里的首选，其实它是基于node_redis的，增加和优化了很多，其中关于promise的一点是</p><pre class="prettyprint" style="line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; color: #333333; border-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; border-color: initial; background: #f7f7f7"><span style="color: #660066" class="typ">Delightful</span><span style="color: #000000" class="pln"> API</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln"> </span><span style="color: #660066" class="typ">It</span><span style="color: #000000" class="pln"> works </span><span style="color: #000088" class="kwd">with</span><span style="color: #000000" class="pln"> </span><span style="color: #660066" class="typ">Node</span><span style="color: #000000" class="pln"> callbacks </span><span style="color: #000088" class="kwd">and</span><span style="color: #000000" class="pln"> </span><span style="color: #660066" class="typ">Bluebird</span><span style="color: #000000" class="pln"> promises</span><span style="color: #666600" class="pun">.</span></pre><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">用法</p><pre class="prettyprint" style="line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; color: #333333; border-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; border-color: initial; background: #f7f7f7"><span style="color: #000000" class="pln">redis</span><span style="color: #666600" class="pun">.</span><span style="color: #000088" class="kwd">get</span><span style="color: #666600" class="pun">(</span><span style="color: #008800" class="str">'foo'</span><span style="color: #666600" class="pun">).</span><span style="color: #000088" class="kwd">then</span><span style="color: #666600" class="pun">(</span><span style="color: #000088" class="kwd">function</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">result</span><span style="color: #666600" class="pun">)</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp; console</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">log</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">result</span><span style="color: #666600" class="pun">);</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;);</span></pre><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">真心比node_redis好用的多。</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">luin是《Redis入门指南》一书作者，90后，全栈+设计，写过不少nodejs模块，目前就在群里</p><h3 style="margin: 30px 0px 15px; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; line-height: 40px; color: #333333; text-rendering: optimizeLegibility; font-size: 24.5px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #eeeeee">mongoose &amp;&amp; mongoskin</h3><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">mongoose是nodejs处理mongodb的不二选择，简单说一下mongoskin</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">官方说</p><pre class="prettyprint" style="line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; color: #333333; border-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; border-color: initial; background: #f7f7f7"><span style="color: #660066" class="typ">The</span><span style="color: #000000" class="pln"> promise wrapper </span><span style="color: #000088" class="kwd">for</span><span style="color: #000000" class="pln"> node</span><span style="color: #666600" class="pun">-</span><span style="color: #000000" class="pln">mongodb</span><span style="color: #666600" class="pun">-</span><span style="color: #000088" class="kwd">native</span><span style="color: #666600" class="pun">.</span></pre><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">做了很多api上的优化，还是不错的，可是mongoose也出了promise</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">mongoose仿佛在喊：&ldquo;用我，我也可以then&rdquo;。。。。</p><h1 style="margin: 30px 0px 15px; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; line-height: 40px; color: #333333; text-rendering: optimizeLegibility; font-size: 32.5px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #eeeeee">4）最后给出未来展望</h1><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">未来主要是es6和es7上的实现</p><ul style="padding: 0px; margin: 0px 0px 10px 25px; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-size: 14px; line-height: 28px"><li style="line-height: 2em">es6上的Generators/yield</li><li style="line-height: 2em">es7上的Async/await</li></ul><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">都是好东西，可以尝试，毕竟早晚js还是要升级的，先做技术储备吧</p><h2 style="margin: 30px 0px 15px; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; line-height: 40px; color: #333333; text-rendering: optimizeLegibility; font-size: 26px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #eeeeee">生成器Generators/yield</h2><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">生成器是ES6（也被称为ES2015）的新特性。</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">想象下面这样的一个场景：</p><pre class="prettyprint" style="line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; color: #333333; border-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; border-color: initial; background: #f7f7f7"><span style="color: #666600" class="pun">当你在执行一个函数的时候，你可以在某个点暂停函数的执行，并且做一些其他工作，然后再返回这个函数继续执行，</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">甚至是携带一些新的值，然后继续执行。</span></pre><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">上面描述的场景正是JavaScript生成器函数所致力于解决的问题。</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">当我们调用一个生成器函数的时候，它并不会立即执行， 而是需要我们手动的去执行迭代操作（next方法）。也就是说，你调用生成器函数，它会返回给你一个迭代器。迭代器会遍历每个中断点。</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">看例子</p><pre class="prettyprint" style="line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; color: #333333; border-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; border-color: initial; background: #f7f7f7"><span style="color: #000088" class="kwd">function</span><span style="color: #666600" class="pun">*</span><span style="color: #000000" class="pln"> foo </span><span style="color: #666600" class="pun">()</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #000088" class="kwd">var</span><span style="color: #000000" class="pln"> index </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln"> </span><span style="color: #006666" class="lit">0</span><span style="color: #666600" class="pun">;</span><span style="color: #000000" class="pln">&nbsp;&nbsp; </span><span style="color: #000088" class="kwd">while</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">index </span><span style="color: #666600" class="pun">&lt;</span><span style="color: #000000" class="pln"> </span><span style="color: #006666" class="lit">2</span><span style="color: #666600" class="pun">)</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #000088" class="kwd">yield</span><span style="color: #000000" class="pln"> index</span><span style="color: #666600" class="pun">++;</span><span style="color: #000000" class="pln"> </span><span style="color: #880000" class="com">//暂停函数执行，并执行yield后的操作</span><span style="color: #000000" class="pln">&nbsp;&nbsp; </span><span style="color: #666600" class="pun">&#125;</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;</span><span style="color: #000088" class="kwd">var</span><span style="color: #000000" class="pln"> bar </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln">&nbsp;&nbsp;foo</span><span style="color: #666600" class="pun">();</span><span style="color: #000000" class="pln"> </span><span style="color: #880000" class="com">// 返回的其实是一个迭代器</span><span style="color: #000000" class="pln">&nbsp;&nbsp;console</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">log</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">bar</span><span style="color: #666600" class="pun">.</span><span style="color: #000088" class="kwd">next</span><span style="color: #666600" class="pun">());</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #880000" class="com">// &#123; value: 0, done: false &#125;&nbsp;&nbsp;</span><span style="color: #000000" class="pln"> console</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">log</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">bar</span><span style="color: #666600" class="pun">.</span><span style="color: #000088" class="kwd">next</span><span style="color: #666600" class="pun">());</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #880000" class="com">// &#123; value: 1, done: false &#125;&nbsp;&nbsp;</span><span style="color: #000000" class="pln"> console</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">log</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">bar</span><span style="color: #666600" class="pun">.</span><span style="color: #000088" class="kwd">next</span><span style="color: #666600" class="pun">());</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #880000" class="com">// &#123; value: undefined, done: true &#125;&nbsp;&nbsp;</span></pre><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">如果你想更轻松的使用生成器函数来编写异步JavaScript代码，我们可以使用 co 这个库，co是著名的tj大神写的，是一个为Node.js和浏览器打造的基于生成器的流程控制工具，借助于Promise，你可以使用更加优雅的方式编写非阻塞代码。</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">使用co，改写前面的示例代码：</p><pre class="prettyprint" style="line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; color: #333333; border-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; border-color: initial; background: #f7f7f7"><span style="color: #000000" class="pln">co</span><span style="color: #666600" class="pun">(</span><span style="color: #000088" class="kwd">function</span><span style="color: #666600" class="pun">*</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">()&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #000088" class="kwd">yield</span><span style="color: #000000" class="pln"> </span><span style="color: #660066" class="typ">Something</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">save</span><span style="color: #666600" class="pun">();</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;).</span><span style="color: #000088" class="kwd">then</span><span style="color: #666600" class="pun">(</span><span style="color: #000088" class="kwd">function</span><span style="color: #666600" class="pun">()</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp; </span><span style="color: #880000" class="com">// success</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;)</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">.</span><span style="color: #000088" class="kwd">catch</span><span style="color: #666600" class="pun">(</span><span style="color: #000088" class="kwd">function</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">err</span><span style="color: #666600" class="pun">)</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp; </span><span style="color: #880000" class="com">//error handling</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;);</span></pre><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">你可能会问：如何实现并行操作呢？答案可能比你想象的简单，如下</p><pre class="prettyprint" style="line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; color: #333333; border-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; border-color: initial; background: #f7f7f7"><span style="color: #000088" class="kwd">yield</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">[</span><span style="color: #000000" class="pln">a</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">save</span><span style="color: #666600" class="pun">(),</span><span style="color: #000000" class="pln"> b</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">save</span><span style="color: #666600" class="pun">()];</span><span style="color: #000000" class="pln">&nbsp;&nbsp;</span></pre><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">其实它就是Promise.all，换种写法而已</p><h2 style="margin: 30px 0px 15px; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; line-height: 40px; color: #333333; text-rendering: optimizeLegibility; font-size: 26px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #eeeeee">Async/await</h2><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">在ES7（还未正式标准化）中引入了Async函数的概念，目前如果你想要使用的话，只能借助于babel 这样的语法转换器将其转为ES5代码。</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">使用async关键字，可以轻松地达成之前使用生成器和co函数所做到的工作。当然，hack除外</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">可以这样理解，async函数实际使用的是Promise，然后使用await来执行异步操作，这里的await类似于上面讲的yield</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">因此，使用async重写上面的代码：</p><pre class="prettyprint" style="line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; color: #333333; border-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; border-color: initial; background: #f7f7f7"><span style="color: #000000" class="pln">async </span><span style="color: #000088" class="kwd">function</span><span style="color: #000000" class="pln"> save</span><span style="color: #666600" class="pun">(</span><span style="color: #660066" class="typ">Something</span><span style="color: #666600" class="pun">)</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #000088" class="kwd">try</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; await </span><span style="color: #660066" class="typ">Something</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">save</span><span style="color: #666600" class="pun">();</span><span style="color: #000000" class="pln"> </span><span style="color: #880000" class="com">// 等待await后面的代码执行完，类似于yield</span><span style="color: #000000" class="pln">&nbsp;&nbsp; </span><span style="color: #666600" class="pun">&#125;</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">catch</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">err</span><span style="color: #666600" class="pun">)</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #880000" class="com">//error handling</span><span style="color: #000000" class="pln">&nbsp;&nbsp; </span><span style="color: #666600" class="pun">&#125;</span><span style="color: #000000" class="pln">&nbsp;&nbsp; console</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">log</span><span style="color: #666600" class="pun">(</span><span style="color: #008800" class="str">'success'</span><span style="color: #666600" class="pun">);</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;</span></pre><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">下一代web框架Koa也支持async函数，如果你也在使用koa，那么你现在就可以借助babel使用这一特性了</p><pre class="prettyprint" style="line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; color: #333333; border-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; border-color: initial; background: #f7f7f7"><span style="color: #000088" class="kwd">import</span><span style="color: #000000" class="pln"> koa </span><span style="color: #000088" class="kwd">from</span><span style="color: #000000" class="pln"> koa</span><span style="color: #666600" class="pun">;</span><span style="color: #000000" class="pln">&nbsp;&nbsp; let app </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln"> koa</span><span style="color: #666600" class="pun">();</span><span style="color: #000000" class="pln">&nbsp;&nbsp;app</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">experimental </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln"> </span><span style="color: #000088" class="kwd">true</span><span style="color: #666600" class="pun">;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;app</span><span style="color: #666600" class="pun">.</span><span style="color: #000088" class="kwd">use</span><span style="color: #666600" class="pun">(</span><span style="color: #000000" class="pln">async </span><span style="color: #000088" class="kwd">function</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">()&#123;</span><span style="color: #000000" class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #000088" class="kwd">this</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">body </span><span style="color: #666600" class="pun">=</span><span style="color: #000000" class="pln"> await </span><span style="color: #660066" class="typ">Promise</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">resolve</span><span style="color: #666600" class="pun">(</span><span style="color: #008800" class="str">'Hello Reader!'</span><span style="color: #666600" class="pun">)</span><span style="color: #000000" class="pln"> </span><span style="color: #666600" class="pun">&#125;)</span><span style="color: #000000" class="pln">&nbsp;&nbsp;app</span><span style="color: #666600" class="pun">.</span><span style="color: #000000" class="pln">listen</span><span style="color: #666600" class="pun">(</span><span style="color: #006666" class="lit">3000</span><span style="color: #666600" class="pun">);</span><span style="color: #000000" class="pln">&nbsp;&nbsp;</span></pre><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">这里报个料，群里<a style="color: #0088cc; text-decoration: none" href="https://github.com/fundon" target="_blank">fundon</a> 大神写的https://github.com/trekjs/trek 是基于koa的，使用babel编译，并有更多相当棒的特性。爱折腾的可以试试</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">最后还是要归纳总结一下，</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">先复习promise/a+的四个要点</p><ul style="padding: 0px; margin: 0px 0px 10px 25px; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-size: 14px; line-height: 28px"><li style="line-height: 2em">a) 异步操作的最终结果，尽可能每一个异步操作都是独立操作单元</li><li style="line-height: 2em">b) 与Promise最主要的交互方法是通过将函数传入它的then方法（thenable）</li><li style="line-height: 2em">c) 捕获异常catch error</li><li style="line-height: 2em">d) 根据reject和resolve重塑流程</li></ul><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">已经第三遍，该记住了！</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">继续看第一个图</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif"><img style="height: auto; max-width: 100%; vertical-align: middle; border: 0px; cursor: pointer" src="http://dn-cnode.qbox.me/FgKu20kvFqHrkgpjbQxXkV1DmrG1" border="0" alt="1.png" /></p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">再来看这张图，从callback到promose是历史的必然产物</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">generator是一种新的定义方式，定义操作单元，尤其在迭代器的情况，搭配yield来执行，可读性上差了很多，好处是真的解耦了</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">co是一个中间产品，可以说是给generator增加了promise实现，可读性和易用性是愿意好于generator + yield的</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">最后我们看看async，它实际上是通过async这个关键词，定义的函数就可以返回promise对象，可以说async就是能返回promise对象的generator。yield关键词以及被generator绑架了，那它就换个名字，叫await</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">其实从这段历史来看，反复就是promise上的折腾，只是加了generator这个别名，只是async是能返回promise的generator</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">这样理解是不是更简单呢？</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">万变不离其宗，想精通js或者nodejs，promise是大家必须迈过去的坑。</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">谢谢大家，今天讲的内容就到这里，如果有什么讲的不对的、不合理的，请不吝赐教，共同学习</p><p style="margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif">大家有任何不明白或者想提问的可以随时私信给小助手，我会在答疑阶段统一回答</p><h2 style="margin: 30px 0px 15px; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; line-height: 40px; color: #333333; text-rendering: optimizeLegibility; font-size: 26px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #eeeeee">推荐资料</h2><ul style="padding: 0px; margin: 0px 0px 10px 25px; color: #333333; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-size: 14px; line-height: 28px"><li style="line-height: 2em"><a style="color: #0088cc; text-decoration: none" href="http://liubin.github.io/promises-book/#introduction" target="_blank">http://liubin.github.io/promises-book/#introduction</a></li><li style="line-height: 2em"><a style="color: #0088cc; text-decoration: none" href="http://www.mattgreer.org/articles/promises-in-wicked-detail/" target="_blank">http://www.mattgreer.org/articles/promises-in-wicked-detail/</a></li></ul>
]]>
</description>
</item><item>
<link>http://i.renjihe.com/blog/read.php?7513</link>
<title><![CDATA[nodejs异步控制利器Async]]></title> 
<author>renjihe1988 &lt;admin@yourname.com&gt;</author>
<category><![CDATA[web]]></category>
<pubDate>Mon, 29 Aug 2016 06:34:57 +0000</pubDate> 
<guid>http://i.renjihe.com/blog/read.php?7513</guid> 
<description>
<![CDATA[ 
	<p style="margin: 0px 0px 1.1em; padding: 0px; box-sizing: border-box; color: #555555; font-family: 'microsoft yahei'; font-size: 14px; line-height: 35px">Node.js 是一个基于 Chrome V8 引擎的 JavaScript 运行环境。Node.js 使用了一个事件驱动、非阻塞式 I/O 的模型，使其轻量又高效。&nbsp;<br />因为是js语言，也就是说，凡是懂得一点js或者jquery，对nodejs入手相当的快，而且没过多久你就会爱上nodejs！</p><h3 style="margin: 0.8em 0px; padding: 0px; box-sizing: border-box; font-weight: 100; color: #555555; font-family: 'microsoft yahei'; line-height: 35px"><a style="box-sizing: border-box; color: #0c89cf" name="t0"></a>但是！但是！但是！</h3><p style="margin: 0px 0px 1.1em; padding: 0px; box-sizing: border-box; color: #555555; font-family: 'microsoft yahei'; font-size: 14px; line-height: 35px">nodejs是基于异步的写法，有时一个函数需要上一个函数的返回值做参数，这样下来一不小心就会陷入回调地狱的陷阱中。（一把辛酸泪-_-!!!）&nbsp;<br />下面的一个相当简单的需求</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)">将A、B、<span style="box-sizing: border-box; color: #000088" class="hljs-keyword">C</span>文件里面的内容读取出来存到<span style="box-sizing: border-box; color: #000088" class="hljs-keyword">D</span>文件中<ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li></ul></pre><p style="margin: 0px 0px 1.1em; padding: 0px; box-sizing: border-box; color: #555555; font-family: 'microsoft yahei'; font-size: 14px; line-height: 35px">普通的写法如下</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">var</span> fs = <span style="box-sizing: border-box; color: #660066" class="hljs-built_in">require</span>(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'fs'</span>); fs.readFile(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'D:&#92;&#92;test&#92;&#92;A.txt'</span>,<span style="box-sizing: border-box" class="hljs-function"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">function</span><span style="box-sizing: border-box; color: #660066" class="hljs-params">(err,data1)</span>&#123;</span>&nbsp;&nbsp; fs.readFile(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'D:&#92;&#92;test&#92;&#92;B.txt'</span>,<span style="box-sizing: border-box" class="hljs-function"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">function</span><span style="box-sizing: border-box; color: #660066" class="hljs-params">(err,data2)</span>&#123;</span>&nbsp;&nbsp;&nbsp;&nbsp; fs.readFile(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'D:&#92;&#92;test&#92;&#92;C.txt'</span>,<span style="box-sizing: border-box" class="hljs-function"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">function</span><span style="box-sizing: border-box; color: #660066" class="hljs-params">(err,data3)</span>&#123;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(data1+<span style="box-sizing: border-box; color: #008800" class="hljs-string">'&gt;&gt;&gt;'</span>+data2+<span style="box-sizing: border-box; color: #008800" class="hljs-string">'&gt;&gt;&gt;'</span>+data3);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fs.writeFile(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'D:&#92;&#92;test&#92;&#92;D.txt'</span>,data1+<span style="box-sizing: border-box; color: #008800" class="hljs-string">'&gt;&gt;&gt;'</span>+data2+<span style="box-sizing: border-box; color: #008800" class="hljs-string">'&gt;&gt;&gt;'</span>+data3,<span style="box-sizing: border-box" class="hljs-function"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">function</span><span style="box-sizing: border-box; color: #660066" class="hljs-params">(err)</span>&#123;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(err);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;);&nbsp;&nbsp;&nbsp;&nbsp; &#125;);&nbsp;&nbsp; &#125;); &#125;);<ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li><li style="box-sizing: border-box; padding: 0px 5px">11</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li><li style="box-sizing: border-box; padding: 0px 5px">11</li></ul></pre><p style="margin: 0px 0px 1.1em; padding: 0px; box-sizing: border-box; color: #555555; font-family: 'microsoft yahei'; font-size: 14px; line-height: 35px">如果再来个a，b，c等等文件，各种嵌套，一是看起来很凌乱，二是后来维护起来是相当的困难！&nbsp;<br />那么为了避免这样的问题，也有一些模块来解决，比如Promise，Async，co等等，使用哪种来控制异步流程，我也纠结了许久，最终选择使用Async，有人说Asunc是一代，promise是二代，co是三代。于是毫不犹豫的选择了Async.&nbsp;<br />在此推荐相当详细的demo地址&nbsp;<br /><a style="text-decoration: none; box-sizing: border-box; color: #0c89cf" href="https://github.com/bsspirit/async_demo">GitHub地址</a>&nbsp;<br />里面把asunc所有的方法重新讲解了一遍，很详细。&nbsp;<br />我下面要介绍的是四种控制流程&nbsp;<br />* 串行无关联&nbsp;<br />* 串行有关联&nbsp;<br />* 并行无关联&nbsp;<br />* 只能控制</p><p style="margin: 0px 0px 1.1em; padding: 0px; box-sizing: border-box; color: #555555; font-family: 'microsoft yahei'; font-size: 14px; line-height: 35px">下载async模块</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)">npm install async<ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li></ul></pre><h3 style="margin: 0.8em 0px; padding: 0px; box-sizing: border-box; font-weight: 100; color: #555555; font-family: 'microsoft yahei'; line-height: 35px"><a style="box-sizing: border-box; color: #0c89cf" name="t1"></a>串行无关联</h3><p style="margin: 0px 0px 1.1em; padding: 0px; box-sizing: border-box; color: #555555; font-family: 'microsoft yahei'; font-size: 14px; line-height: 35px">多个函数或方法要依次执行，但是他们之间并没有什么联系，只有先后的顺序，比如我要写一个文件，写完之后像用户发送邮件，这两者之间没有必然的联系，但是发邮件必须在写文件完成之后。&nbsp;<br />async里有一个方法series可以实现这一流程,代码实现如下：</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">var</span> async = <span style="box-sizing: border-box; color: #660066" class="hljs-built_in">require</span>(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'async'</span>); console.time(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'series'</span>); async.series(&#123;&nbsp;&nbsp;&nbsp;&nbsp; one: <span style="box-sizing: border-box" class="hljs-function"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">function</span><span style="box-sizing: border-box; color: #660066" class="hljs-params">(callback)</span> &#123;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; callback(<span style="box-sizing: border-box; color: #006666" class="hljs-literal">null</span>, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'one'</span>);<span style="box-sizing: border-box; color: #880000" class="hljs-comment">//callback('i am err','one');异常处理</span>&nbsp;&nbsp;&nbsp;&nbsp; &#125;,&nbsp;&nbsp;&nbsp;&nbsp; two: <span style="box-sizing: border-box" class="hljs-function"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">function</span><span style="box-sizing: border-box; color: #660066" class="hljs-params">(callback)</span> &#123;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; callback(<span style="box-sizing: border-box; color: #006666" class="hljs-literal">null</span>, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'two'</span>);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#125;, &#125;, <span style="box-sizing: border-box" class="hljs-function"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">function</span><span style="box-sizing: border-box; color: #660066" class="hljs-params">(error, result)</span> &#123;</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #880000" class="hljs-comment">//最后结果</span>&nbsp;&nbsp;&nbsp;&nbsp; console.log(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'error: '</span> + error);&nbsp;&nbsp;&nbsp;&nbsp; console.log(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'result: '</span> + result);&nbsp;&nbsp;&nbsp;&nbsp; console.timeEnd(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'series'</span>); &#125;);<ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li><li style="box-sizing: border-box; padding: 0px 5px">11</li><li style="box-sizing: border-box; padding: 0px 5px">12</li><li style="box-sizing: border-box; padding: 0px 5px">13</li><li style="box-sizing: border-box; padding: 0px 5px">14</li><li style="box-sizing: border-box; padding: 0px 5px">15</li><li style="box-sizing: border-box; padding: 0px 5px">16</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li><li style="box-sizing: border-box; padding: 0px 5px">11</li><li style="box-sizing: border-box; padding: 0px 5px">12</li><li style="box-sizing: border-box; padding: 0px 5px">13</li><li style="box-sizing: border-box; padding: 0px 5px">14</li><li style="box-sizing: border-box; padding: 0px 5px">15</li><li style="box-sizing: border-box; padding: 0px 5px">16</li></ul></pre><p style="margin: 0px 0px 1.1em; padding: 0px; box-sizing: border-box; color: #555555; font-family: 'microsoft yahei'; font-size: 14px; line-height: 35px">结果</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)">error: null result: [object Object] series: <span style="box-sizing: border-box; color: #006666" class="hljs-number">4.472</span>ms<ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li></ul></pre><p style="margin: 0px 0px 1.1em; padding: 0px; box-sizing: border-box; color: #555555; font-family: 'microsoft yahei'; font-size: 14px; line-height: 35px">串行流程，one执行完再执行two，如果有three、four等方法，依次写下去，callback(arg1,arg2),两个参数，arg1是异常，arg2是方法的返回值，如果某个函数中arg1不为空，则程序到此终止，之后的不再执行，可自行测试！&nbsp;<br /><strong style="box-sizing: border-box">注意:waterfall不能使用对象表示法来传递(json格式)</strong></p><h3 style="margin: 0.8em 0px; padding: 0px; box-sizing: border-box; font-weight: 100; color: #555555; font-family: 'microsoft yahei'; line-height: 35px"><a style="box-sizing: border-box; color: #0c89cf" name="t2"></a>串行有关联</h3><p style="margin: 0px 0px 1.1em; padding: 0px; box-sizing: border-box; color: #555555; font-family: 'microsoft yahei'; font-size: 14px; line-height: 35px">多个函数或方法执行，每一步执行时都需要上一步执行的结果当参数，所以就会有串行等待。async里有waterfall可以实现此场景：</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">var</span> async = <span style="box-sizing: border-box; color: #660066" class="hljs-built_in">require</span>(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'async'</span>); console.time(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'waterfall'</span>); async.waterfall([&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box" class="hljs-function"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">function</span><span style="box-sizing: border-box; color: #660066" class="hljs-params">(callback)</span> &#123;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; callback(<span style="box-sizing: border-box; color: #006666" class="hljs-literal">null</span>, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'one'</span>);&nbsp;&nbsp;&nbsp;&nbsp; &#125;,&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box" class="hljs-function"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">function</span><span style="box-sizing: border-box; color: #660066" class="hljs-params">(onearg, callback)</span> &#123;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; callback(<span style="box-sizing: border-box; color: #006666" class="hljs-literal">null</span>, onearg + <span style="box-sizing: border-box; color: #008800" class="hljs-string">'&gt;&gt;&gt;two'</span>);&nbsp;&nbsp;&nbsp;&nbsp; &#125;,&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box" class="hljs-function"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">function</span><span style="box-sizing: border-box; color: #660066" class="hljs-params">(twoarg, callback)</span> &#123;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; callback(<span style="box-sizing: border-box; color: #006666" class="hljs-literal">null</span>, twoarg + <span style="box-sizing: border-box; color: #008800" class="hljs-string">'&gt;&gt;&gt;three'</span>);&nbsp;&nbsp;&nbsp;&nbsp; &#125;,&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box" class="hljs-function"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">function</span><span style="box-sizing: border-box; color: #660066" class="hljs-params">(threearg, callback)</span> &#123;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; callback(<span style="box-sizing: border-box; color: #006666" class="hljs-literal">null</span>, threearg + <span style="box-sizing: border-box; color: #008800" class="hljs-string">'&gt;&gt;&gt;four'</span>);&nbsp;&nbsp;&nbsp;&nbsp; &#125; ], <span style="box-sizing: border-box" class="hljs-function"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">function</span><span style="box-sizing: border-box; color: #660066" class="hljs-params">(error, result)</span> &#123;</span>&nbsp;&nbsp;&nbsp;&nbsp; console.log(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'error: '</span> + error);&nbsp;&nbsp;&nbsp;&nbsp; console.log(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'result: '</span> + result);&nbsp;&nbsp;&nbsp;&nbsp; console.timeEnd(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'waterfall'</span>); &#125;);<ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li><li style="box-sizing: border-box; padding: 0px 5px">11</li><li style="box-sizing: border-box; padding: 0px 5px">12</li><li style="box-sizing: border-box; padding: 0px 5px">13</li><li style="box-sizing: border-box; padding: 0px 5px">14</li><li style="box-sizing: border-box; padding: 0px 5px">15</li><li style="box-sizing: border-box; padding: 0px 5px">16</li><li style="box-sizing: border-box; padding: 0px 5px">17</li><li style="box-sizing: border-box; padding: 0px 5px">18</li><li style="box-sizing: border-box; padding: 0px 5px">19</li><li style="box-sizing: border-box; padding: 0px 5px">20</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li><li style="box-sizing: border-box; padding: 0px 5px">11</li><li style="box-sizing: border-box; padding: 0px 5px">12</li><li style="box-sizing: border-box; padding: 0px 5px">13</li><li style="box-sizing: border-box; padding: 0px 5px">14</li><li style="box-sizing: border-box; padding: 0px 5px">15</li><li style="box-sizing: border-box; padding: 0px 5px">16</li><li style="box-sizing: border-box; padding: 0px 5px">17</li><li style="box-sizing: border-box; padding: 0px 5px">18</li><li style="box-sizing: border-box; padding: 0px 5px">19</li><li style="box-sizing: border-box; padding: 0px 5px">20</li></ul></pre><p style="margin: 0px 0px 1.1em; padding: 0px; box-sizing: border-box; color: #555555; font-family: 'microsoft yahei'; font-size: 14px; line-height: 35px">结果</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)">error: null result: one&gt;&gt;&gt;two&gt;&gt;&gt;three&gt;&gt;&gt;four waterfall: <span style="box-sizing: border-box; color: #006666" class="hljs-number">4.516</span>ms<ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li></ul></pre><p style="margin: 0px 0px 1.1em; padding: 0px; box-sizing: border-box; color: #555555; font-family: 'microsoft yahei'; font-size: 14px; line-height: 35px">这个比较series换了个方法名之外，每个函数多了个参数第二个函数中onearg则是第一个函数的值，以此类推，callback中没变，如果有异常，立即终止可自行验证;</p><h3 style="margin: 0.8em 0px; padding: 0px; box-sizing: border-box; font-weight: 100; color: #555555; font-family: 'microsoft yahei'; line-height: 35px"><a style="box-sizing: border-box; color: #0c89cf" name="t3"></a>并行无关联</h3><p style="margin: 0px 0px 1.1em; padding: 0px; box-sizing: border-box; color: #555555; font-family: 'microsoft yahei'; font-size: 14px; line-height: 35px">多个函数执行，之间没有任何的关系，也就是说谁执行都行，为了节约时间就可以使用并行流程来解决，如下：</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">var</span> async = <span style="box-sizing: border-box; color: #660066" class="hljs-built_in">require</span>(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'async'</span>); console.time(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'parallel'</span>); async.parallel(&#123;&nbsp;&nbsp;&nbsp;&nbsp; one: <span style="box-sizing: border-box" class="hljs-function"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">function</span><span style="box-sizing: border-box; color: #660066" class="hljs-params">(callback)</span> &#123;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #880000" class="hljs-comment">//处理逻辑</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; callback(<span style="box-sizing: border-box; color: #006666" class="hljs-literal">null</span>, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'one'</span>);&nbsp;&nbsp;&nbsp;&nbsp; &#125;,&nbsp;&nbsp;&nbsp;&nbsp; two: <span style="box-sizing: border-box" class="hljs-function"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">function</span><span style="box-sizing: border-box; color: #660066" class="hljs-params">(callback)</span> &#123;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #880000" class="hljs-comment">//处理逻辑</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; callback(<span style="box-sizing: border-box; color: #006666" class="hljs-literal">null</span>, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'tow'</span>);&nbsp;&nbsp;&nbsp;&nbsp; &#125;,&nbsp;&nbsp;&nbsp;&nbsp; three: <span style="box-sizing: border-box" class="hljs-function"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">function</span><span style="box-sizing: border-box; color: #660066" class="hljs-params">(callback)</span> &#123;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #880000" class="hljs-comment">//处理逻辑</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; callback(<span style="box-sizing: border-box; color: #006666" class="hljs-literal">null</span>, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'three'</span>);&nbsp;&nbsp;&nbsp;&nbsp; &#125;,&nbsp;&nbsp;&nbsp;&nbsp; four: <span style="box-sizing: border-box" class="hljs-function"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">function</span><span style="box-sizing: border-box; color: #660066" class="hljs-params">(callback)</span> &#123;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="box-sizing: border-box; color: #880000" class="hljs-comment">//处理逻辑</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; callback(<span style="box-sizing: border-box; color: #006666" class="hljs-literal">null</span>, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'four'</span>);&nbsp;&nbsp;&nbsp;&nbsp; &#125; &#125;, <span style="box-sizing: border-box" class="hljs-function"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">function</span><span style="box-sizing: border-box; color: #660066" class="hljs-params">(error, result)</span> &#123;</span>&nbsp;&nbsp;&nbsp;&nbsp; console.log(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'one:'</span>, result.one);&nbsp;&nbsp;&nbsp;&nbsp; console.log(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'two:'</span>, result.two);&nbsp;&nbsp;&nbsp;&nbsp; console.log(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'three:'</span>, result.three);&nbsp;&nbsp;&nbsp;&nbsp; console.log(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'four:'</span>, result.four);&nbsp;&nbsp;&nbsp;&nbsp; console.log(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'error: '</span> + error);&nbsp;&nbsp;&nbsp;&nbsp; console.log(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'result: '</span> + <span style="box-sizing: border-box; color: #660066" class="hljs-built_in">JSON</span>.stringify(result));&nbsp;&nbsp;&nbsp;&nbsp; console.timeEnd(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'parallel'</span>); &#125;);<ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li><li style="box-sizing: border-box; padding: 0px 5px">11</li><li style="box-sizing: border-box; padding: 0px 5px">12</li><li style="box-sizing: border-box; padding: 0px 5px">13</li><li style="box-sizing: border-box; padding: 0px 5px">14</li><li style="box-sizing: border-box; padding: 0px 5px">15</li><li style="box-sizing: border-box; padding: 0px 5px">16</li><li style="box-sizing: border-box; padding: 0px 5px">17</li><li style="box-sizing: border-box; padding: 0px 5px">18</li><li style="box-sizing: border-box; padding: 0px 5px">19</li><li style="box-sizing: border-box; padding: 0px 5px">20</li><li style="box-sizing: border-box; padding: 0px 5px">21</li><li style="box-sizing: border-box; padding: 0px 5px">22</li><li style="box-sizing: border-box; padding: 0px 5px">23</li><li style="box-sizing: border-box; padding: 0px 5px">24</li><li style="box-sizing: border-box; padding: 0px 5px">25</li><li style="box-sizing: border-box; padding: 0px 5px">26</li><li style="box-sizing: border-box; padding: 0px 5px">27</li><li style="box-sizing: border-box; padding: 0px 5px">28</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li><li style="box-sizing: border-box; padding: 0px 5px">11</li><li style="box-sizing: border-box; padding: 0px 5px">12</li><li style="box-sizing: border-box; padding: 0px 5px">13</li><li style="box-sizing: border-box; padding: 0px 5px">14</li><li style="box-sizing: border-box; padding: 0px 5px">15</li><li style="box-sizing: border-box; padding: 0px 5px">16</li><li style="box-sizing: border-box; padding: 0px 5px">17</li><li style="box-sizing: border-box; padding: 0px 5px">18</li><li style="box-sizing: border-box; padding: 0px 5px">19</li><li style="box-sizing: border-box; padding: 0px 5px">20</li><li style="box-sizing: border-box; padding: 0px 5px">21</li><li style="box-sizing: border-box; padding: 0px 5px">22</li><li style="box-sizing: border-box; padding: 0px 5px">23</li><li style="box-sizing: border-box; padding: 0px 5px">24</li><li style="box-sizing: border-box; padding: 0px 5px">25</li><li style="box-sizing: border-box; padding: 0px 5px">26</li><li style="box-sizing: border-box; padding: 0px 5px">27</li><li style="box-sizing: border-box; padding: 0px 5px">28</li></ul></pre><p style="margin: 0px 0px 1.1em; padding: 0px; box-sizing: border-box; color: #555555; font-family: 'microsoft yahei'; font-size: 14px; line-height: 35px">结果</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)">one: one two: tow three: three four: four error: null result: &#123;<span style="box-sizing: border-box; color: #008800" class="hljs-string">&quot;one&quot;</span>:<span style="box-sizing: border-box; color: #008800" class="hljs-string">&quot;one&quot;</span>,<span style="box-sizing: border-box; color: #008800" class="hljs-string">&quot;two&quot;</span>:<span style="box-sizing: border-box; color: #008800" class="hljs-string">&quot;tow&quot;</span>,<span style="box-sizing: border-box; color: #008800" class="hljs-string">&quot;three&quot;</span>:<span style="box-sizing: border-box; color: #008800" class="hljs-string">&quot;three&quot;</span>,<span style="box-sizing: border-box; color: #008800" class="hljs-string">&quot;four&quot;</span>:<span style="box-sizing: border-box; color: #008800" class="hljs-string">&quot;four&quot;</span>&#125; parallel: <span style="box-sizing: border-box; color: #006666" class="hljs-number">4.237</span>ms<ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li></ul></pre><p style="margin: 0px 0px 1.1em; padding: 0px; box-sizing: border-box; color: #555555; font-family: 'microsoft yahei'; font-size: 14px; line-height: 35px">并行无关联和串行无关联唯一的差异就是名称不同，但也都是见名知意，主要看执行的时间！！！</p><h3 style="margin: 0.8em 0px; padding: 0px; box-sizing: border-box; font-weight: 100; color: #555555; font-family: 'microsoft yahei'; line-height: 35px"><a style="box-sizing: border-box; color: #0c89cf" name="t4"></a>智能控制</h3><p style="margin: 0px 0px 1.1em; padding: 0px; box-sizing: border-box; color: #555555; font-family: 'microsoft yahei'; font-size: 14px; line-height: 35px">以上都是纯串行传并行，但是当一个场景里，需要使用串行也需要使用并行的时候，虽然分别写能解决，但是效率不是很高，维护性也不是很好，auto可以解决这一问题。如下场景，<a style="text-decoration: none; box-sizing: border-box; color: #0c89cf" href="https://github.com/bsspirit/async_demo/blob/master/auto.js">参见github示例</a>&nbsp;<br />需求如下：</p><ul style="box-sizing: border-box; color: #555555; font-family: 'microsoft yahei'; font-size: 14px; line-height: 35px"><li style="box-sizing: border-box"><ol style="box-sizing: border-box"><li style="box-sizing: border-box">从某处取得数据</li></ol></li><li style="box-sizing: border-box"><ol style="box-sizing: border-box"><li style="box-sizing: border-box">在硬盘上建立一个新的目录</li></ol></li><li style="box-sizing: border-box"><ol style="box-sizing: border-box"><li style="box-sizing: border-box">将数据写入到目录下某文件</li></ol></li><li style="box-sizing: border-box"><ol style="box-sizing: border-box"><li style="box-sizing: border-box">发送邮件，将文件以附件形式发送给其它人。</li></ol></li></ul><p style="margin: 0px 0px 1.1em; padding: 0px; box-sizing: border-box; color: #555555; font-family: 'microsoft yahei'; font-size: 14px; line-height: 35px">可以知道1与2可以并行执行，3需要等1和2完成，4要等3完成。&nbsp;<br />使用auto来解决</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">var</span> async = <span style="box-sizing: border-box; color: #660066" class="hljs-built_in">require</span>(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'async'</span>); console.time(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'auto'</span>); async.auto(&#123;&nbsp;&nbsp;&nbsp;&nbsp; getData: <span style="box-sizing: border-box" class="hljs-function"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">function</span><span style="box-sizing: border-box; color: #660066" class="hljs-params">(callback)</span> &#123;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; setTimeout(<span style="box-sizing: border-box" class="hljs-function"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">function</span><span style="box-sizing: border-box; color: #660066" class="hljs-params">()</span> &#123;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'1.1: got data'</span>);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; callback(<span style="box-sizing: border-box; color: #006666" class="hljs-literal">null</span>, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'mydata'</span>);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;, <span style="box-sizing: border-box; color: #006666" class="hljs-number">300</span>);&nbsp;&nbsp;&nbsp;&nbsp; &#125;,&nbsp;&nbsp;&nbsp;&nbsp; makeFolder: <span style="box-sizing: border-box" class="hljs-function"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">function</span><span style="box-sizing: border-box; color: #660066" class="hljs-params">(callback)</span> &#123;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; setTimeout(<span style="box-sizing: border-box" class="hljs-function"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">function</span><span style="box-sizing: border-box; color: #660066" class="hljs-params">()</span> &#123;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'1.1: made folder'</span>);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; callback(<span style="box-sizing: border-box; color: #006666" class="hljs-literal">null</span>, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'myfolder'</span>);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;, <span style="box-sizing: border-box; color: #006666" class="hljs-number">200</span>);&nbsp;&nbsp;&nbsp;&nbsp; &#125;,&nbsp;&nbsp;&nbsp;&nbsp; writeFile: [<span style="box-sizing: border-box; color: #008800" class="hljs-string">'getData'</span>, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'makeFolder'</span>, <span style="box-sizing: border-box" class="hljs-function"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">function</span><span style="box-sizing: border-box; color: #660066" class="hljs-params">(callback)</span> &#123;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; setTimeout(<span style="box-sizing: border-box" class="hljs-function"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">function</span><span style="box-sizing: border-box; color: #660066" class="hljs-params">()</span> &#123;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'1.1: wrote file'</span>);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; callback(<span style="box-sizing: border-box; color: #006666" class="hljs-literal">null</span>, <span style="box-sizing: border-box; color: #008800" class="hljs-string">'myfile'</span>);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;, <span style="box-sizing: border-box; color: #006666" class="hljs-number">300</span>);&nbsp;&nbsp;&nbsp;&nbsp; &#125;],&nbsp;&nbsp;&nbsp;&nbsp; emailFiles: [<span style="box-sizing: border-box; color: #008800" class="hljs-string">'writeFile'</span>, <span style="box-sizing: border-box" class="hljs-function"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">function</span><span style="box-sizing: border-box; color: #660066" class="hljs-params">(callback, results)</span> &#123;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'emailed file: '</span>, results.writeFile);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; callback(<span style="box-sizing: border-box; color: #006666" class="hljs-literal">null</span>, results.writeFile);&nbsp;&nbsp;&nbsp;&nbsp; &#125;] &#125;, <span style="box-sizing: border-box" class="hljs-function"><span style="box-sizing: border-box; color: #000088" class="hljs-keyword">function</span><span style="box-sizing: border-box; color: #660066" class="hljs-params">(err, results)</span> &#123;</span>&nbsp;&nbsp;&nbsp;&nbsp; console.log(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'err: '</span>, err);&nbsp;&nbsp;&nbsp;&nbsp; console.log(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'results: '</span>, results);&nbsp;&nbsp;&nbsp;&nbsp; console.timeEnd(<span style="box-sizing: border-box; color: #008800" class="hljs-string">'auto'</span>); &#125;);<ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li><li style="box-sizing: border-box; padding: 0px 5px">11</li><li style="box-sizing: border-box; padding: 0px 5px">12</li><li style="box-sizing: border-box; padding: 0px 5px">13</li><li style="box-sizing: border-box; padding: 0px 5px">14</li><li style="box-sizing: border-box; padding: 0px 5px">15</li><li style="box-sizing: border-box; padding: 0px 5px">16</li><li style="box-sizing: border-box; padding: 0px 5px">17</li><li style="box-sizing: border-box; padding: 0px 5px">18</li><li style="box-sizing: border-box; padding: 0px 5px">19</li><li style="box-sizing: border-box; padding: 0px 5px">20</li><li style="box-sizing: border-box; padding: 0px 5px">21</li><li style="box-sizing: border-box; padding: 0px 5px">22</li><li style="box-sizing: border-box; padding: 0px 5px">23</li><li style="box-sizing: border-box; padding: 0px 5px">24</li><li style="box-sizing: border-box; padding: 0px 5px">25</li><li style="box-sizing: border-box; padding: 0px 5px">26</li><li style="box-sizing: border-box; padding: 0px 5px">27</li><li style="box-sizing: border-box; padding: 0px 5px">28</li><li style="box-sizing: border-box; padding: 0px 5px">29</li><li style="box-sizing: border-box; padding: 0px 5px">30</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li><li style="box-sizing: border-box; padding: 0px 5px">11</li><li style="box-sizing: border-box; padding: 0px 5px">12</li><li style="box-sizing: border-box; padding: 0px 5px">13</li><li style="box-sizing: border-box; padding: 0px 5px">14</li><li style="box-sizing: border-box; padding: 0px 5px">15</li><li style="box-sizing: border-box; padding: 0px 5px">16</li><li style="box-sizing: border-box; padding: 0px 5px">17</li><li style="box-sizing: border-box; padding: 0px 5px">18</li><li style="box-sizing: border-box; padding: 0px 5px">19</li><li style="box-sizing: border-box; padding: 0px 5px">20</li><li style="box-sizing: border-box; padding: 0px 5px">21</li><li style="box-sizing: border-box; padding: 0px 5px">22</li><li style="box-sizing: border-box; padding: 0px 5px">23</li><li style="box-sizing: border-box; padding: 0px 5px">24</li><li style="box-sizing: border-box; padding: 0px 5px">25</li><li style="box-sizing: border-box; padding: 0px 5px">26</li><li style="box-sizing: border-box; padding: 0px 5px">27</li><li style="box-sizing: border-box; padding: 0px 5px">28</li><li style="box-sizing: border-box; padding: 0px 5px">29</li><li style="box-sizing: border-box; padding: 0px 5px">30</li></ul></pre><p style="margin: 0px 0px 1.1em; padding: 0px; box-sizing: border-box; color: #555555; font-family: 'microsoft yahei'; font-size: 14px; line-height: 35px">结果</p><pre class="prettyprint" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.1em; font-family: 'Source Code Pro', monospace; padding: 5px 5px 5px 60px; font-size: 14px; line-height: 1.45; word-break: break-all; color: #333333; border: 1px solid rgba(128, 128, 128, 0.0745098); border-radius: 0px; background-color: rgba(128, 128, 128, 0.0470588)"><span style="box-sizing: border-box; color: #006666" class="hljs-number">1.1</span>: made folder <span style="box-sizing: border-box; color: #006666" class="hljs-number">1.1</span>: got data <span style="box-sizing: border-box; color: #006666" class="hljs-number">1.1</span>: wrote file emailed file:&nbsp;&nbsp;myfile err:&nbsp;&nbsp;null results:&nbsp;&nbsp;&#123; makeFolder: <span style="box-sizing: border-box; color: #008800" class="hljs-string">'myfolder'</span>,&nbsp;&nbsp; getData: <span style="box-sizing: border-box; color: #008800" class="hljs-string">'mydata'</span>,&nbsp;&nbsp; writeFile: <span style="box-sizing: border-box; color: #008800" class="hljs-string">'myfile'</span>,&nbsp;&nbsp; emailFiles: <span style="box-sizing: border-box; color: #008800" class="hljs-string">'myfile'</span> &#125; auto: <span style="box-sizing: border-box; color: #006666" class="hljs-number">650.972</span>ms<ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li></ul><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: #dddddd; list-style: none; text-align: right; background-color: #eeeeee"><li style="box-sizing: border-box; padding: 0px 5px">1</li><li style="box-sizing: border-box; padding: 0px 5px">2</li><li style="box-sizing: border-box; padding: 0px 5px">3</li><li style="box-sizing: border-box; padding: 0px 5px">4</li><li style="box-sizing: border-box; padding: 0px 5px">5</li><li style="box-sizing: border-box; padding: 0px 5px">6</li><li style="box-sizing: border-box; padding: 0px 5px">7</li><li style="box-sizing: border-box; padding: 0px 5px">8</li><li style="box-sizing: border-box; padding: 0px 5px">9</li><li style="box-sizing: border-box; padding: 0px 5px">10</li></ul></pre><p style="margin: 0px 0px 1.1em; padding: 0px; box-sizing: border-box; color: #555555; font-family: 'microsoft yahei'; font-size: 14px; line-height: 35px">通过这样的写法，就可以实现串行并行组合写法，这些方法需要多多练习才能熟练使用。。。</p>
]]>
</description>
</item>
</channel>
</rss>